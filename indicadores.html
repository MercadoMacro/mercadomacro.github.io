<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-5JZRK5NNKG"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-5JZRK5NNKG');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
    <meta name="description" content="Indicadores atualizados do mercado financeiro do Brasil e EUA, incluindo CDS, SELIC, Dólar, Inflação, Fed Funds e PIB.">
    <meta name="keywords" content="indicadores financeiros, cds, selic, ipca, dolar, pib, fed funds, cpi, pce, fred api, bcb api">
    <meta name="author" content="Anderson">
    <meta property="og:title" content="Indicadores de Mercado Financeiro - Mercado Macro">
    <meta property="og:description" content="Acompanhe os principais indicadores do mercado financeiro do Brasil e dos EUA em tempo real">
    <meta property="og:image" content="https://example.com/indicators-thumbnail.jpg">
    <meta property="og:url" content="https://mercadomacro.github.io/indicadores.html">
    <meta name="theme-color" content="#0d1117">
    <title>Indicadores Financeiros - Mercado Macro</title>
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        :root { 
            --primary-color: #00d180; --primary-light: #5bffb0; --primary-dark: #009e53;
            --dark-bg: #0d1117; --darker-bg: #010409; --text-color: #c9d1d9;
            --text-secondary: rgba(139, 148, 158, 0.7); --card-bg-val: 22, 27, 34;
            --card-bg: rgba(var(--card-bg-val), 0.85); --border-color: rgba(48, 54, 61, 0.8);
            --shadow-color-soft: rgba(0, 0, 0, 0.2); --shadow-color-medium: rgba(0, 0, 0, 0.3);
            --up-trend: #3fb950; --down-trend: #f85149;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: linear-gradient(135deg, var(--darker-bg) 0%, var(--dark-bg) 100%); color: var(--text-color); min-height: 100vh; width: 100%; overflow-x: hidden; line-height: 1.7; transition: background 0.3s ease, color 0.3s ease; display: flex; flex-direction: column; }
        :focus-visible { outline: 2px solid var(--primary-color); outline-offset: 2px; }
        .container { flex: 1; max-width: 1200px; width: 100%; margin: 0 auto; padding: 30px 20px; box-sizing: border-box; text-align: center; display: flex; flex-direction: column; }
        .logo { text-align: center; margin-bottom: 20px; }
        .page-title-header { font-size: 25px; font-weight: 800; line-height: 1.2; letter-spacing: -1px; background: linear-gradient(120deg, var(--primary-light), var(--primary-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px; padding: 0 10px; }
        .logo-divider { width: 80px; height: 4px; background: linear-gradient(to right, var(--primary-color), var(--primary-light)); margin: 15px auto 0; border-radius: 3px; }
        .subheader { font-size: 16px; margin-bottom: 25px; color: var(--text-secondary); font-weight: 600; }
        main { flex: 1; display: flex; flex-direction: column; width: 100%; }
        .indicators-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; padding: 8px 0 15px; width: 100%; flex-grow: 1; }
        .indicator-card { background: var(--card-bg); border-radius: 16px; box-shadow: 0 4px 12px var(--shadow-color-soft); padding: 0; flex: 1 1 280px; max-width: calc(25% - 15px); text-align: center; transition: all 0.3s ease; border: 1px solid var(--border-color); min-height: 190px; display: flex; flex-direction: column; justify-content: center; position: relative; transform-style: preserve-3d; overflow: hidden; perspective: 1000px; }
        .indicator-card.sortable-ghost { opacity: 0.4; }
        .indicator-card.sortable-chosen { box-shadow: 0 8px 20px var(--shadow-color-medium); transform: scale(1.02); cursor: grabbing; }
        .indicator-card--with-chart { min-height: 310px; max-width: calc(33.33% - 15px); }
        .indicator-card:hover { transform: translateY(-6px) scale(1.01); box-shadow: 0 8px 20px var(--shadow-color-medium); }
        .up-trend { color: var(--up-trend); }
        .down-trend { color: var(--down-trend); }
        .indicator-front, .indicator-back { backface-visibility: hidden; -webkit-backface-visibility: hidden; position: absolute; top: 0; left: 0; right: 0; bottom: 0; padding: 12px 15px 12px 35px; display: flex; flex-direction: column; justify-content: space-around; transition: transform 0.6s; transform-style: preserve-3d; cursor: pointer; }
        .indicator-back { transform: rotateY(180deg); font-size: 13px; color: var(--text-secondary); text-align: left; padding: 15px; overflow-y: auto; cursor: default;}
        .indicator-card.flipped .indicator-front { transform: rotateY(180deg); }
        .indicator-card.flipped .indicator-back { transform: rotateY(0deg); }
        .indicator-back strong { color: var(--primary-color); display: block; margin-bottom: 6px; text-align: center; font-size: 14px; }
        .indicator-icon { font-size: 22px; color: var(--primary-color); margin-bottom: 6px; }
        .indicator-name { font-size: 13px; font-weight: 700; margin-bottom: 8px; color: var(--primary-color); text-transform: uppercase; letter-spacing: 0.5px; line-height: 1.3; }
        .indicator-value { font-size: 16px; font-weight: 700; margin: 5px 0; line-height: 1.3; }
        .indicator-description { font-size: 11px; color: var(--text-secondary); margin-bottom: 2px; line-height: 1.3; }
        .indicator-card--multi-value .indicator-front { padding-top: 10px; padding-bottom: 10px; }
        .indicator-card--multi-value .indicator-value { font-size: 15px; }
        .sparkline-chart { min-height: 80px; margin: 8px 0; }
        .drag-handle { position: absolute; left: 0; top: 0; bottom: 0; width: 30px; display: flex; align-items: center; justify-content: center; color: rgba(139, 148, 158, 0.4); cursor: grab; transition: color 0.2s ease; }
        .indicator-card:hover .drag-handle { color: rgba(139, 148, 158, 0.7); }
        .drag-handle:active { cursor: grabbing; }
        .chart-controls { display: flex; justify-content: center; gap: 8px; margin-top: 10px; }
        .chart-period-btn { background: rgba(var(--card-bg-val),0.5); border: 1px solid var(--border-color); color: var(--text-secondary); padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
        .chart-period-btn:hover { background: var(--primary-color); color: var(--dark-bg); }
        .chart-period-btn.active { background: var(--primary-dark); color: white; border-color: var(--primary-dark); }
        .accessible-chart-data { position: absolute; left: -10000px; top: auto; width: 1px; height: 1px; overflow: hidden; }
        .footer { font-size: 13px; margin-top: 40px; text-align: center; color: var(--text-secondary); padding: 20px 0; border-top: 1px solid var(--border-color); }
        .floating-btn { position: fixed; width: 50px; height: 50px; border-radius: 50%; background: rgba(var(--card-bg-val), 0.4); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); color: var(--text-color); cursor: pointer; z-index: 1000; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3); transition: all 0.3s cubic-bezier(0.19, 1, 0.22, 1); overflow: hidden; will-change: transform, background-color, box-shadow; }
        .floating-btn::before { content: ''; position: absolute; top: -20%; left: -50%; width: 200%; height: 150%; background: linear-gradient( 145deg, rgba(255, 255, 255, 0.35) 0%, rgba(255, 255, 255, 0.1) 40%, rgba(255, 255, 255, 0) 80% ); transform: rotate(20deg); transition: all 0.4s ease; pointer-events: none; }
        .floating-btn:hover { transform: translateY(-6px) scale(1.01); background: rgba(var(--card-bg-val), 0.6); box-shadow: 0 12px 25px rgba(0, 0, 0, 0.4); color: #fff; }
        .floating-btn:hover::before { transform: translate(20px, -10px) rotate(20deg) scale(1.1); opacity: 0.8; }
        .floating-btn i { font-size: 18px; transition: color 0.3s ease; }
        #back-btn { right: 20px; bottom: 20px; }
        #refresh-btn { right: 80px; bottom: 20px; }
        #fullscreen-btn { right: 140px; bottom: 20px; }
        #fullscreen-exit-btn { right: 140px, bottom: 20px; display: none; }
        .theme-toggle { left: 20px; bottom: 20px; }
        .profile-btn { position: fixed; top: 20px; right: 20px; width: 45px; height: 45px; border-radius: 50%; background: rgba(var(--card-bg-val), 0.4); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); color: var(--primary-color); cursor: pointer; z-index: 1000; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; box-shadow: 0 5px 15px var(--shadow-color-soft); }
        .profile-btn i { font-size: 18px; }
        .profile-btn:hover { background: var(--primary-color); color: var(--dark-bg); transform: translateY(-2px) scale(1.05); }
        .switch-container { display: flex; align-items: center; justify-content: center; margin-bottom: 20px; gap: 12px; font-weight: 600; font-size: 14px; color: var(--text-secondary); }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--border-color); transition: .4s; border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:focus + .slider { box-shadow: 0 0 1px var(--primary-color); }
        input:checked + .slider:before { transform: translateX(22px); }
        .switch-label { transition: color .3s ease; }
        .switch-label.active { color: var(--text-color); }

        /* --- INÍCIO: CSS para o novo Switch do Card --- */
        .card-switch-container { display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 11px; margin: 4px 0 8px; color: var(--text-secondary); font-weight: 600; }
        .card-switch-container .switch { width: 40px; height: 22px; }
        .card-switch-container .slider:before { height: 16px; width: 16px; }
        .card-switch-container input:checked + .slider:before { transform: translateX(18px); }
        .card-switch-label { transition: color .3s ease; }
        .card-switch-label.active { color: var(--text-color); }
        /* --- FIM: CSS para o novo Switch do Card --- */

        body.light-mode { --primary-color: #007bff; --primary-light: #53a6ff; --primary-dark: #0056b3; --dark-bg: #f8f9fa; --darker-bg: #e9ecef; --text-color: #212529; --text-secondary: #495057; --card-bg-val: 255, 255, 255; --card-bg: #ffffff; --border-color: #dee2e6; --shadow-color-soft: rgba(0,0,0,0.07); --shadow-color-medium: rgba(0,0,0,0.1); background: linear-gradient(135deg, var(--darker-bg) 0%, var(--dark-bg) 100%); }
        body.light-mode .page-title-header { background: linear-gradient(120deg, var(--primary-dark), var(--primary-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        body.light-mode .logo-divider { background: linear-gradient(to right, var(--primary-color), var(--primary-light));}
        body.light-mode .floating-btn { background: rgba(255, 255, 255, 0.6); border: 1px solid rgba(0, 0, 0, 0.1); color: var(--text-secondary); box-shadow: 0 8px 20px var(--shadow-color-soft); }
        body.light-mode .floating-btn::before { background: linear-gradient( 145deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.4) 40%, rgba(255, 255, 255, 0) 80% ); }
        body.light-mode .floating-btn:hover { background: rgba(255, 255, 255, 0.85); color: var(--primary-dark); }
        body.light-mode .profile-btn { background: rgba(255, 255, 255, 0.6); border: 1px solid rgba(0, 0, 0, 0.1); color: var(--primary-color); }
        body.light-mode .profile-btn:hover { background-color: var(--primary-color); color: white; }
        @media (max-width: 1200px) { 
            .indicator-card { max-width: calc(33.33% - 15px); } 
            .indicator-card--with-chart { max-width: calc(50% - 15px); }
        }
        @media (max-width: 768px) { 
            .indicator-card { max-width: calc(50% - 15px); } 
            .indicator-card--with-chart { max-width: calc(50% - 15px); }
            .page-title-header { font-size: 38px; } 
        }
        @media (max-width: 600px) { 
            .indicator-card { max-width: 100%; } 
            .indicator-card--with-chart { max-width: 100%; }
            .container { padding: 15px 12px; } 
            .page-title-header { font-size: 34px; } 
            .floating-btn, .profile-btn { width: 45px; height: 45px; } 
            #back-btn { right: 15px; } 
            #refresh-btn { right: 70px; } 
            #fullscreen-btn, #fullscreen-exit-btn { right: 125px; } 
            .theme-toggle { left: 15px; } 
            .profile-btn { top: 15px; right: 15px; } 
        }
        @supports(padding: max(0px)) { 
            .floating-btn, .theme-toggle { bottom: max(15px, env(safe-area-inset-bottom)); } 
            .profile-btn { top: max(15px, env(safe-area-inset-top)); right: max(15px, env(safe-area-inset-right)); } 
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="logo">
            <h1 class="page-title-header">Indicadores Financeiros</h1>
            <div class="switch-container">
                <span id="label-nacional" class="switch-label active">Nacionais</span>
                <label class="switch">
                    <input type="checkbox" id="view-toggle-switch">
                    <span class="slider round"></span>
                </label>
                <span id="label-internacional" class="switch-label">Internacionais</span>
            </div>
            <div class="logo-divider"></div>
        </header>

        <p class="subheader" id="data-atual">Carregando dados...</p>
        
        <main>
            <div class="indicators-container" id="national-indicators-container">
                <article class="indicator-card indicator-card--with-chart" id="card-risk" data-id="risk"> <div class="indicator-front"> <div class="drag-handle"><i class="fas fa-grip-vertical"></i></div> <div class="indicator-icon"><i class="fas fa-shield-alt"></i></div> <div class="indicator-name">Risco País (CDS 5 Anos)</div> <div class="indicator-value" id="risk-value">Carregando...</div> <div class="indicator-description">CDS (pontos-base)</div> <div class="sparkline-chart" id="risk-chart-container"></div> <div class="accessible-chart-data" id="risk-chart-data-table"></div> </div> <div class="indicator-back"><strong>O que é o CDS?</strong> O Credit Default Swap (CDS) é um contrato de seguro contra o calote da dívida de um país. A pontuação do CDS de 5 anos indica a percepção de risco dos investidores internacionais. Quanto maior o valor, maior o risco soberano percebido.</div> </article> <article class="indicator-card indicator-card--multi-value indicator-card--with-chart" id="card-dolar" data-id="dolar"> <div class="indicator-front"> <div class="drag-handle"><i class="fas fa-grip-vertical"></i></div> <div class="indicator-icon"><i class="fas fa-dollar-sign"></i></div> <div class="indicator-name">Dólar</div> <div class="indicator-value" id="dolar-buy-value">Carregando...</div> <div class="indicator-description">Compra</div> <div class="indicator-value" id="dolar-sell-value">Carregando...</div> <div class="indicator-description">Venda</div> <div class="sparkline-chart" id="dolar-chart-container"></div> <div class="chart-controls" data-indicator-id="dolarSell"> <button class="chart-period-btn" data-days="30">30D</button> <button class="chart-period-btn" data-days="90">90D</button> <button class="chart-period-btn active" data-days="365">1A</button> </div> <div class="accessible-chart-data" id="dolar-chart-data-table"></div> </div> <div class="indicator-back"><strong>O que é a PTAX?</strong> A PTAX é a taxa de câmbio de referência oficial do Brasil, calculada diariamente pelo Banco Central. Ela representa a média das taxas de negociação de Dólar no mercado interbancário.</div> </article> <article class="indicator-card indicator-card--multi-value indicator-card--with-chart" id="card-euro" data-id="euro"> <div class="indicator-front"> <div class="drag-handle"><i class="fas fa-grip-vertical"></i></div> <div class="indicator-icon"><i class="fas fa-euro-sign"></i></div> <div class="indicator-name">Euro</div> <div class="indicator-value" id="euro-buy-value">Carregando...</div> <div class="indicator-description">Compra</div> <div class="indicator-value" id="euro-sell-value">Carregando...</div> <div class="indicator-description">Venda</div> <div class="sparkline-chart" id="euro-chart-container"></div> <div class="chart-controls" data-indicator-id="euroSell"> <button class="chart-period-btn" data-days="30">30D</button> <button class="chart-period-btn" data-days="90">90D</button> <button class="chart-period-btn active" data-days="365">1A</button> </div> <div class="accessible-chart-data" id="euro-chart-data-table"></div> </div> <div class="indicator-back"><strong>Cotação do Euro</strong> A cotação do Euro contra o Real é apurada pelo Banco Central. O valor representa quantos Reais são necessários para comprar um Euro, com base nas negociações do mercado.</div> </article> <article class="indicator-card indicator-card--with-chart" id="card-cdi" data-id="cdi"> <div class="indicator-front"> <div class="drag-handle"><i class="fas fa-grip-vertical"></i></div> <div class="indicator-icon"><i class="fas fa-chart-line"></i></div> <div class="indicator-name">CDI</div> <div class="indicator-value" id="cdi-annual-value">Carregando...</div> <div class="indicator-description">Taxa Anual (a.a.)</div> <div class="sparkline-chart" id="cdi-chart-container"></div> <div class="chart-controls" data-indicator-id="cdi"> <button class="chart-period-btn" data-days="30">30D</button> <button class="chart-period-btn" data-days="90">90D</button> <button class="chart-period-btn active" data-days="365">1A</button> </div> <div class="accessible-chart-data" id="cdi-chart-data-table"></div> </div> <div class="indicator-back"><strong>O que é o CDI?</strong> É a taxa de juros dos empréstimos entre bancos. Serve de referência para a maioria dos investimentos de renda fixa. A taxa anual é uma projeção baseada na composição da taxa diária.</div> </article> <article class="indicator-card indicator-card--with-chart" id="card-selic" data-id="selic"> <div class="indicator-front"> <div class="drag-handle"><i class="fas fa-grip-vertical"></i></div> <div class="indicator-icon"><i class="fas fa-percentage"></i></div> <div class="indicator-name">Selic</div> <div class="indicator-value" id="selic-meta-value">Carregando...</div> <div class="indicator-description">Meta ao Ano</div> <div class="sparkline-chart" id="selic-chart-container"></div> <div class="chart-controls" data-indicator-id="selicMeta"> <button class="chart-period-btn" data-days="30">30D</button> <button class="chart-period-btn" data-days="90">90D</button> <button class="chart-period-btn active" data-days="365">1A</button> </div> <div class="accessible-chart-data" id="selic-chart-data-table"></div> </div> <div class="indicator-back"><strong>O que é a Selic?</strong> A Taxa Selic é a taxa básica de juros da economia brasileira, definida pelo COPOM. Ela influencia todas as outras taxas de juros do país.</div> </article> <article class="indicator-card indicator-card--multi-value indicator-card--with-chart" id="card-ipca" data-id="ipca"> <div class="indicator-front"> <div class="drag-handle"><i class="fas fa-grip-vertical"></i></div> <div class="indicator-icon"><i class="fas fa-chart-pie"></i></div> <div class="indicator-name">IPCA</div> <div class="indicator-value" id="ipca-month-value">Carregando...</div> <div class="indicator-description">Mês</div> <div class="indicator-value" id="ipca-12m-value">Carregando...</div> <div class="indicator-description">12 Meses</div> <div class="sparkline-chart" id="ipca-chart-container"></div> <div class="chart-controls" data-indicator-id="ipca"> <button class="chart-period-btn" data-months="3">3M</button> <button class="chart-period-btn" data-months="6">6M</button> <button class="chart-period-btn active" data-months="12">1A</button> </div> <div class="accessible-chart-data" id="ipca-chart-data-table"></div> </div> <div class="indicator-back"><strong>O que é o IPCA?</strong> O IPCA é o principal indicador de inflação do Brasil, medindo a variação de preços para o consumidor final. É a meta de inflação oficial.</div> </article> <article class="indicator-card indicator-card--multi-value indicator-card--with-chart" id="card-inpc" data-id="inpc"> <div class="indicator-front"> <div class="drag-handle"><i class="fas fa-grip-vertical"></i></div> <div class="indicator-icon"><i class="fas fa-wallet"></i></div> <div class="indicator-name">INPC</div> <div class="indicator-value" id="inpc-month-value">Carregando...</div> <div class="indicator-description">Mês</div> <div class="indicator-value" id="inpc-12m-value">Carregando...</div> <div class="indicator-description">12 Meses</div> <div class="sparkline-chart" id="inpc-chart-container"></div> <div class="chart-controls" data-indicator-id="inpc"> <button class="chart-period-btn" data-months="3">3M</button> <button class="chart-period-btn" data-months="6">6M</button> <button class="chart-period-btn active" data-months="12">1A</button> </div> <div class="accessible-chart-data" id="inpc-chart-data-table"></div> </div> <div class="indicator-back"><strong>O que é o INPC?</strong> O Índice Nacional de Preços ao Consumidor mede a inflação para famílias de menor renda (1 a 5 salários mínimos). É muito usado em reajustes salariais.</div> </article> <article class="indicator-card indicator-card--multi-value indicator-card--with-chart" id="card-igp-m" data-id="igpm"> <div class="indicator-front"> <div class="drag-handle"><i class="fas fa-grip-vertical"></i></div> <div class="indicator-icon"><i class="fas fa-chart-area"></i></div> <div class="indicator-name">IGP-M</div> <div class="indicator-value" id="igp-m-month-value">Carregando...</div> <div class="indicator-description">Mês</div> <div class="indicator-value" id="igp-m-12m-value">Carregando...</div> <div class="indicator-description">12 Meses</div> <div class="sparkline-chart" id="igpm-chart-container"></div> <div class="chart-controls" data-indicator-id="igpm"> <button class="chart-period-btn" data-months="3">3M</button> <button class="chart-period-btn" data-months="6">6M</button> <button class="chart-period-btn active" data-months="12">1A</button> </div> <div class="accessible-chart-data" id="igpm-chart-data-table"></div> </div> <div class="indicator-back"><strong>O que é o IGP-M?</strong> O IGP-M é um importante indicador de inflação, conhecido como a "inflação do aluguel" por ser muito usado para reajustar contratos de locação.</div> </article> <article class="indicator-card indicator-card--multi-value indicator-card--with-chart" id="card-igp-di" data-id="igpdi"> <div class="indicator-front"> <div class="drag-handle"><i class="fas fa-grip-vertical"></i></div> <div class="indicator-icon"><i class="fas fa-chart-bar"></i></div> <div class="indicator-name">IGP-DI</div> <div class="indicator-value" id="igp-di-month-value">Carregando...</div> <div class="indicator-description">Mês</div> <div class="indicator-value" id="igp-di-12m-value">Carregando...</div> <div class="indicator-description">12 Meses</div> <div class="sparkline-chart" id="igpdi-chart-container"></div> <div class="chart-controls" data-indicator-id="igpdi"> <button class="chart-period-btn" data-months="3">3M</button> <button class="chart-period-btn" data-months="6">6M</button> <button class="chart-period-btn active" data-months="12">1A</button> </div> <div class="accessible-chart-data" id="igpdi-chart-data-table"></div> </div> <div class="indicator-back"><strong>O que é o IGP-DI?</strong> O Índice Geral de Preços - Disponibilidade Interna (IGP-DI) mede a variação de preços desde matérias-primas agrícolas e industriais até bens e serviços finais.</div> </article> <article class="indicator-card indicator-card--multi-value indicator-card--with-chart" id="card-poupanca" data-id="poupanca"> <div class="indicator-front"> <div class="drag-handle"><i class="fas fa-grip-vertical"></i></div> <div class="indicator-icon"><i class="fas fa-piggy-bank"></i></div> <div class="indicator-name">Poupança</div> <div class="indicator-value" id="poupanca-month-value">Carregando...</div> <div class="indicator-description">Rendimento no Mês</div> <div class="indicator-value" id="poupanca-annualized-value">Carregando...</div> <div class="indicator-description">Rendimento Anualizado</div> <div class="sparkline-chart" id="poupanca-chart-container"></div> <div class="chart-controls" data-indicator-id="poupanca"> <button class="chart-period-btn" data-months="3">3M</button> <button class="chart-period-btn" data-months="6">6M</button> <button class="chart-period-btn active" data-months="12">1A</button> </div> <div class="accessible-chart-data" id="poupanca-chart-data-table"></div> </div> <div class="indicator-back"><strong>Como funciona a Poupança?</strong> A remuneração, isenta de Imposto de Renda para pessoas físicas, é composta pela Taxa Referencial (TR) mais um rendimento adicional. Para depósitos feitos a partir de 04/05/2012, a regra é: se a meta Selic estiver acima de 8,5% ao ano, o rendimento é de 0,5% ao mês + TR. Se estiver igual ou abaixo de 8,5%, o rendimento é de 70% da meta Selic + TR.</div> </article> <article class="indicator-card indicator-card--with-chart" id="card-desemprego" data-id="desemprego"> <div class="indicator-front"> <div class="drag-handle"><i class="fas fa-grip-vertical"></i></div> <div class="indicator-icon"><i class="fas fa-user-times"></i></div> <div class="indicator-name">Desemprego</div> <div class="indicator-value" id="desemprego-value">Carregando...</div> <div class="indicator-description">Taxa de Desocupação</div> <div class="sparkline-chart" id="desemprego-chart-container"></div> <div class="chart-controls" data-indicator-id="desemprego"> <button class="chart-period-btn" data-months="3">3M</button> <button class="chart-period-btn" data-months="6">6M</button> <button class="chart-period-btn active" data-months="12">1A</button> </div> <div class="accessible-chart-data" id="desemprego-chart-data-table"></div> </div> <div class="indicator-back"><strong>O que é a Taxa de Desemprego?</strong> Proporção de pessoas desocupadas na força de trabalho. Importante indicador da saúde do mercado de trabalho. Dado da PNAD Contínua/IBGE.</div> </article>
            </div>
            
            <div class="indicators-container" id="international-indicators-container" style="display: none;">
                <article class="indicator-card indicator-card--with-chart" data-id="cpi">
                    <div class="indicator-front">
                        <div class="drag-handle"><i class="fas fa-grip-vertical"></i></div>
                        <div class="indicator-icon"><i class="fas fa-shopping-basket"></i></div>
                        <div class="indicator-name">CPI (EUA)</div>
                        <div class="card-switch-container">
                            <span class="card-switch-label active" data-type="anual">Anual</span>
                            <label class="switch">
                                <input type="checkbox" id="cpi-toggle-switch">
                                <span class="slider round"></span>
                            </label>
                            <span class="card-switch-label" data-type="mensal">Mensal</span>
                        </div>
                        <div class="indicator-value" id="cpi-value">...</div>
                        <div class="indicator-description" id="cpi-date">...</div>
                        <div class="sparkline-chart" id="cpi-chart"></div>
                        <div class="chart-controls" data-indicator-id="cpi">
                            <button class="chart-period-btn" data-years="1">1A</button>
                            <button class="chart-period-btn active" data-years="5">5A</button>
                            <button class="chart-period-btn" data-years="max">Máx</button>
                        </div>
                    </div>
                    <div class="indicator-back"><strong>CPI (Consumer Price Index)</strong>Mede a variação de preços de uma cesta de consumo. Principal indicador de inflação ao consumidor dos EUA.<br><i>Série: CPIAUCSL</i></div>
                </article>
                <article class="indicator-card indicator-card--with-chart" data-id="core-cpi">
                    <div class="indicator-front">
                         <div class="drag-handle"><i class="fas fa-grip-vertical"></i></div>
                        <div class="indicator-icon"><i class="fas fa-filter"></i></div>
                        <div class="indicator-name">Core CPI (Núcleo)</div>
                         <div class="card-switch-container">
                            <span class="card-switch-label active" data-type="anual">Anual</span>
                            <label class="switch">
                                <input type="checkbox" id="core-cpi-toggle-switch">
                                <span class="slider round"></span>
                            </label>
                            <span class="card-switch-label" data-type="mensal">Mensal</span>
                        </div>
                        <div class="indicator-value" id="core-cpi-value">...</div>
                        <div class="indicator-description" id="core-cpi-date">...</div>
                        <div class="sparkline-chart" id="core-cpi-chart"></div>
                        <div class="chart-controls" data-indicator-id="coreCpi">
                            <button class="chart-period-btn" data-years="1">1A</button>
                            <button class="chart-period-btn active" data-years="5">5A</button>
                            <button class="chart-period-btn" data-years="max">Máx</button>
                        </div>
                    </div>
                    <div class="indicator-back"><strong>Core CPI</strong>Exclui os preços voláteis de alimentos e energia para medir a tendência da inflação.<br><i>Série: CPILFESL</i></div>
                </article>
                <article class="indicator-card indicator-card--with-chart" data-id="pce"> <div class="indicator-front"> <div class="drag-handle"><i class="fas fa-grip-vertical"></i></div> <div class="indicator-icon"><i class="fas fa-money-bill-wave"></i></div> <div class="indicator-name">PCE (EUA)</div> <div class="indicator-value" id="pce-value">...</div> <div class="indicator-description" id="pce-date">...</div> <div class="sparkline-chart" id="pce-chart"></div> <div class="chart-controls" data-indicator-id="pce"> <button class="chart-period-btn" data-years="1">1A</button> <button class="chart-period-btn active" data-years="5">5A</button> <button class="chart-period-btn" data-years="max">Máx</button> </div> </div> <div class="indicator-back"><strong>PCE (Personal Consumption Expenditures)</strong>Mede a inflação de todos os gastos de consumo. É o indicador preferido pelo Fed.<br><i>Série: PCE (Anual)</i></div> </article> <article class="indicator-card indicator-card--with-chart" data-id="core-pce"> <div class="indicator-front"> <div class="drag-handle"><i class="fas fa-grip-vertical"></i></div> <div class="indicator-icon"><i class="fas fa-gem"></i></div> <div class="indicator-name">Core PCE (Núcleo)</div> <div class="indicator-value" id="core-pce-value">...</div> <div class="indicator-description" id="core-pce-date">...</div> <div class="sparkline-chart" id="core-pce-chart"></div> <div class="chart-controls" data-indicator-id="corePce"> <button class="chart-period-btn" data-years="1">1A</button> <button class="chart-period-btn active" data-years="5">5A</button> <button class="chart-period-btn" data-years="max">Máx</button> </div> </div> <div class="indicator-back"><strong>Core PCE</strong>Exclui alimentos e energia do PCE. Usado pelo Fed para avaliar a política monetária.<br><i>Série: PCEPILFE (Anual)</i></div> </article> <article class="indicator-card indicator-card--with-chart" data-id="fedfunds"> <div class="indicator-front"> <div class="drag-handle"><i class="fas fa-grip-vertical"></i></div> <div class="indicator-icon"><i class="fas fa-landmark"></i></div> <div class="indicator-name">Fed Funds Rate</div> <div class="indicator-value" id="fedfunds-value">...</div> <div class="indicator-description" id="fedfunds-date">...</div> <div class="sparkline-chart" id="fedfunds-chart"></div> <div class="chart-controls" data-indicator-id="fedfunds"> <button class="chart-period-btn" data-years="1">1A</button> <button class="chart-period-btn active" data-years="5">5A</button> <button class="chart-period-btn" data-years="max">Máx</button> </div> </div> <div class="indicator-back"><strong>Fed Funds Rate</strong>A taxa de juros básica da economia dos EUA, definida pelo Federal Reserve (Fed).<br><i>Série: FEDFUNDS (Diária)</i></div> </article> <article class="indicator-card indicator-card--multi-value" data-id="fedtarget"> <div class="indicator-front"> <div class="drag-handle"><i class="fas fa-grip-vertical"></i></div> <div class="indicator-icon"><i class="fas fa-bullseye"></i></div> <div class="indicator-name">Fed Target Range</div> <div class="indicator-value" id="fedtarget-upper-value">...</div> <div class="indicator-description">Teto da Meta</div> <div class="indicator-value" id="fedtarget-lower-value">...</div> <div class="indicator-description">Piso da Meta</div> </div> <div class="indicator-back"><strong>Meta da Fed Funds Rate</strong>O intervalo (piso e teto) que o Fed estabelece como meta para a taxa de juros básica.<br><i>Séries: DFEDTARU, DFEDTARL</i></div> </article> <article class="indicator-card indicator-card--multi-value" data-id="treasuries"> <div class="indicator-front"> <div class="drag-handle"><i class="fas fa-grip-vertical"></i></div> <div class="indicator-icon"><i class="fas fa-file-invoice-dollar"></i></div> <div class="indicator-name">Treasury Yields</div> <div class="indicator-value" id="treasury-2y-value">...</div> <div class="indicator-description">2 Anos</div> <div class="indicator-value" id="treasury-10y-value">...</div> <div class="indicator-description">10 Anos</div> <div class="indicator-value" id="treasury-30y-value">...</div> <div class="indicator-description">30 Anos</div> </div> <div class="indicator-back"><strong>Treasury Yields</strong>Rendimento dos títulos do tesouro dos EUA. São referência para o custo do dinheiro no mundo.<br><i>Séries: DGS2, DGS10, DGS30</i></div> </article> <article class="indicator-card indicator-card--with-chart" data-id="inflation-exp"> <div class="indicator-front"> <div class="drag-handle"><i class="fas fa-grip-vertical"></i></div> <div class="indicator-icon"><i class="fas fa-eye"></i></div> <div class="indicator-name">Expectativa de Inflação</div> <div class="indicator-value" id="inflation-exp-value">...</div> <div class="indicator-description" id="inflation-exp-date">5 Anos (Breakeven)</div> <div class="sparkline-chart" id="inflation-exp-chart"></div> <div class="chart-controls" data-indicator-id="inflationExp"> <button class="chart-period-btn" data-years="1">1A</button> <button class="chart-period-btn active" data-years="5">5A</button> <button class="chart-period-btn" data-years="max">Máx</button> </div> </div> <div class="indicator-back"><strong>5-Year Breakeven Inflation</strong>Mede a expectativa de inflação do mercado para os próximos 5 anos.<br><i>Série: T5YIE (Diária)</i></div> </article> <article class="indicator-card indicator-card--with-chart" data-id="yield-curve"> <div class="indicator-front"> <div class="drag-handle"><i class="fas fa-grip-vertical"></i></div> <div class="indicator-icon"><i class="fas fa-wave-square"></i></div> <div class="indicator-name">Curva de Juros</div> <div class="indicator-value" id="yield-curve-value">...</div> <div class="indicator-description" id="yield-curve-date">Spread 10Y-2Y (p.p.)</div> <div class="sparkline-chart" id="yield-curve-chart"></div> <div class="chart-controls" data-indicator-id="yieldCurve"> <button class="chart-period-btn" data-years="1">1A</button> <button class="chart-period-btn active" data-years="5">5A</button> <button class="chart-period-btn" data-years="max">Máx</button> </div> </div> <div class="indicator-back"><strong>Yield Curve (10Y-2Y)</strong>Diferença (spread) entre os rendimentos dos títulos de 10 e 2 anos. Uma inversão (valor negativo) é um forte indicador de recessão.<br><i>Série: T10Y2Y</i></div> </article> <article class="indicator-card indicator-card--with-chart" data-id="gdp-real"> <div class="indicator-front"> <div class="drag-handle"><i class="fas fa-grip-vertical"></i></div> <div class="indicator-icon"><i class="fas fa-chart-line"></i></div> <div class="indicator-name">PIB Real (EUA)</div> <div class="indicator-value" id="gdp-real-value">...</div> <div class="indicator-description" id="gdp-real-date">Variação Anual</div> <div class="sparkline-chart" id="gdp-real-chart"></div> <div class="chart-controls" data-indicator-id="gdpReal"> <button class="chart-period-btn" data-years="1">1A</button> <button class="chart-period-btn active" data-years="5">5A</button> <button class="chart-period-btn" data-years="max">Máx</button> </div> </div> <div class="indicator-back"><strong>PIB Real (Real GDP)</strong>Mede o valor de todos os bens e serviços produzidos, ajustado pela inflação. Principal medida de crescimento econômico.<br><i>Série: GDPC1 (Trimestral)</i></div> </article> <article class="indicator-card indicator-card--with-chart" data-id="gdp-nominal"> <div class="indicator-front"> <div class="drag-handle"><i class="fas fa-grip-vertical"></i></div> <div class="indicator-icon"><i class="fas fa-dollar-sign"></i></div> <div class="indicator-name">PIB Nominal (EUA)</div> <div class="indicator-value" id="gdp-nominal-value">...</div> <div class="indicator-description" id="gdp-nominal-date">Total em Dólares</div> <div class="sparkline-chart" id="gdp-nominal-chart"></div> <div class="chart-controls" data-indicator-id="gdpNominal"> <button class="chart-period-btn" data-years="1">1A</button> <button class="chart-period-btn active" data-years="5">5A</button> <button class="chart-period-btn" data-years="max">Máx</button> </div> </div> <div class="indicator-back"><strong>PIB Nominal (Nominal GDP)</strong>Mede o valor de todos os bens e serviços produzidos a preços correntes, sem ajustar pela inflação.<br><i>Série: GDP (Trimestral)</i></div> </article> <article class="indicator-card indicator-card--with-chart" data-id="unemployment"> <div class="indicator-front"> <div class="drag-handle"><i class="fas fa-grip-vertical"></i></div> <div class="indicator-icon"><i class="fas fa-user-slash"></i></div> <div class="indicator-name">Taxa de Desemprego</div> <div class="indicator-value" id="unemployment-value">...</div> <div class="indicator-description" id="unemployment-date">...</div> <div class="sparkline-chart" id="unemployment-chart"></div> <div class="chart-controls" data-indicator-id="unemployment"> <button class="chart-period-btn" data-years="1">1A</button> <button class="chart-period-btn active" data-years="5">5A</button> <button class="chart-period-btn" data-years="max">Máx</button> </div> </div> <div class="indicator-back"><strong>Taxa de Desemprego (EUA)</strong>Percentual da força de trabalho que está desempregada e procurando por emprego.<br><i>Série: UNRATE (Mensal)</i></div> </article> <article class="indicator-card indicator-card--with-chart" data-id="payrolls"> <div class="indicator-front"> <div class="drag-handle"><i class="fas fa-grip-vertical"></i></div> <div class="indicator-icon"><i class="fas fa-users"></i></div> <div class="indicator-name">Nonfarm Payrolls</div> <div class="indicator-value" id="payrolls-value">...</div> <div class="indicator-description" id="payrolls-date">Criação de Vagas</div> <div class="sparkline-chart" id="payrolls-chart"></div> <div class="chart-controls" data-indicator-id="payrolls"> <button class="chart-period-btn" data-years="1">1A</button> <button class="chart-period-btn active" data-years="5">5A</button> <button class="chart-period-btn" data-years="max">Máx</button> </div> </div> <div class="indicator-back"><strong>Payrolls (Total Nonfarm)</strong>Mede a criação (ou destruição) de postos de trabalho não-agrícolas. É um dos indicadores mais importantes do mercado de trabalho.<br><i>Série: PAYEMS (Mensal)</i></div> </article> <article class="indicator-card indicator-card--with-chart" data-id="indpro"> <div class="indicator-front"> <div class="drag-handle"><i class="fas fa-grip-vertical"></i></div> <div class="indicator-icon"><i class="fas fa-industry"></i></div> <div class="indicator-name">Produção Industrial</div> <div class="indicator-value" id="indpro-value">...</div> <div class="indicator-description" id="indpro-date">Variação Anual</div> <div class="sparkline-chart" id="indpro-chart"></div> <div class="chart-controls" data-indicator-id="indpro"> <button class="chart-period-btn" data-years="1">1A</button> <button class="chart-period-btn active" data-years="5">5A</button> <button class="chart-period-btn" data-years="max">Máx</button> </div> </div> <div class="indicator-back"><strong>Produção Industrial</strong>Mede a produção das fábricas, minas e serviços de utilidade pública. Um indicador da saúde do setor industrial.<br><i>Série: INDPRO (Mensal)</i></div> </article> <article class="indicator-card indicator-card--with-chart" data-id="sentiment"> <div class="indicator-front"> <div class="drag-handle"><i class="fas fa-grip-vertical"></i></div> <div class="indicator-icon"><i class="fas fa-smile-beam"></i></div> <div class="indicator-name">Confiança do Consumidor</div> <div class="indicator-value" id="sentiment-value">...</div> <div class="indicator-description" id="sentiment-date">Índice (U. Michigan)</div> <div class="sparkline-chart" id="sentiment-chart"></div> <div class="chart-controls" data-indicator-id="sentiment"> <button class="chart-period-btn" data-years="1">1A</button> <button class="chart-period-btn active" data-years="5">5A</button> <button class="chart-period-btn" data-years="max">Máx</button> </div> </div> <div class="indicator-back"><strong>U. of Michigan: Consumer Sentiment</strong>Mede o nível de confiança dos consumidores na economia. Um indicador antecedente dos gastos de consumo.<br><i>Série: UMCSENT (Mensal)</i></div> </article>
            </div>
        </main>
        
        <footer class="footer" id="footer">Fonte: API do Banco Central do Brasil • © 2025 Mercado Macro</footer>
    </div>

    <a href="api.html" class="profile-btn floating-btn" aria-label="Análise de Perfil do Investidor"> <i class="fas fa-user-tie"></i></a>
    <button id="back-btn" class="floating-btn" aria-label="Voltar para página inicial"> <i class="fas fa-home"></i></button>
    <button id="refresh-btn" class="floating-btn" aria-label="Atualizar dados"> <i class="fas fa-redo"></i></button>
    <button id="fullscreen-btn" class="floating-btn" aria-label="Modo tela cheia"> <i class="fas fa-expand"></i></button>
    <button id="fullscreen-exit-btn" class="floating-btn" aria-label="Sair do modo tela cheia" style="display:none;"> <i class="fas fa-compress"></i></button>
    <button class="theme-toggle floating-btn" id="theme-toggle" aria-label="Alternar tema claro/escuro"> <i class="fas fa-moon"></i></button>

    <script>
        // --- 0. CACHE SERVICE ---
        const cacheService = {
            CACHE_TTL: 15 * 60 * 1000, 
            get(key) {
                const itemStr = localStorage.getItem(key);
                if (!itemStr) return null;
                try {
                    const item = JSON.parse(itemStr);
                    const isExpired = (Date.now() - item.timestamp) > this.CACHE_TTL;
                    return isExpired ? null : item.data;
                } catch (e) {
                    console.error("Erro ao ler cache:", e);
                    localStorage.removeItem(key);
                    return null;
                }
            },
            set(key, data) {
                const item = { data: data, timestamp: Date.now() };
                try {
                    localStorage.setItem(key, JSON.stringify(item));
                } catch (e) {
                    console.error("Erro ao salvar no cache:", e);
                }
            }
        };

        // --- 1. CONFIGURATION ---
        const config = {
            apiBaseUrl: 'https://api.bcb.gov.br/dados/serie/bcdata.sgs.',
            cdsApiUrl: 'https://corsproxy.io/?' + encodeURIComponent('https://br.investing.com/rates-bonds/brazil-cds-5-years-usd'),
            fredApiBaseUrl: 'https://api.stlouisfed.org/fred/series/observations',
            fredApiKey: 'fa2a8abda0c82b9b6bf1d4667e8a3a42', 
            errorText: 'Erro',
            loadingText: 'Carregando...',
            selectors: {
                updateTime: '#data-atual', footer: '#footer', riskValue: '#risk-value', dolarBuy: '#dolar-buy-value',
                dolarSell: '#dolar-sell-value', euroBuy: '#euro-buy-value', euroSell: '#euro-sell-value',
                cdiAnnual: '#cdi-annual-value', selicMeta: '#selic-meta-value', ipcaMonth: '#ipca-month-value',
                ipca12m: '#ipca-12m-value', inpcMonth: '#inpc-month-value', inpc12m: '#inpc-12m-value',
                igpmMonth: '#igp-m-month-value', igpm12m: '#igp-m-12m-value', igpdiMonth: '#igp-di-month-value',
                igpdi12m: '#igp-di-12m-value', poupancaMonth: '#poupanca-month-value', poupancaAnnualized: '#poupanca-annualized-value',
                desemprego: '#desemprego-value',
            },
            apiCodes: {
                dolarBuy: 1, dolarSell: 10813, euroBuy: 21619, euroSell: 21620, cdi: 12, selicMeta: 432, 
                ipca: 433, inpc: 188, igpm: 189, igpdi: 190, poupanca: 195, desemprego: 24369
            },
            fredApiCodes: {
                cpi: 'CPIAUCSL', coreCpi: 'CPILFESL', pce: 'PCE', corePce: 'PCEPILFE',
                fedfunds: 'FEDFUNDS', fedTargetUpper: 'DFEDTARU', fedTargetLower: 'DFEDTARL',
                treasury2Y: 'DGS2', treasury10Y: 'DGS10', treasury30Y: 'DGS30',
                inflationExp: 'T5YIE', yieldCurve: 'T10Y2Y',
                gdpReal: 'GDPC1', gdpNominal: 'GDP',
                unemployment: 'UNRATE', payrolls: 'PAYEMS',
                indpro: 'INDPRO', sentiment: 'UMCSENT'
            },
            fredIndicatorsConfig: {
                 // --- ALTERAÇÃO --- 
                // Para CPI e CoreCPI, vamos buscar os dados brutos ('lin') para calcular as variações (anual e mensal) no código.
                // Adicionamos 'hasToggle: true' para identificar esses cards especiais.
                cpi: { name: 'CPI', unit: '%', unitPos: 'after', chartUnit: '%', dateFormat: 'mm/yyyy', apiParams: { units: 'lin', frequency: 'm' }, descriptionText: '', hasToggle: true },
                coreCpi: { name: 'Core CPI', unit: '%', unitPos: 'after', chartUnit: '%', dateFormat: 'mm/yyyy', apiParams: { units: 'lin', frequency: 'm' }, descriptionText: '', hasToggle: true },
                
                // Configuração dos outros indicadores permanece a mesma
                pce: { name: 'PCE (Variação Anual)', unit: '%', unitPos: 'after', chartUnit: '%', dateFormat: 'mm/yyyy', apiParams: { units: 'pc1', frequency: 'm' }, descriptionText: 'Variação Anual' },
                corePce: { name: 'Core PCE (Variação Anual)', unit: '%', unitPos: 'after', chartUnit: '%', dateFormat: 'mm/yyyy', apiParams: { units: 'pc1', frequency: 'm' }, descriptionText: 'Variação Anual' },
                fedfunds: { name: 'Fed Funds Rate', unit: '%', unitPos: 'after', chartUnit: '%', dateFormat: 'dd/mm', apiParams: { units: 'lin' }, descriptionText: '' },
                inflationExp: { name: 'Expectativa Inflação 5A', unit: '%', unitPos: 'after', chartUnit: '%', dateFormat: 'dd/mm', apiParams: { units: 'lin' }, descriptionText: '5 Anos (Breakeven)' },
                yieldCurve: { name: 'Curva de Juros 10A-2A', unit: 'p.p.', unitPos: 'after', chartUnit: 'p.p.', dateFormat: 'dd/mm', apiParams: { units: 'lin' }, descriptionText: 'Spread 10Y-2Y (p.p.)' },
                gdpReal: { name: 'PIB Real (Variação Anual)', unit: '%', unitPos: 'after', chartUnit: '%', dateFormat: 'mm/yyyy', apiParams: { units: 'pc1', frequency: 'a' }, descriptionText: 'Variação Anual' },
                gdpNominal: { name: 'PIB Nominal (Trimestral)', unit: ' trilhões USD', unitPos: 'after', chartUnit: '$', dateFormat: 'mm/yyyy', apiParams: { units: 'lin', frequency: 'q' }, specialProcessing: (val) => (parseFloat(val) / 1000).toFixed(2), descriptionText: 'Total em Dólares' },
                unemployment: { name: 'Desemprego (EUA)', unit: '%', unitPos: 'after', chartUnit: '%', dateFormat: 'mm/yyyy', apiParams: { units: 'lin' }, descriptionText: '' },
                payrolls: { name: 'Nonfarm Payrolls', unit: 'K', unitPos: 'after', chartUnit: 'K', dateFormat: 'mm/yyyy', apiParams: { units: 'chg', frequency: 'm' }, specialProcessing: (val) => parseFloat(val).toFixed(0), descriptionText: 'Criação de Vagas' },
                indpro: { name: 'Produção Industrial', unit: '%', unitPos: 'after', chartUnit: '%', dateFormat: 'mm/yyyy', apiParams: { units: 'pc1', frequency: 'm' }, descriptionText: 'Variação Anual' },
                sentiment: { name: 'Confiança do Consumidor', unit: '', unitPos: 'after', chartUnit: '', dateFormat: 'mm/yyyy', apiParams: {}, descriptionText: 'Índice (U. Michigan)' }
            }
        };

        // --- 2. API SERVICE ---
        const apiService = {
            async getBCBData(seriesId, days = 1) {
                const url = `${config.apiBaseUrl}${seriesId}/dados/ultimos/${days}?formato=json`;
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`BCB API Error for series ${seriesId}: ${response.statusText}`);
                    return await response.json();
                } catch (error) {
                    console.error(error.message);
                    throw error;
                }
            },
            async getBCBDataByDateRange(seriesId, days) {
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(endDate.getDate() - days);
                const formatDate = (date) => `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}/${date.getFullYear()}`;
                const url = `https://api.bcb.gov.br/dados/serie/bcdata.sgs.${seriesId}/dados?formato=json&dataInicial=${formatDate(startDate)}&dataFinal=${formatDate(endDate)}`;
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`BCB API Error for series ${seriesId}: ${response.statusText}`);
                    return await response.json();
                } catch (error) {
                    console.error(error.message);
                    throw error;
                }
            },
            async getCDSData() {
                try {
                    const response = await fetch(config.cdsApiUrl);
                    if (!response.ok) throw new Error(`CDS API Error: ${response.statusText}`);
                    const htmlContent = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(htmlContent, 'text/html');
                    const cdsValueElement = doc.querySelector('[data-test="instrument-price-last"]');
                    if (!cdsValueElement) throw new Error('Elemento do valor do CDS não encontrado.');
                    return parseFloat(cdsValueElement.textContent.replace(',', '.')).toFixed(2);
                } catch (error) {
                    console.error("Erro ao buscar CDS:", error.message);
                    throw error;
                }
            },
            async getFREDData(seriesId, options = {}, limit = 1000, sort_order = 'desc') {
                const { units = 'lin', frequency = null, aggregation_method = 'avg' } = options;
                let fredUrl = `${config.fredApiBaseUrl}?series_id=${seriesId}&api_key=${config.fredApiKey}&file_type=json&limit=${limit}&sort_order=${sort_order}`;
                
                if (units) fredUrl += `&units=${units}`;
                if (frequency) fredUrl += `&frequency=${frequency}`;
                if (aggregation_method) fredUrl += `&aggregation_method=${aggregation_method}`;

                const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(fredUrl);
                try {
                    const response = await fetch(proxyUrl);
                    if (!response.ok) throw new Error(`FRED API Error for series ${seriesId} via proxy: ${response.status}`);
                    const data = await response.json();
                    if (data.error_message) throw new Error(`FRED API Error for series ${seriesId}: ${data.error_message}`);
                    
                    return data.observations
                        .filter(obs => obs.value !== '.')
                        .map(obs => {
                            const parts = obs.date.split('-');
                            const date = new Date(parts[0], parts[1] - 1, parts[2]);
                            return { date: date, valor: parseFloat(obs.value) };
                        }).reverse();
                } catch (error) {
                    console.error(`Failed to fetch ${seriesId}:`, error);
                    throw error;
                }
            }
        };

        // --- 3. UI CONTROLLER ---
        const uiController = {
            updateText(selector, text, options = {}) {
                const { unit = '', unitPosition = 'before', isDate = false, data = 'N/D' } = options;
                const element = document.querySelector(selector);
                if (element) {
                    if (text === config.errorText) {
                        element.textContent = config.errorText;
                        return;
                    }
                    if (isDate) {
                        element.textContent = data;
                        return;
                    }
                    const value = text ?? config.errorText;
                    const formattedText = String(value).replace('.', ',');
                    
                    if(unitPosition === 'after') {
                        element.textContent = `${formattedText}${unit}`;
                    } else {
                        element.textContent = `${unit}${formattedText}`;
                    }
                }
            },
            updateDateTime(source = 'BCB, Investing.com') {
                const now = new Date();
                const options = { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' };
                this.updateText(config.selectors.updateTime, `Atualizado em ${now.toLocaleDateString('pt-BR', options)}`);
                document.querySelector(config.selectors.footer).textContent = `Fontes: ${source} • © ${now.getFullYear()} Mercado Macro`;
            },
            setLoadingState(isLoading, containerSelector) {
                if (isLoading) {
                    this.updateText(config.selectors.updateTime, 'Atualizando dados...');
                    const container = document.querySelector(containerSelector);
                    if(container) {
                        container.querySelectorAll('.indicator-value').forEach(el => el.textContent = config.loadingText);
                        container.querySelectorAll('.indicator-description').forEach(el => el.textContent = '...');
                    }
                }
            },
            createSparklineChart(selector, seriesData, name = 'Valor', tooltipUnit = '%', dateFormat = 'mm/yyyy') {
                const container = document.querySelector(selector);
                if(container) container.innerHTML = ''; 

                if (!seriesData || seriesData.length === 0) {
                    if(container) container.textContent = "Dados insuficientes para gerar gráfico.";
                    return null;
                }
                
                const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim();
                const options = {
                    chart: { type: 'area', height: 80, sparkline: { enabled: true }, animations: { enabled: true, speed: 800 }},
                    stroke: { curve: 'smooth', width: 2 },
                    fill: { opacity: 0.3 },
                    colors: [primaryColor],
                    series: [{ name: name, data: seriesData.map(item => ({ x: item.date.getTime(), y: item.valor })) }],
                    tooltip: {
                        theme: document.body.classList.contains('light-mode') ? 'light' : 'dark',
                        style: { fontSize: '12px', fontFamily: 'Montserrat' },
                        x: {
                            formatter: (val, opts) => {
                                if (!seriesData[opts.dataPointIndex]) return '';
                                const date = seriesData[opts.dataPointIndex].date;
                                const day = String(date.getDate()).padStart(2, '0');
                                const month = String(date.getMonth() + 1).padStart(2, '0');
                                const year = date.getFullYear();

                                if (dateFormat === 'yyyy') return year;
                                if (dateFormat === 'dd/mm') return `${day}/${month}`;
                                return `${month}/${year}`;
                            }
                        },
                        y: {
                            formatter: (value) => {
                               const formattedValue = value ? value.toFixed(2).replace('.', ',') : '0,00';
                               const unitSymbol = (tooltipUnit === '$' || tooltipUnit === 'R$') ? tooltipUnit : '';
                               const unitText = (tooltipUnit === '$' || tooltipUnit === 'R$') ? '' : tooltipUnit;
                               return `${unitSymbol}${formattedValue}${unitText}`;
                            },
                            title: { formatter: (seriesName) => seriesName || '' }
                        },
                        marker: { show: false }
                    }
                };
                
                if(container){
                    const chart = new ApexCharts(container, options);
                    chart.render();
                    return chart;
                }
                return null;
            }
        };
        
        // --- 4. MAIN APPLICATION ---
        const app = {
            nationalData: {},
            internationalData: {
                series: {}, 
                charts: {}  
            },
            isInternationalView: false,

            // --- FUNÇÕES NACIONAIS (sem alterações) ---
            async fetchAllNationalIndicators() {
                const cachedData = cacheService.get('allNationalIndicators');
                if (cachedData) {
                    this.processNationalResults(cachedData);
                    uiController.updateText(config.selectors.updateTime, 'Exibindo dados do cache...');
                } else {
                    uiController.setLoadingState(true, '#national-indicators-container');
                }
                
                const { apiCodes } = config;
                const promises = {
                    cds: apiService.getCDSData(),
                    dolarBuy: apiService.getBCBData(apiCodes.dolarBuy, 1),
                    dolarSell: apiService.getBCBDataByDateRange(apiCodes.dolarSell, 365),
                    euroBuy: apiService.getBCBData(apiCodes.euroBuy, 1),
                    euroSell: apiService.getBCBDataByDateRange(apiCodes.euroSell, 365),
                    cdi: apiService.getBCBDataByDateRange(apiCodes.cdi, 365),
                    selicMeta: apiService.getBCBDataByDateRange(apiCodes.selicMeta, 365),
                    ipca: apiService.getBCBData(apiCodes.ipca, 12),
                    inpc: apiService.getBCBData(apiCodes.inpc, 12),
                    igpm: apiService.getBCBData(apiCodes.igpm, 12),
                    igpdi: apiService.getBCBData(apiCodes.igpdi, 12),
                    poupanca: apiService.getBCBData(apiCodes.poupanca, 12),
                    desemprego: apiService.getBCBData(apiCodes.desemprego, 12)
                };

                const results = await Promise.allSettled(Object.values(promises));
                const data = Object.keys(promises).reduce((acc, key, index) => {
                    acc[key] = results[index];
                    return acc;
                }, {});
                
                this.nationalData = data; 
                this.processNationalResults(data);
                cacheService.set('allNationalIndicators', data);
                if (!this.isInternationalView) {
                    uiController.updateDateTime();
                }
            },
             processNationalResults(data) {
                const { selectors, errorText } = config;
                this.nationalData = data;
                
                uiController.updateText(selectors.riskValue, data.cds.status === 'fulfilled' ? data.cds.value : errorText);
                this.processCDSChart();
                
                uiController.updateText(selectors.dolarBuy, data.dolarBuy.status === 'fulfilled' ? parseFloat(data.dolarBuy.value?.[0]?.valor).toFixed(2) : errorText, {unit:'R$ '});
                uiController.updateText(selectors.dolarSell, data.dolarSell.status === 'fulfilled' && data.dolarSell.value.length > 0 ? parseFloat(data.dolarSell.value?.[data.dolarSell.value.length - 1]?.valor).toFixed(2) : errorText, {unit:'R$ '});
                uiController.updateText(selectors.euroBuy, data.euroBuy.status === 'fulfilled' ? parseFloat(data.euroBuy.value?.[0]?.valor).toFixed(2) : errorText, {unit:'R$ '});
                uiController.updateText(selectors.euroSell, data.euroSell.status === 'fulfilled' && data.euroSell.value.length > 0 ? parseFloat(data.euroSell.value?.[data.euroSell.value.length - 1]?.valor).toFixed(2) : errorText, {unit:'R$ '});
                
                this.processCurrency(data.dolarSell, '#dolar-chart-container', 'Dólar Venda');
                this.processCurrency(data.euroSell, '#euro-chart-container', 'Euro Venda');
                this.processCDI(data.cdi);
                this.processSelic(data.selicMeta);
                this.processInflationIndex(data.ipca, selectors.ipcaMonth, selectors.ipca12m, '#ipca-chart-container', 'IPCA Mensal');
                this.processInflationIndex(data.inpc, selectors.inpcMonth, selectors.inpc12m, '#inpc-chart-container', 'INPC Mensal');
                this.processInflationIndex(data.igpm, selectors.igpmMonth, selectors.igpm12m, '#igpm-chart-container', 'IGP-M Mensal');
                this.processInflationIndex(data.igpdi, selectors.igpdiMonth, selectors.igpdi12m, '#igpdi-chart-container', 'IGP-DI Mensal');
                this.processPoupanca(data.poupanca);
                this.processUnemployment(data.desemprego);
            },
             processCDSChart() {
                const cdsHistoryData = [
                    { date: new Date('2017-01-01'), valor: 160.50 }, { date: new Date('2018-01-01'), valor: 207.70 },
                    { date: new Date('2019-01-01'), valor: 99.10 },  { date: new Date('2020-01-01'), valor: 142.30 },
                    { date: new Date('2021-01-01'), valor: 203.10 }, { date: new Date('2022-01-01'), valor: 250.26 },
                    { date: new Date('2023-01-01'), valor: 132.49 }, { date: new Date('2024-01-01'), valor: 205.02 },
                    { date: new Date('2025-01-01'), valor: 156.55 }
                ];
                uiController.createSparklineChart('#risk-chart-container', cdsHistoryData, 'CDS Anual', ' pts', 'yyyy');
            },
            processInflationIndex(promiseResult, monthElem, yearElem, chartSelector, chartName) {
                if (promiseResult.status === 'fulfilled' && promiseResult.value?.length > 0) {
                    const data = promiseResult.value.map(item => ({...item, date: new Date(item.data.split('/').reverse().join('-'))}));
                    uiController.updateText(monthElem, `${parseFloat(data[data.length - 1].valor).toFixed(2)}%`);
                    const yearValue = data.slice(-12).reduce((acc, item) => acc * (1 + parseFloat(item.valor) / 100), 1);
                    uiController.updateText(yearElem, `${((yearValue - 1) * 100).toFixed(2)}%`);
                    uiController.createSparklineChart(chartSelector, data, chartName, '%', 'mm/yyyy');
                } else {
                    uiController.updateText(monthElem, config.errorText);
                    uiController.updateText(yearElem, config.errorText);
                }
            },
            processUnemployment(promiseResult) {
                if (promiseResult.status === 'fulfilled' && promiseResult.value?.length > 0) {
                    const data = promiseResult.value.map(item => ({...item, date: new Date(item.data.split('/').reverse().join('-'))}));
                    const lastValue = parseFloat(data[data.length - 1].valor).toFixed(2);
                    uiController.updateText(config.selectors.desemprego, `${lastValue}%`);
                    uiController.createSparklineChart('#desemprego-chart-container', data, 'Taxa de Desocupação', '%', 'mm/yyyy');
                } else {
                    uiController.updateText(config.selectors.desemprego, config.errorText);
                }
            },
            processCurrency(promiseResult, chartSelector, chartName) {
                if (promiseResult.status === 'fulfilled' && promiseResult.value?.length > 0) {
                    const data = promiseResult.value.map(item => ({...item, date: new Date(item.data.split('/').reverse().join('-'))}));
                    uiController.createSparklineChart(chartSelector, data, chartName, 'R$', 'dd/mm');
                }
            },
            processCDI(promiseResult) {
                if (promiseResult.status === 'fulfilled' && promiseResult.value?.length > 0) {
                    const data = promiseResult.value;
                    const lastDailyRate = parseFloat(data[data.length - 1].valor);
                    const lastAnnualRate = (Math.pow(1 + (lastDailyRate / 100), 252) - 1) * 100;
                    uiController.updateText(config.selectors.cdiAnnual, `${lastAnnualRate.toFixed(2)}% a.a.`);
                    const annualizedHistory = data.map(item => ({
                        date: new Date(item.data.split('/').reverse().join('-')),
                        valor: ((Math.pow(1 + (parseFloat(item.valor) / 100), 252) - 1) * 100)
                    }));
                    uiController.createSparklineChart('#cdi-chart-container', annualizedHistory, 'CDI Anualizado', '%', 'dd/mm');
                } else {
                    uiController.updateText(config.selectors.cdiAnnual, config.errorText);
                }
            },
            processSelic(promiseResult) {
                if (promiseResult.status === 'fulfilled' && promiseResult.value?.length > 0) {
                    const data = promiseResult.value.map(item => ({...item, date: new Date(item.data.split('/').reverse().join('-'))}));
                    uiController.updateText(config.selectors.selicMeta, `${parseFloat(data[data.length - 1].valor).toFixed(2)}% a.a.`);
                    uiController.createSparklineChart('#selic-chart-container', data, 'Meta Selic', '%', 'dd/mm');
                } else {
                    uiController.updateText(config.selectors.selicMeta, config.errorText);
                }
            },
            processPoupanca(promiseResult) {
                 if (promiseResult.status === 'fulfilled' && promiseResult.value?.length > 0) {
                    const data = promiseResult.value.map(item => ({...item, date: new Date(item.data.split('/').reverse().join('-'))}));
                    const lastMonthRate = parseFloat(data[data.length - 1].valor);
                    uiController.updateText(config.selectors.poupancaMonth, `${lastMonthRate.toFixed(2)}%`);
                    const annualizedRate = (Math.pow(1 + (lastMonthRate / 100), 12) - 1) * 100;
                    uiController.updateText(config.selectors.poupancaAnnualized, `${annualizedRate.toFixed(2)}%`);
                    uiController.createSparklineChart('#poupanca-chart-container', data, 'Poupança Mensal', '%', 'mm/yyyy');
                } else {
                    uiController.updateText(config.selectors.poupancaMonth, config.errorText);
                    uiController.updateText(config.selectors.poupancaAnnualized, config.errorText);
                }
            },
            updateNationalChartForPeriod(indicatorId, period) {
                const rawData = this.nationalData[indicatorId]?.value;
                if (!rawData) return;

                const fullHistory = rawData.map(item => ({...item, date: new Date(item.data.split('/').reverse().join('-'))}))

                const filteredData = fullHistory.slice(-period);
                const chartSelector = `#${indicatorId.replace('Meta','').replace('Sell','')}-chart-container`;
                let chartName, unit, dateFormat;

                switch(indicatorId) {
                    case 'dolarSell': chartName = 'Dólar Venda'; unit = 'R$'; dateFormat = 'dd/mm'; uiController.createSparklineChart(chartSelector, filteredData, chartName, unit, dateFormat); break;
                    case 'euroSell': chartName = 'Euro Venda'; unit = 'R$'; dateFormat = 'dd/mm'; uiController.createSparklineChart(chartSelector, filteredData, chartName, unit, dateFormat); break;
                    case 'cdi': 
                        const annualizedHistory = filteredData.map(item => ({
                            date: item.date,
                            valor: ((Math.pow(1 + (parseFloat(item.valor) / 100), 252) - 1) * 100)
                        }));
                        uiController.createSparklineChart(chartSelector, annualizedHistory, 'CDI Anualizado', '%', 'dd/mm');
                        return;
                    case 'selicMeta': chartName = 'Meta Selic'; unit = '%'; dateFormat = 'dd/mm'; uiController.createSparklineChart(chartSelector, filteredData, chartName, unit, dateFormat); break;
                    case 'ipca': case 'inpc': case 'igpm': case 'igpdi': case 'poupanca': case 'desemprego':
                        const names = {ipca: 'IPCA Mensal', inpc: 'INPC Mensal', igpm: 'IGP-M Mensal', igpdi: 'IGP-DI Mensal', poupanca: 'Poupança Mensal', desemprego: 'Taxa de Desocupação'};
                        uiController.createSparklineChart(chartSelector, filteredData, names[indicatorId], '%', 'mm/yyyy'); break;
                }
            },
            
            // --- FUNÇÕES INTERNACIONAIS (Com Alterações) ---
            
            // --- NOVA FUNÇÃO ---
            // Calcula as variações anuais e mensais a partir de uma série de dados brutos (índice).
            calculateVariations(rawData) {
                const dataYoY = []; // Year-over-Year (Anual)
                const dataMoM = []; // Month-over-Month (Mensal)

                for (let i = 0; i < rawData.length; i++) {
                    const current = rawData[i];
                    
                    // Cálculo da variação Mensal (MoM)
                    if (i > 0) {
                        const previous = rawData[i-1];
                        const momValue = ((current.valor / previous.valor) - 1) * 100;
                        dataMoM.push({ date: current.date, valor: momValue });
                    }

                    // Cálculo da variação Anual (YoY)
                    if (i >= 12) {
                        const previousYear = rawData[i-12];
                        const yoyValue = ((current.valor / previousYear.valor) - 1) * 100;
                        dataYoY.push({ date: current.date, valor: yoyValue });
                    }
                }
                return { yoy: dataYoY, mom: dataMoM };
            },

            async fetchAllInternationalIndicators() {
                const cacheKey = 'allInternationalIndicators_v5'; // Versão do cache atualizada
                const cachedData = cacheService.get(cacheKey);
                if (cachedData) {
                    this.internationalData.series = Object.entries(cachedData).reduce((acc, [key, value]) => {
                        if(value?.raw) { // Se for um objeto com raw, yoy, mom
                             acc[key] = {
                                raw: value.raw.map(item => ({...item, date: new Date(item.date)})),
                                yoy: value.yoy.map(item => ({...item, date: new Date(item.date)})),
                                mom: value.mom.map(item => ({...item, date: new Date(item.date)}))
                            };
                        } else if(value) { // Para os outros indicadores
                            acc[key] = value.map(item => ({...item, date: new Date(item.date)}));
                        }
                        return acc;
                    }, {});
                    this.processInternationalResults();
                    uiController.updateText(config.selectors.updateTime, 'Exibindo dados do cache...');
                    return;
                }
                
                uiController.setLoadingState(true, '#international-indicators-container');

                const { fredApiCodes, fredIndicatorsConfig } = config;
                const promises = {};
                
                for (const key in fredIndicatorsConfig) {
                    promises[key] = apiService.getFREDData(fredApiCodes[key], fredIndicatorsConfig[key].apiParams, fredIndicatorsConfig[key].hasToggle ? 300 : 1000);
                }
                promises.fedTargetUpper = apiService.getFREDData(fredApiCodes.fedTargetUpper, {}, 1);
                promises.fedTargetLower = apiService.getFREDData(fredApiCodes.fedTargetLower, {}, 1);
                promises.treasury2Y = apiService.getFREDData(fredApiCodes.treasury2Y, {}, 1);
                promises.treasury10Y = apiService.getFREDData(fredApiCodes.treasury10Y, {}, 1);
                promises.treasury30Y = apiService.getFREDData(fredApiCodes.treasury30Y, {}, 1);

                const results = await Promise.allSettled(Object.values(promises));
                let data = Object.keys(promises).reduce((acc, key, index) => {
                    if (results[index].status === 'fulfilled') {
                        acc[key] = results[index].value;
                    } else {
                        acc[key] = null;
                    }
                    return acc;
                }, {});

                // --- ALTERAÇÃO ---
                // Processa os dados brutos de CPI e CoreCPI para calcular as variações
                for (const key in data) {
                    const cfg = fredIndicatorsConfig[key];
                    if (cfg && cfg.hasToggle && data[key]) {
                        const variations = this.calculateVariations(data[key]);
                        data[key] = { raw: data[key], ...variations };
                    }
                }

                this.internationalData.series = data;
                this.processInternationalResults();
                cacheService.set(cacheKey, data);
                if (this.isInternationalView) {
                    uiController.updateDateTime('FRED St. Louis Fed');
                }
            },

            processInternationalResults() {
                const { fredIndicatorsConfig, errorText } = config;
                
                for (const key in fredIndicatorsConfig) {
                    const cfg = fredIndicatorsConfig[key];
                    const seriesData = this.internationalData.series[key];
                    
                    const valueSelector = `#${key.replace(/([A-Z])/g, '-$1').toLowerCase()}-value`;
                    const dateSelector = `#${key.replace(/([A-Z])/g, '-$1').toLowerCase()}-date`;

                    if (cfg.hasToggle) {
                        // Lógica específica para cards com toggle (CPI e CoreCPI)
                        this.updateCpiCardView(key); // Apenas atualiza a view com os dados já processados
                    } else if (seriesData && seriesData.length > 0) {
                        // Lógica para os outros cards
                        const latestValue = seriesData[seriesData.length - 1];
                        let displayValue = latestValue.valor;
                        if (cfg.specialProcessing) displayValue = cfg.specialProcessing(latestValue.valor);
                        uiController.updateText(valueSelector, displayValue.toString(), { unit: cfg.unit, unitPosition: cfg.unitPos });
                        
                        const dateElement = document.querySelector(dateSelector);
                        if(dateElement) {
                            const dateString = latestValue.date.toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit', year: 'numeric'});
                            const finalDateText = cfg.descriptionText ? `${dateString} - ${cfg.descriptionText}` : dateString;
                            uiController.updateText(dateSelector, '', { isDate: true, data: finalDateText });
                        }
                        this.updateInternationalChartForPeriod(key, 5, 'years'); // Periodo padrão
                    } else {
                        // Lógica de erro
                        uiController.updateText(valueSelector, errorText);
                        const dateElement = document.querySelector(dateSelector);
                        if(dateElement) uiController.updateText(dateSelector, '', { isDate: true, data: 'N/D' });
                    }
                }
                
                const simpleCards = {
                    fedTargetUpper: '#fedtarget-upper-value', fedTargetLower: '#fedtarget-lower-value',
                    treasury2Y: '#treasury-2y-value', treasury10Y: '#treasury-10y-value', treasury30Y: '#treasury-30y-value',
                };
                for (const key in simpleCards) {
                    const series = this.internationalData.series[key];
                    const selector = simpleCards[key];
                    if(series && series.length > 0){
                        uiController.updateText(selector, series[0].valor.toFixed(2), { unit: '%', unitPosition: 'after' });
                    } else {
                        uiController.updateText(selector, errorText);
                    }
                }
            },

            // --- VERSÃO MODIFICADA ---
            updateInternationalChartForPeriod(indicatorId, periodValue, periodUnit) {
                const cfg = config.fredIndicatorsConfig[indicatorId];
                let fullHistory;
                let chartUnit = cfg.chartUnit; // Unidade padrão

                // Para cards com toggle, seleciona a série de dados correta (YoY ou Raw)
                if (cfg.hasToggle) {
                    const cardIdPrefix = indicatorId.replace(/([A-Z])/g, '-$1').toLowerCase();
                    const isMonthly = document.getElementById(`${cardIdPrefix}-toggle-switch`).checked;
                    if (isMonthly) {
                        fullHistory = this.internationalData.series[indicatorId]?.raw;
                        chartUnit = ''; // Gráfico do índice bruto não tem unidade
                    } else {
                        fullHistory = this.internationalData.series[indicatorId]?.yoy;
                        chartUnit = '%'; // Gráfico de variação anual é em %
                    }
                } else {
                    fullHistory = this.internationalData.series[indicatorId];
                }

                if (!fullHistory) return;

                let filteredData;
                if (periodUnit === 'max') {
                    filteredData = fullHistory;
                } else {
                    const cutoffDate = new Date();
                    cutoffDate.setFullYear(cutoffDate.getFullYear() - periodValue);
                    filteredData = fullHistory.filter(item => item.date >= cutoffDate);
                }
                
                const chartSelector = `#${indicatorId.replace(/([A-Z])/g, '-$1').toLowerCase()}-chart`;
                
                if(this.internationalData.charts[indicatorId]) {
                    this.internationalData.charts[indicatorId].destroy();
                }

                // Utiliza a unidade do gráfico (chartUnit) que foi definida dinamicamente
                const chartInstance = uiController.createSparklineChart(
                    chartSelector, filteredData, cfg.name, chartUnit, cfg.dateFormat
                );
                
                if (chartInstance) {
                    this.internationalData.charts[indicatorId] = chartInstance;
                }
            },
            
            // --- NOVA VERSÃO ---
            // Atualiza a visualização de um card com toggle (CPI/CoreCPI)
            updateCpiCardView(indicatorId) {
                const seriesData = this.internationalData.series[indicatorId];
                if (!seriesData || !seriesData.yoy || !seriesData.mom || !seriesData.raw) return;

                const cardIdPrefix = indicatorId.replace(/([A-Z])/g, '-$1').toLowerCase();
                const isMonthly = document.getElementById(`${cardIdPrefix}-toggle-switch`).checked;
                
                let dataToShow;
                let descriptionText;
                let valueUnit;

                if (isMonthly) {
                    // MENSAL: Mostra o índice bruto.
                    dataToShow = seriesData.raw;
                    descriptionText = "Índice Mensal";
                    valueUnit = ''; // O índice não tem unidade.
                } else {
                    // ANUAL: Mostra a variação percentual (YoY).
                    dataToShow = seriesData.yoy;
                    descriptionText = "Variação Anual";
                    valueUnit = '%';
                }
                
                // Atualiza labels do switch
                const cardElement = document.getElementById(`card-${cardIdPrefix}`);
                if (cardElement) {
                    cardElement.querySelector('.card-switch-label[data-type="anual"]').classList.toggle('active', !isMonthly);
                    cardElement.querySelector('.card-switch-label[data-type="mensal"]').classList.toggle('active', isMonthly);
                }

                if (dataToShow.length > 0) {
                    const latestValue = dataToShow[dataToShow.length - 1];
                    uiController.updateText(`#${cardIdPrefix}-value`, latestValue.valor.toFixed(2), { unit: valueUnit, unitPosition: 'after' });
                    const dateString = latestValue.date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    uiController.updateText(`#${cardIdPrefix}-date`, '', { isDate: true, data: `${dateString} - ${descriptionText}` });
                } else {
                    uiController.updateText(`#${cardIdPrefix}-value`, config.errorText);
                    uiController.updateText(`#${cardIdPrefix}-date`, '', { isDate: true, data: 'N/D' });
                }
                
                const defaultPeriodBtn = document.querySelector(`.chart-controls[data-indicator-id="${indicatorId}"] .chart-period-btn.active`);
                const defaultYears = defaultPeriodBtn ? (defaultPeriodBtn.dataset.years === 'max' ? 'max' : parseInt(defaultPeriodBtn.dataset.years, 10)) : 5;
                const defaultUnit = defaultYears === 'max' ? 'max' : 'years';
                this.updateInternationalChartForPeriod(indicatorId, defaultYears, defaultUnit);
            },

            init() {
                this.setupEventListeners();
                this.setupTheme();
                this.applyCardOrder();
                this.fetchAllNationalIndicators();
            },
            applyCardOrder() {
                const apply = (storageKey, containerId) => {
                    const savedOrder = localStorage.getItem(storageKey);
                    if (savedOrder) {
                        try {
                            const order = JSON.parse(savedOrder);
                            const container = document.getElementById(containerId);
                            order.forEach(cardId => {
                                const cardElement = container.querySelector(`[data-id="${cardId}"]`);
                                if (cardElement) container.appendChild(cardElement);
                            });
                        } catch (e) { localStorage.removeItem(storageKey); }
                    }
                };
                apply('cardOrder', 'national-indicators-container');
                apply('internationalCardOrder', 'international-indicators-container');
            },
            setupTheme() {
                const savedTheme = localStorage.getItem('themePreference');
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                const themeToggleIcon = document.querySelector('#theme-toggle i');
                if (savedTheme === 'light' || (savedTheme !== 'dark' && !prefersDark)) {
                    document.body.classList.add('light-mode');
                    themeToggleIcon.className = 'fas fa-sun';
                } else {
                    themeToggleIcon.className = 'fas fa-moon';
                }
            },
            
            setupEventListeners() {
                document.getElementById('back-btn').addEventListener('click', () => window.location.href = 'index.html');
                
                document.getElementById('refresh-btn').addEventListener('click', () => {
                    if (this.isInternationalView) {
                         localStorage.removeItem('allInternationalIndicators_v5'); // Atualiza a chave do cache
                        this.fetchAllInternationalIndicators();
                    } else {
                        localStorage.removeItem('allNationalIndicators');
                        this.fetchAllNationalIndicators();
                    }
                });
                
                const toggleFullscreen = () => { if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(err => console.error(err.message)); else if (document.exitFullscreen) document.exitFullscreen(); };
                document.getElementById('fullscreen-btn').addEventListener('click', toggleFullscreen);
                document.getElementById('fullscreen-exit-btn').addEventListener('click', toggleFullscreen);
                
                const handleFullscreenChange = () => {
                    const isFullscreen = !!document.fullscreenElement;
                    document.getElementById('fullscreen-btn').style.display = isFullscreen ? 'none' : 'flex';
                    document.getElementById('fullscreen-exit-btn').style.display = isFullscreen ? 'flex' : 'none';
                };
                ['fullscreenchange', 'webkitfullscreenchange', 'mozfullscreenchange', 'MSFullscreenChange'].forEach(event => document.addEventListener(event, handleFullscreenChange, false));
                handleFullscreenChange();
                
                document.getElementById('theme-toggle').addEventListener('click', () => {
                    document.body.classList.toggle('light-mode');
                    const isLight = document.body.classList.contains('light-mode');
                    localStorage.setItem('themePreference', isLight ? 'light' : 'dark');
                    document.querySelector('#theme-toggle i').className = isLight ? 'fas fa-sun' : 'fas fa-moon';
                    if(this.isInternationalView) this.processInternationalResults();
                    else this.processNationalResults(this.nationalData);
                });

                document.getElementById('view-toggle-switch').addEventListener('change', (e) => {
                    this.isInternationalView = e.target.checked;
                    const nationalContainer = document.getElementById('national-indicators-container');
                    const internationalContainer = document.getElementById('international-indicators-container');
                    
                    document.getElementById('label-nacional').classList.toggle('active', !this.isInternationalView);
                    document.getElementById('label-internacional').classList.toggle('active', this.isInternationalView);

                    if (this.isInternationalView) {
                        nationalContainer.style.display = 'none';
                        internationalContainer.style.display = 'flex';
                        if (!this.internationalData.series || Object.keys(this.internationalData.series).length === 0) {
                            this.fetchAllInternationalIndicators();
                        } else {
                             uiController.updateDateTime('FRED St. Louis Fed');
                        }
                    } else {
                        nationalContainer.style.display = 'flex';
                        internationalContainer.style.display = 'none';
                        uiController.updateDateTime('BCB, Investing.com');
                    }
                });

                const setupCardFlipping = (container) => {
                    container.addEventListener('click', e => {
                        // --- ALTERAÇÃO ---
                        // Impede a propagação do clique se for no switch
                        if (e.target.closest('.card-switch-container')) {
                            e.stopPropagation();
                            return;
                        }

                        const button = e.target.closest('.chart-period-btn');
                        if (button) {
                            e.stopPropagation(); 
                            const controls = button.parentElement;
                            const indicatorId = controls.dataset.indicatorId;
                            
                            if (container.id === 'national-indicators-container') {
                                const period = button.dataset.days || button.dataset.months;
                                this.updateNationalChartForPeriod(indicatorId, period);
                            }
                            else if (container.id === 'international-indicators-container') {
                                const periodValue = button.dataset.years === 'max' ? 'max' : parseInt(button.dataset.years, 10);
                                const periodUnit = button.dataset.years === 'max' ? 'max' : 'years';
                                this.updateInternationalChartForPeriod(indicatorId, periodValue, periodUnit);
                            }
                            
                            controls.querySelectorAll('.chart-period-btn').forEach(btn => btn.classList.remove('active'));
                            button.classList.add('active');
                            return; 
                        }
                        if (e.target.closest('.drag-handle')) return;
                        
                        const card = e.target.closest('.indicator-card');
                        if (card) card.classList.toggle('flipped');
                    });
                };
                setupCardFlipping(document.getElementById('national-indicators-container'));
                setupCardFlipping(document.getElementById('international-indicators-container'));

                // --- NOVO EVENT LISTENER ---
                // Adiciona os listeners para os switches do CPI e CoreCPI
                document.getElementById('cpi-toggle-switch').addEventListener('change', () => this.updateCpiCardView('cpi'));
                document.getElementById('core-cpi-toggle-switch').addEventListener('change', () => this.updateCpiCardView('coreCpi'));

                const setupSortable = (containerId, storageKey) => {
                     new Sortable(document.getElementById(containerId), {
                        animation: 150,
                        ghostClass: 'sortable-ghost',
                        chosenClass: 'sortable-chosen',
                        handle: '.drag-handle',
                        onEnd: function (evt) {
                            const order = Array.from(evt.to.children).map(el => el.dataset.id);
                            localStorage.setItem(storageKey, JSON.stringify(order));
                        }
                    });
                }
                setupSortable('national-indicators-container', 'cardOrder');
                setupSortable('international-indicators-container', 'internationalCardOrder');
            }
        };

        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
