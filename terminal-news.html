<!DOCTYPE html>
<html lang="pt-br">
<head>
     <script async src="https://www.googletagmanager.com/gtag/js?id=G-5JZRK5NNKG"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-5JZRK5NNKG');
</script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Terminal de Notícias - Mercado Macro</title>
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Courier+New&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
        --primary-color: #00d180;
        --primary-light: #5bffb0;
        --primary-dark: #009e53;
        --dark-bg: #0d1117;
        --darker-bg: #010409;
        --text-color: #c9d1d9;
        --text-secondary: rgba(139, 148, 158, 0.7);
        --card-bg-val: 22, 27, 34; /* Usado para rgba */
        --card-bg: rgba(var(--card-bg-val), 0.85);
        --border-color: rgba(48, 54, 61, 0.8);
        --error-color: #ff7b72;
        --transition-speed: 0.3s;
        --shadow-color-soft: rgba(0, 0, 0, 0.2);
        --shadow-color-medium: rgba(0, 0, 0, 0.3);
        --link-color: #58a6ff;
        --link-hover-color: #2f81f7;
        --crypto-accent-border: var(--primary-light);
        --finance-accent-border: var(--primary-color);
        /* Variáveis para Scrollbar */
        --scrollbar-size: 6px;
        --scrollbar-thumb-color: rgba(139, 148, 158, 0.3);
        --scrollbar-thumb-hover-color: rgba(139, 148, 158, 0.5);
        --scrollbar-track-color: transparent;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
        margin: 0; padding: 0;
        font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        background: linear-gradient(135deg, var(--darker-bg) 0%, var(--dark-bg) 100%);
        color: var(--text-color);
        min-height: 100vh; width: 100%;
        overflow-x: hidden;
        line-height: 1.7;
        transition: background var(--transition-speed) ease, color var(--transition-speed) ease;
        display: flex; flex-direction: column;
        position: relative;
        scrollbar-width: thin;
        scrollbar-color: var(--scrollbar-thumb-color) var(--scrollbar-track-color);
    }
    body:hover {
        scrollbar-color: var(--scrollbar-thumb-hover-color) var(--scrollbar-track-color);
    }

    ::-webkit-scrollbar {
        width: var(--scrollbar-size);
        height: var(--scrollbar-size);
    }
    ::-webkit-scrollbar-track {
        background: var(--scrollbar-track-color);
        border-radius: calc(var(--scrollbar-size) / 2);
    }
    ::-webkit-scrollbar-thumb {
        background-color: var(--scrollbar-thumb-color);
        border-radius: calc(var(--scrollbar-size) / 2);
        border: 1px solid var(--scrollbar-track-color);
    }
    ::-webkit-scrollbar-thumb:hover {
        background-color: var(--scrollbar-thumb-hover-color);
    }

    :focus { outline: 2px solid var(--primary-color); outline-offset: 2px; }
    :focus-visible { outline: 2px solid var(--primary-color); outline-offset: 2px; }

    /* INÍCIO: ESTILOS DO NOVO CABEÇALHO */
    .header {
        padding: 0;
        text-align: center;
        position: relative;
        background-color: var(--dark-bg);
        border-bottom: 1px solid var(--border-color);
        box-shadow: 0 8px 32px 0 var(--shadow-color-soft);
        z-index: 100;
    }
    .logo-container {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 20px;
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
        padding: 10px 20px;
    }

    .logo {
        text-align: left;
        flex-shrink: 0;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        margin-bottom: 0;
    }
    .page-title-header {
        font-size: 28px;
        font-weight: 900;
        line-height: 1.1;
        letter-spacing: -0.7px;
        background: linear-gradient(120deg, var(--primary-light) 20%, var(--primary-color) 80%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 4px;
        text-transform: uppercase;
    }
    .logo-divider {
        width: 70px;
        height: 4px;
        background: linear-gradient(to right, var(--primary-color), var(--primary-light));
        margin: 0;
        border-radius: 4px;
    }
    .subheader {
        font-size: 14px;
        color: var(--text-secondary);
        font-weight: 600;
        text-align: right;
        margin-bottom: 0;
    }
    /* FIM: ESTILOS DO NOVO CABEÇALHO */


    .container {
        flex: 1; max-width: 1200px; width: 100%;
        margin: 0 auto; padding: 30px 20px;
        box-sizing: border-box; text-align: center;
        display: flex; flex-direction: column;
    }

    .scope-toggle-container {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 25px;
        font-family: 'Montserrat', sans-serif;
        font-weight: 600;
        font-size: 0.9rem;
        user-select: none;
    }

    .scope-toggle-container span {
        padding: 0 10px;
        color: var(--text-secondary);
        cursor: pointer;
        transition: color 0.3s ease;
    }

    .scope-toggle-container span.active-scope {
        color: var(--primary-color);
        font-weight: 700;
    }

    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 26px;
        margin: 0 5px;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(var(--card-bg-val), 0.4);
        border: 1px solid var(--border-color);
        transition: .4s;
        border-radius: 26px;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: var(--text-secondary);
        transition: .4s;
        border-radius: 50%;
    }

    input:checked + .slider {
        background-color: var(--primary-color);
        border-color: var(--primary-dark);
    }

    input:checked + .slider:before {
        transform: translateX(24px);
        background-color: white;
    }
    
    input:focus + .slider {
        box-shadow: 0 0 0 2px var(--dark-bg), 0 0 0 4px var(--primary-color);
    }

    .news-grid-wrapper {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        grid-auto-rows: auto;
        gap: 20px;
        width: 100%;
    }

    .news-widget {
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 1rem;
      color: var(--text-color);
      position: relative;
      box-shadow: var(--shadow-color-soft);
      font-family: 'Courier New', Courier, monospace;
      display: flex;
      flex-direction: column;
      transition: opacity 0.3s ease, transform 0.3s ease;
    }
    .news-widget[style*="display: none"] {
        opacity: 0;
        transform: scale(0.95);
        pointer-events: none;
    }

    .crypto-widget { border-top: 3px solid var(--crypto-accent-border); }
    .finance-widget { border-top: 3px solid var(--finance-accent-border); }

    .refresh-widget {
      position: absolute; top: 10px; right: 10px;
      background: transparent; color: var(--text-secondary);
      border: none; cursor: pointer; font-size: 0.9rem;
      display: flex; align-items: center; gap: 4px;
      padding: 5px; border-radius: 4px;
      transition: color 0.2s ease, background-color 0.2s ease;
    }
    .refresh-widget:hover { color: var(--primary-color); background-color: rgba(var(--card-bg-val), 0.5); }
    
    .news-widget h3 {
      font-size: 1.1rem; color: var(--primary-color);
      margin-top: 0; margin-bottom: 0.75rem;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 0.75rem; display: flex; align-items: center;
      padding-right: 30px; font-family: 'Montserrat', sans-serif; font-weight: 600;
      flex-shrink: 0;
    }
    .news-widget h3 i { margin-right: 8px; }

    .news-list {
      list-style: none; padding: 0; margin: 0;
      flex-grow: 1;
      overflow-y: auto;
      max-height: 300px;
      scrollbar-width: thin;
      scrollbar-color: var(--scrollbar-thumb-color) var(--scrollbar-track-color);
    }
    .news-list:hover {
        scrollbar-color: var(--scrollbar-thumb-hover-color) var(--scrollbar-track-color);
    }

    .news-list li {
      margin: 0.6rem 0; border-left: 3px solid var(--primary-light);
      padding-left: 0.75rem; font-size: 0.9rem;
      display: flex; justify-content: space-between; align-items: center;
    }
    .news-list li i.fa-spinner { margin-right: 5px; color: var(--primary-color); animation: spin 1.5s linear infinite; }
     @keyframes spin { to { transform: rotate(360deg); } }
    .news-list li i.fa-exclamation-triangle, .news-list li i.fa-exclamation-circle, .news-list li i.fa-info-circle { margin-right: 5px; }
    .news-list li i.fa-exclamation-triangle, .news-list li i.fa-exclamation-circle { color: var(--error-color); }
    .news-list li i.fa-info-circle { color: var(--text-secondary); }

    .news-list a {
      text-decoration: none;
      color: var(--link-color);
      display: inline-block;
      transition: color 0.2s, opacity 0.3s;
      overflow-wrap: break-word;
      word-break: break-word;
      margin-right: 10px; /* Espaço para o botão de partilha */
    }
    .news-list a:hover { color: var(--link-hover-color); }
    .news-list a.is-read { opacity: 0.6; }


    .timestamp {
      font-size: 0.75rem; color: var(--text-secondary);
      margin-top: 10px; text-align: right; font-style: italic;
      flex-shrink: 0;
    }

    .floating-btn-container {
        position: fixed;
        bottom: 20px;
        z-index: 1000;
        display: flex;
        gap: 10px;
    }

    .floating-btn-container.left {
        left: 20px;
    }

    .floating-btn-container.right {
        right: 20px;
    }
    
    .floating-btn {
        width: 50px; height: 50px; border-radius: 12px;
        background-color: var(--card-bg); color: var(--text-color); border: 1px solid var(--border-color);
        cursor: pointer; 
        display: flex; align-items: center; justify-content: center;
        transition: all 0.2s ease; backdrop-filter: blur(8px); box-shadow: 0 5px 15px var(--shadow-color-soft);
        -webkit-tap-highlight-color: transparent; will-change: transform, background-color;
    }
    .floating-btn:hover { background-color: var(--primary-color); transform: translateY(-4px) scale(1.05); color: var(--dark-bg); box-shadow: 0 8px 20px var(--shadow-color-medium); }
    .floating-btn:active { transform: translateY(0) scale(1); }
    .floating-btn i { font-size: 20px; }

    #top-btn { opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
    #top-btn.visible { opacity: 1; visibility: visible; }
    
    footer { 
        font-size: 13px; margin-top: 40px; text-align: center;
        color: var(--text-secondary); padding: 20px 0;
        border-top: 1px solid var(--border-color);
    }
    
    /* === INÍCIO: CSS GERAL DE MODAL === */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 2000;
        display: flex;
        justify-content: center;
        align-items: center;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
        backdrop-filter: blur(5px);
    }
    .modal-overlay.visible {
        opacity: 1;
        visibility: visible;
    }
    .modal-content {
        background-color: var(--card-bg);
        color: var(--text-color);
        padding: 25px;
        border-radius: 10px;
        border: 1px solid var(--border-color);
        width: 90%;
        max-width: 700px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 10px 30px var(--shadow-color-medium);
        position: relative;
        font-family: 'Courier New', Courier, monospace;
    }
    .modal-content h2 {
        font-family: 'Montserrat', sans-serif;
        color: var(--primary-color);
        margin-top: 0;
        margin-bottom: 20px;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 15px;
    }
    .modal-content ul {
        list-style: none;
        padding: 0;
        text-align: left;
    }
    .modal-close {
        position: absolute;
        top: 15px;
        right: 20px;
        background: none;
        border: none;
        color: var(--text-secondary);
        font-size: 24px;
        cursor: pointer;
        transition: color 0.2s ease;
    }
    .modal-close:hover {
        color: var(--primary-color);
    }
    .modal-content li {
        margin-bottom: 20px;
        padding-left: 0;
        list-style-type: none;
    }
    .modal-content li::before {
        content: none;
    }
    /* === FIM: CSS GERAL DE MODAL === */

    /* === INÍCIO: CSS DO BRIEFING (adaptado para o modal geral) === */
    .briefing-source-title {
        font-family: 'Montserrat', sans-serif;
        color: var(--primary-light);
        font-size: 1.2rem;
        margin-top: 25px;
        margin-bottom: 15px;
        padding-bottom: 5px;
        border-bottom: 2px solid var(--primary-dark);
    }
    #briefing-list > h3:first-of-type {
        margin-top: 5px;
    }
    #briefing-list li a {
        font-size: 1rem;
        font-weight: bold;
        color: var(--link-color);
        text-decoration: none;
    }
    #briefing-list li a:hover {
        color: var(--link-hover-color);
        text-decoration: underline;
    }
    .briefing-item-description {
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-top: 5px;
        margin-bottom: 8px;
        line-height: 1.5;
    }
    .briefing-item-date {
        font-size: 0.75rem;
        color: var(--primary-color);
        font-style: italic;
        opacity: 0.8;
    }
    
    #chart-container {
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid var(--border-color);
    }
     #chart-container h3 {
        font-family: 'Montserrat', sans-serif;
        color: var(--primary-light);
        font-size: 1.2rem;
        margin-bottom: 15px;
    }
    /* === FIM: CSS DO BRIEFING === */
    
    /* === INÍCIO: CSS DO PAINEL DE CONFIGURAÇÕES === */
    .settings-section {
      margin-bottom: 25px;
      text-align: left;
    }
    .settings-section h3 {
      font-family: 'Montserrat', sans-serif;
      font-size: 1.1rem;
      color: var(--primary-light);
      margin-bottom: 15px;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 8px;
    }
    #settings-feeds-list {
      columns: 2;
      gap: 10px;
    }
    #settings-feeds-list li {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
    }
    .settings-feed-label {
      font-family: 'Montserrat', sans-serif;
      font-size: 0.9rem;
      cursor: pointer;
      margin-left: 8px;
    }
    #keywords-input {
      width: 100%;
      background-color: var(--dark-bg);
      color: var(--text-color);
      border: 1px solid var(--border-color);
      border-radius: 5px;
      padding: 8px 12px;
      font-family: 'Courier New', Courier, monospace;
      margin-bottom: 10px;
    }
    #settings-save-btn {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-family: 'Montserrat', sans-serif;
      font-weight: 600;
      float: right;
      transition: background-color 0.2s ease, color 0.2s ease;
    }
    #settings-save-btn:hover {
      background-color: var(--primary-dark);
    }
    #settings-save-btn.is-saving {
        background-color: var(--primary-dark);
        cursor: default;
    }
    /* === FIM: CSS DO PAINEL DE CONFIGURAÇÕES === */

    body.light-mode {
        --primary-color: #007aff; --primary-light: #53a6ff; --primary-dark: #0056b3;
        --dark-bg: #ffffff; --darker-bg: #f0f2f5;
        --text-color: #1c1e21; --text-secondary: rgba(51, 51, 51, 0.75);
        --card-bg: rgba(255, 255, 255, 0.98); --border-color: rgba(200, 205, 210, 0.7);
        --card-bg-val: 248, 249, 250;
        --error-color: #dc3545;
        --shadow-color-soft: rgba(0, 0, 0, 0.08); --shadow-color-medium: rgba(0, 0, 0, 0.12);
        --link-color: #0056b3; --link-hover-color: #004085;
        --crypto-accent-border: var(--primary-light);
        --finance-accent-border: var(--primary-color);
        --scrollbar-thumb-color: rgba(51, 51, 51, 0.4);
        --scrollbar-thumb-hover-color: rgba(51, 51, 51, 0.6);
        background: linear-gradient(135deg, var(--darker-bg) 0%, var(--dark-bg) 100%);
    }
    body.light-mode .page-title-header { background: linear-gradient(120deg, var(--primary-dark), var(--primary-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    body.light-mode .logo-divider { background: linear-gradient(to right, var(--primary-color), var(--primary-light));}
    body.light-mode .floating-btn { background-color: var(--card-bg); color: var(--text-color); border: 1px solid var(--border-color); }
    body.light-mode .floating-btn:hover { background-color: var(--primary-color); color: white; }
    body.light-mode .theme-toggle i { color: var(--text-color); }
    body.light-mode .theme-toggle:hover i { color: white; }
    body.light-mode .news-widget { background-color: #fff; border: 1px solid var(--border-color); box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); }
    body.light-mode .news-widget h3 { color: var(--primary-color); border-bottom-color: var(--border-color); }
    body.light-mode .refresh-widget { color: var(--text-secondary); }
    body.light-mode .refresh-widget:hover { color: var(--primary-color); background-color: rgba(var(--card-bg-val), 0.8); }
    body.light-mode .news-list li { border-left-color: var(--primary-light); }
    body.light-mode .news-list a { color: var(--link-color); }
    body.light-mode .news-list a:hover { color: var(--link-hover-color); }
    body.light-mode .timestamp { color: var(--text-secondary); }
    body.light-mode .news-list li i.fa-spinner { color: var(--primary-color); }
    body.light-mode .news-list li i.fa-exclamation-triangle, body.light-mode .news-list li i.fa-info-circle { color: var(--text-secondary); }
    body.light-mode .news-list li i.fa-exclamation-triangle { color: var(--error-color); }
    
    .search-container {
        margin-bottom: 25px;
        padding: 0 10px;
    }
    .search-bar {
        width: 100%;
        max-width: 500px;
        padding: 10px 15px;
        border-radius: 6px;
        border: 1px solid var(--border-color);
        background-color: var(--card-bg);
        color: var(--text-color);
        font-size: 1rem;
        font-family: 'Montserrat', sans-serif;
        transition: border-color 0.3s, box-shadow 0.3s;
    }
    .search-bar:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(var(--primary-color), 0.3);
        outline: none;
    }

    .share-btn {
        background: none; border: none;
        color: var(--text-secondary); cursor: pointer;
        font-size: 1rem; padding: 5px;
        transition: color 0.2s ease;
        flex-shrink: 0;
    }
    .share-btn:hover { color: var(--primary-color); }

    .retry-btn {
        background: var(--primary-dark);
        color: #fff;
        border: none;
        padding: 5px 10px;
        font-size: 0.8rem;
        border-radius: 4px;
        cursor: pointer;
        margin-left: auto;
        transition: background-color 0.2s;
    }
    .retry-btn:hover { background-color: var(--primary-color); }

    .no-results-per-widget {
        color: var(--text-secondary);
        font-style: italic;
        padding: 10px;
        text-align: center;
        width: 100%;
        display: block;
        border-left: none;
    }
    
    #global-no-search-results {
        display: none; /* Escondido por padrão */
        color: var(--text-secondary);
        font-style: italic;
        margin-top: -15px;
        margin-bottom: 20px;
        padding: 10px;
        border-radius: 6px;
        background-color: rgba(var(--card-bg-val), 0.5);
        max-width: 500px;
        margin-left: auto;
        margin-right: auto;
    }
    
    mark {
      background-color: var(--primary-color);
      color: var(--dark-bg);
      padding: 2px;
      border-radius: 3px;
    }
    body.light-mode mark {
        color: white;
    }

    .skeleton {
        height: 1em;
        border-radius: 4px;
        background: linear-gradient(90deg, rgba(139, 148, 158, 0.1), rgba(139, 148, 158, 0.2), rgba(139, 148, 158, 0.1));
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite linear;
    }
    .skeleton.w-100 { width: 100%; }
    .skeleton.w-75 { width: 75%; }
    .skeleton.w-50 { width: 50%; }
    .skeleton-title { height: 1.1rem; margin-bottom: 1.5rem; width: 60%; }
    .skeleton-list li { margin: 1rem 0; }

    @keyframes shimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }

    .visually-hidden {
      position: absolute;
      width: 1px; height: 1px;
      padding: 0; margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      border: 0;
    }

    /* INÍCIO: CSS RESPONSIVO DO CABEÇALHO E PÁGINA */
    @media (max-width: 992px) {
        .logo-container {
            flex-direction: column;
            align-items: center;
            gap: 15px;
            padding: 10px 15px;
        }
        .page-title-header {
            font-size: 26px;
            text-align: center;
        }
        .logo-divider {
            margin: 5px auto;
        }
        
        .subheader {
            text-align: center;
        }
    }

    @media (max-width: 768px) {
        .container { padding: 20px 15px; }
        .page-title-header { font-size: 24px; } /* Ajuste fino */
        .news-grid-wrapper { grid-template-columns: 1fr; padding-bottom: 80px; }
        .floating-btn-container {
            gap: 8px;
        }
        .floating-btn-container.left { left: 15px; }
        .floating-btn-container.right { right: 15px; }
        .floating-btn { width: 45px; height: 45px; border-radius: 10px; }
        #settings-feeds-list { columns: 1; }
    }
    @media (max-width: 480px) {
        .page-title-header { font-size: 22px; } /* Ajuste fino */
        .floating-btn-container.left { left: 10px; }
        .floating-btn-container.right { right: 10px; }
        .floating-btn { width: 40px; height: 40px; }
    }
	/* FIM: CSS RESPONSIVO */
    
	/* Estilos adicionais para o modal de notificações */
    #notification-types-list li {
        margin-bottom: 12px;
        display: flex;
        align-items: center;
    }

    #notification-types-list input[type="checkbox"] {
        margin-right: 10px;
    }

    #notify-start, #notify-end {
        background-color: var(--card-bg);
        color: var(--text-color);
        border: 1px solid var(--border-color);
        padding: 8px;
        border-radius: 4px;
        font-family: 'Montserrat', sans-serif;
    }

    .tooltip {
        position: relative;
        display: inline-block;
        margin-left: 8px;
    }

    .tooltip .tooltiptext {
        visibility: hidden;
        width: 200px;
        background-color: var(--card-bg);
        color: var(--text-color);
        text-align: center;
        border-radius: 6px;
        padding: 8px;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        opacity: 0;
        transition: opacity 0.3s;
        border: 1px solid var(--border-color);
        box-shadow: 0 2px 10px var(--shadow-color-soft);
        font-size: 0.8rem;
        font-weight: normal;
    }

    .tooltip:hover .tooltiptext {
        visibility: visible;
        opacity: 1;
    }
  </style>
</head>

<body>

<div id="aria-live-announcer" class="visually-hidden" role="status" aria-live="polite"></div>

<header class="header">
    <div class="logo-container">
        <div class="logo">
            <div class="page-title-header">Terminal de Notícias</div>
            <div class="logo-divider"></div>
        </div>
        
        </div>
    </div>
</header>

<div class="container">
    <div class="scope-toggle-container">
        <span id="scope-label-international">Internacional</span>
        <label class="toggle-switch">
            <input type="checkbox" id="news-scope-toggle">
            <span class="slider"></span>
        </label>
        <span id="scope-label-local">Local</span>
    </div>
    
    <div class="search-container">
        <input type="search" id="search-bar" class="search-bar" placeholder="Buscar em todas as notícias...">
    </div>
    
    <div id="global-no-search-results">Nenhum resultado encontrado para a sua busca.</div>

    <div class="news-grid-wrapper">
        <article class="news-widget finance-widget">
            <div class="skeleton skeleton-title"></div>
            <ul class="skeleton-list">
                <li><div class="skeleton w-75"></div></li>
                <li><div class="skeleton w-50"></div></li>
                <li><div class="skeleton w-75"></div></li>
                <li><div class="skeleton w-100"></div></li>
                <li><div class="skeleton w-50"></div></li>
            </ul>
        </article>
        <article class="news-widget crypto-widget">
            <div class="skeleton skeleton-title"></div>
            <ul class="skeleton-list">
                <li><div class="skeleton w-50"></div></li>
                <li><div class="skeleton w-75"></div></li>
                <li><div class="skeleton w-100"></div></li>
                <li><div class="skeleton w-50"></div></li>
                <li><div class="skeleton w-75"></div></li>
            </ul>
        </article>
        <article class="news-widget finance-widget">
            <div class="skeleton skeleton-title"></div>
            <ul class="skeleton-list">
                <li><div class="skeleton w-100"></div></li>
                <li><div class="skeleton w-50"></div></li>
                <li><div class="skeleton w-75"></div></li>
                <li><div class="skeleton w-75"></div></li>
                <li><div class="skeleton w-50"></div></li>
            </ul>
        </article>
    </div>

    <footer>© <span id="current-year"></span> Mercado Macro - Fontes de Notícias sobre Criptomoedas e Finanças Globais</footer>
</div>

<div class="floating-btn-container left">
    <button class="theme-toggle floating-btn" id="theme-toggle" aria-label="Alternar tema claro/escuro" aria-pressed="false">
        <i class="fas fa-moon"></i>
    </button>
    <button class="floating-btn" id="notifications-btn" aria-label="Ativar notificações">
        <i class="fas fa-bell"></i>
    </button>
</div>

<div class="floating-btn-container right">
    <button id="settings-btn" class="floating-btn" aria-label="Abrir Configurações">
        <i class="fas fa-cog"></i>
    </button>
    <button id="briefing-btn" class="floating-btn" aria-label="Gerar Briefing das Notícias">
        <i class="fas fa-clipboard-list"></i>
    </button>
    <button id="top-btn" class="floating-btn" aria-label="Voltar ao topo">
        <i class="fas fa-arrow-up"></i>
    </button>
    <button id="home-btn" class="floating-btn" aria-label="Página inicial">
        <i class="fas fa-home"></i>
    </button>
    <button id="refresh-btn" class="floating-btn" aria-label="Atualizar tudo">
        <i class="fas fa-sync-alt"></i>
    </button>
</div>

<div id="briefing-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="briefing-title">
    <div class="modal-content">
        <button id="briefing-modal-close-btn" class="modal-close" aria-label="Fechar">&times;</button>
        <h2 id="briefing-title">Briefing de Notícias</h2>
        <ul id="briefing-list"></ul>
        <div id="chart-container" style="display: none;">
            <h3>Termos Frequentes nas Manchetes</h3>
            <canvas id="word-frequency-chart"></canvas>
        </div>
    </div>
</div>

<div id="settings-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="settings-title">
    <div class="modal-content">
        <button id="settings-modal-close-btn" class="modal-close" aria-label="Fechar">&times;</button>
        <h2 id="settings-title">Configurações</h2>
        
        <div class="settings-section">
            <h3>Fontes de Notícias Visíveis</h3>
            <ul id="settings-feeds-list">
                </ul>
        </div>

        <div class="settings-section">
            <h3>Destaque de Palavras-chave</h3>
            <p class="briefing-item-description">Digite palavras ou frases separadas por vírgula. Elas serão destacadas nos títulos das notícias.</p>
            <textarea id="keywords-input" rows="3" placeholder="Ex: bitcoin, juros, IBC-Br, ..."></textarea>
        </div>

        <button id="settings-save-btn">Salvar e Fechar</button>
    </div>
</div>

<div id="notifications-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="notifications-modal-title">
    <div class="modal-content">
        <button id="notifications-modal-close-btn" class="modal-close" aria-label="Fechar">&times;</button>
        <h2 id="notifications-modal-title">Configurações de Notificações</h2>
        
        <div class="settings-section">
            <h3>Tipos de Notificações</h3>
            <ul id="notification-types-list" style="list-style: none; padding: 0;">
                <li>
                    <input type="checkbox" id="notify-urgent" checked>
                    <label for="notify-urgent">Notícias urgentes (com "urgente" ou "alerta" no título)</label>
                </li>
                <li>
                    <input type="checkbox" id="notify-updates">
                    <label for="notify-updates">Atualizações regulares de notícias</label>
                </li>
                <li>
                    <input type="checkbox" id="notify-market">
                    <label for="notify-market">Movimentos significativos de mercado</label>
                </li>
            </ul>
        </div>

        <div class="settings-section">
            <h3>Horário para Notificações</h3>
            <div style="display: flex; gap: 10px; align-items: center;">
                <label for="notify-start">De:</label>
                <input type="time" id="notify-start" value="08:00">
                <label for="notify-end">Até:</label>
                <input type="time" id="notify-end" value="22:00">
            </div>
        </div>

        <button id="notifications-save-btn" style="margin-top: 20px;">Salvar Configurações</button>
    </div>
</div>


<script>
  // Variáveis Globais
  const CACHE_KEY_PREFIX = 'terminalNewsCacheV6_'; // Versão do cache incrementada
  const PROXY_MAP_KEY = 'terminalNewsProxyMap_v1';
  const CACHE_TTL = 15 * 60 * 1000;
  const FETCH_TIMEOUT = 15000;

  const PROXY_SERVICES = [
    { name: 'allorigins', url: (targetUrl) => `https://api.allorigins.win/raw?url=${encodeURIComponent(targetUrl)}` },
    { name: 'corsproxy.io', url: (targetUrl) => `https://corsproxy.io/?${encodeURIComponent(targetUrl)}` },
    { name: 'codetabs', url: (targetUrl) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(targetUrl)}` }
  ];
  let wordFrequencyChart = null;

  const rssFeeds = {
    guiadobitcoin: { url: 'https://cms.zerohedge.com/fullrss2.xml', elementId: 'zerohedge-news', timestampId: 'zerohedge-timestamp', category: 'crypto', displayName: 'Zero Hedge', scope: 'international', icon: 'fa-newspaper'},
    noticiabrasil: { url: 'https://noticiabrasil.net.br/export/rss2/archive/index.xml', elementId: 'noticiabrasil-news', timestampId: 'noticiabrasil-timestamp', category: 'crypto', displayName: 'Notícia Brasil', scope: 'local', icon: 'fa-globe-americas'},
    cointelegraph: { url: 'https://br.cointelegraph.com/rss/tag/bitcoin', elementId: 'cointelegraph-news', timestampId: 'cointelegraph-timestamp', category: 'crypto', displayName: 'Cointelegraph BR', scope: 'local', icon: 'fa-bitcoin'},
    advfn: { url: 'https://br.advfn.com/common/news/feeds/paperbr/rss', elementId: 'advfn-news', timestampId: 'advfn-timestamp', category: 'finance', displayName: 'ADVFN BR', scope: 'local', icon: 'fa-newspaper'},
    investing: { url: 'https://br.investing.com/rss/news.rss', elementId: 'investing-news', timestampId: 'investing-timestamp', category: 'finance', displayName: 'Investing.com BR', scope: 'local', icon: 'fa-chart-line'},
    infomoney: { url: 'https://www.infomoney.com.br/feed/', elementId: 'infomoney-news', timestampId: 'infomoney-timestamp', category: 'finance', displayName: 'InfoMoney', scope: 'local', icon: 'fa-money-bill-wave'},
    valor: { url: 'https://www.valor.com.br/rss', elementId: 'valor-news', timestampId: 'valor-timestamp', category: 'finance', displayName: 'Valor Econômico', scope: 'local', icon: 'fa-landmark'},
    dukascopy: { url: 'https://www.dukascopy.com/fxspider/pt/rss/news_sector/finance/', elementId: 'dukascopy-news', timestampId: 'dukascopy-timestamp', category: 'finance', displayName: 'Dukascopy', scope: 'international', icon: 'fa-globe-europe'},
    forexlive: { url: 'https://www.forexlive.com/feed', elementId: 'forexlive-news', timestampId: 'forexlive-timestamp', category: 'finance', displayName: 'ForexLive', scope: 'international', icon: 'fa-dollar-sign'},
    fxmarkets: { url: 'https://www.fx-markets.com/feeds/rss', elementId: 'fxmarkets-news', timestampId: 'fxmarkets-timestamp', category: 'finance', displayName: 'FX Markets', scope: 'international', icon: 'fa-exchange-alt'},
    fxstreet: { url: 'https://www.fxstreet.com/rss/news', elementId: 'fxstreet-news', timestampId: 'fxstreet-timestamp', category: 'finance', displayName: 'FXStreet', scope: 'international', icon: 'fa-road'},
    ing: { url: 'https://rss.app/feeds/9lbwhwyNi8qv0X5h.xml', elementId: 'ing-news', timestampId: 'ing-timestamp', category: 'finance', displayName: 'ING Think', scope: 'international', icon: 'fa-lightbulb'}
  };
  
  const AppState = {
    _newsScope: 'local',
    _enabledFeeds: Object.keys(rssFeeds),
    _keywords: [],
    _readArticles: new Set(),
    _proxyMap: {},
    
    init() {
        const savedScope = localStorage.getItem('terminalNewsScope_v1') || 'local';
        this.newsScope = savedScope;

        const savedFeeds = localStorage.getItem('terminalEnabledFeeds_v1');
        this._enabledFeeds = savedFeeds ? JSON.parse(savedFeeds) : Object.keys(rssFeeds);
        
        const savedKeywords = localStorage.getItem('terminalKeywords_v1');
        this.keywords = savedKeywords ? JSON.parse(savedKeywords) : [];
        
        const savedReadArticles = localStorage.getItem('terminalReadArticles_v1');
        this._readArticles = new Set(savedReadArticles ? JSON.parse(savedReadArticles) : []);

        const savedProxyMap = localStorage.getItem(PROXY_MAP_KEY);
        this._proxyMap = savedProxyMap ? JSON.parse(savedProxyMap) : {};
    },
    
    get newsScope() { return this._newsScope; },
    set newsScope(scope) {
        this._newsScope = scope;
        localStorage.setItem('terminalNewsScope_v1', scope);
    },
    
    get enabledFeeds() {
        return this._enabledFeeds.filter(key => rssFeeds[key]);
    },
    set enabledFeeds(feedKeys) {
        this._enabledFeeds = feedKeys;
        localStorage.setItem('terminalEnabledFeeds_v1', JSON.stringify(feedKeys));
    },
    
    get keywords() { return this._keywords; },
    set keywords(keys) {
        this._keywords = keys;
        localStorage.setItem('terminalKeywords_v1', JSON.stringify(keys));
    },

    get readArticles() { return this._readArticles; },
    addReadArticle(url) {
        if (!url || url === '#') return;
        this._readArticles.add(url);
        const articlesArray = Array.from(this._readArticles).slice(-200);
        localStorage.setItem('terminalReadArticles_v1', JSON.stringify(articlesArray));
    },

    getProxyForFeed(feedKey) { return this._proxyMap[feedKey]; },
    setProxyForFeed(feedKey, proxyName) {
        this._proxyMap[feedKey] = proxyName;
        localStorage.setItem(PROXY_MAP_KEY, JSON.stringify(this._proxyMap));
    }
  };

  const UI = {
    _focusTrapHandler: null,
    _elementThatOpenedModal: null,

    init() {
        document.getElementById('theme-toggle')?.addEventListener('click', this.toggleTheme);
        document.getElementById('search-bar')?.addEventListener('input', this.handleSearch);
        document.getElementById('top-btn')?.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
        window.addEventListener('scroll', () => document.getElementById('top-btn')?.classList.toggle('visible', window.pageYOffset > 300));
        document.getElementById('current-year').textContent = new Date().getFullYear();
        document.getElementById('home-btn')?.addEventListener('click', () => window.location.href = 'index.html');

        document.getElementById('briefing-btn')?.addEventListener('click', () => generateAndShowBriefing());
        this.setupModal('briefing-modal', 'briefing-modal-close-btn');
        
        document.getElementById('settings-btn')?.addEventListener('click', () => {
            this.populateSettings();
            this.toggleModal('settings-modal', true);
        });
        this.setupModal('settings-modal', 'settings-modal-close-btn');
        document.getElementById('settings-save-btn')?.addEventListener('click', () => this.saveSettings());

        const themeBtn = document.getElementById('theme-toggle');
        const isLightMode = document.body.classList.contains('light-mode');
        themeBtn?.setAttribute('aria-pressed', isLightMode ? 'false' : 'true');
    },

    toggleModal(modalId, show) {
        const modal = document.getElementById(modalId);
        if (!modal) return;

        if (show) {
            this._elementThatOpenedModal = document.activeElement;
            modal.classList.add('visible');
            this.announceToScreenReader(`${modal.querySelector('h2').textContent} aberto.`);
            this.setupFocusTrap(modal);
        } else {
            modal.classList.remove('visible');
            this.removeFocusTrap(modal);
            this.announceToScreenReader(`${modal.querySelector('h2').textContent} fechado.`);
        }
    },
    
    setupModal(modalId, closeBtnId) {
        const modal = document.getElementById(modalId);
        document.getElementById(closeBtnId)?.addEventListener('click', () => this.toggleModal(modalId, false));
        modal?.addEventListener('click', (event) => { if (event.target === modal) this.toggleModal(modalId, false); });
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && modal.classList.contains('visible')) {
                this.toggleModal(modalId, false);
            }
        });
    },

    setupFocusTrap(modalElement) {
        const focusableElements = modalElement.querySelectorAll('a[href], button:not([disabled]), textarea, input, select');
        if (focusableElements.length === 0) return;
        const firstElement = focusableElements[0];
        const lastElement = focusableElements[focusableElements.length - 1];
        
        this._focusTrapHandler = (e) => {
            if (e.key !== 'Tab') return;
            if (e.shiftKey) { 
                if (document.activeElement === firstElement) { lastElement.focus(); e.preventDefault(); }
            } else { 
                if (document.activeElement === lastElement) { firstElement.focus(); e.preventDefault(); }
            }
        };
        modalElement.addEventListener('keydown', this._focusTrapHandler);
        firstElement.focus();
    },
  
    removeFocusTrap(modalElement) {
        modalElement.removeEventListener('keydown', this._focusTrapHandler);
        if (this._elementThatOpenedModal) this._elementThatOpenedModal.focus();
    },

    renderWidgets() {
        const wrapper = document.querySelector('.news-grid-wrapper');
        wrapper.innerHTML = ''; // Limpa os esqueletos de carregamento inicial
        const fragment = document.createDocumentFragment();

        AppState.enabledFeeds.forEach(feedKey => {
            const feedConfig = rssFeeds[feedKey];
            const widget = document.createElement('article');
            widget.className = `news-widget ${feedConfig.category}-widget`;
            widget.id = `widget-${feedKey}`;
            widget.style.display = 'none'; 

            const fabIconClass = feedConfig.icon === 'fa-bitcoin' ? 'fab' : 'fas';

            widget.innerHTML = `
                <button class="refresh-widget" data-feedkey="${feedKey}" aria-label="Atualizar ${feedConfig.displayName}">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <h3><i class="${fabIconClass} ${feedConfig.icon}"></i> ${feedConfig.displayName}</h3>
                <ul class="news-list" id="${feedConfig.elementId}"></ul>
                <div class="timestamp" id="${feedConfig.timestampId}"></div>
            `;
            widget.querySelector('.refresh-widget').addEventListener('click', function() { loadNews(this.dataset.feedkey, true); });
            fragment.appendChild(widget);
        });
        wrapper.appendChild(fragment);
        updateWidgetVisibility();
    },

    renderNews(listElement, timestampId, items, feedName, updateTime) {
      listElement.innerHTML = '';
      const itemsToShow = items.slice(0, 6);
      const supportsShare = 'share' in navigator;
      const fragment = document.createDocumentFragment();

      if (itemsToShow.length === 0) {
        const li = document.createElement('li');
        li.innerHTML = `<i class="fas fa-exclamation-circle"></i> Nenhuma notícia encontrada em ${feedName || 'esta fonte'}.`;
        fragment.appendChild(li);
      } else {
        itemsToShow.forEach(item => {
          const li = document.createElement('li');
          const a = document.createElement('a');
          a.href = item.link || '#';
          a.target = '_blank';
          a.rel = 'noopener noreferrer';
          a.setAttribute('title', item.title);
          
          if (AppState.readArticles.has(a.href)) {
              a.classList.add('is-read');
          }
          a.innerHTML = this.highlightKeywords(item.title, AppState.keywords);

          a.addEventListener('click', () => {
              AppState.addReadArticle(a.href);
              a.classList.add('is-read');
          });
          
          const wrapper = document.createElement('div');
          wrapper.style.cssText = 'display: flex; align-items: center; width: 100%;';
          wrapper.appendChild(a);

          if (supportsShare) {
              const shareBtn = document.createElement('button');
              shareBtn.className = 'share-btn';
              shareBtn.setAttribute('aria-label', `Partilhar notícia: ${item.title}`);
              shareBtn.innerHTML = '<i class="fas fa-share-alt"></i>';
              shareBtn.addEventListener('click', async (e) => {
                  e.preventDefault();
                  try {
                      await navigator.share({ title: item.title, text: `Notícia de ${feedName}: ${item.title}`, url: item.link });
                  } catch (err) { console.error('Erro ao partilhar:', err); }
              });
              wrapper.appendChild(shareBtn);
          }

          li.appendChild(wrapper);
          fragment.appendChild(li);
        });
      }

      listElement.appendChild(fragment); 
      const timestampEl = document.getElementById(timestampId);
      if (timestampEl) timestampEl.textContent = `Atualizado ${formatTimeSince(updateTime)}`;
      
      this.handleSearch();
    },

    highlightKeywords(text, keywords) {
        if (!keywords || keywords.length === 0) return text;
        const regex = new RegExp(`(${keywords.join('|')})`, 'gi');
        return text.replace(regex, '<mark>$1</mark>');
    },

    populateSettings() {
        const feedsList = document.getElementById('settings-feeds-list');
        feedsList.innerHTML = '';
        Object.keys(rssFeeds).forEach(key => {
            const feed = rssFeeds[key];
            const li = document.createElement('li');
            const isChecked = AppState.enabledFeeds.includes(key);
            li.innerHTML = `
                <input type="checkbox" id="feed-toggle-${key}" data-feedkey="${key}" ${isChecked ? 'checked' : ''}>
                <label for="feed-toggle-${key}" class="settings-feed-label">${feed.displayName}</label>
            `;
            feedsList.appendChild(li);
        });
        
        document.getElementById('keywords-input').value = AppState.keywords.join(', ');
    },
    
    saveSettings() {
        const saveBtn = document.getElementById('settings-save-btn');
        if (saveBtn.classList.contains('is-saving')) return;

        const enabledFeeds = [];
        document.querySelectorAll('#settings-feeds-list input[type="checkbox"]').forEach(checkbox => {
            if (checkbox.checked) {
                enabledFeeds.push(checkbox.dataset.feedkey);
            }
        });
        AppState.enabledFeeds = enabledFeeds;

        const keywordsText = document.getElementById('keywords-input').value;
        AppState.keywords = keywordsText.split(',').map(k => k.trim()).filter(Boolean);

        // Feedback visual
        saveBtn.textContent = 'Salvo ✓';
        saveBtn.classList.add('is-saving');
        
        setTimeout(() => {
            this.toggleModal('settings-modal', false);
            this.renderWidgets(); 
            refreshAllFeeds(true);
            // Reverter botão ao estado original
            saveBtn.textContent = 'Salvar e Fechar';
            saveBtn.classList.remove('is-saving');
        }, 1000);
    },
    
    toggleTheme() {
        document.body.classList.toggle('light-mode');
        const isLightMode = document.body.classList.contains('light-mode');
        localStorage.setItem('themePreference', isLightMode ? 'light' : 'dark');
        const themeIcon = document.querySelector('#theme-toggle i');
        const themeBtn = document.getElementById('theme-toggle');
        
        if(themeIcon){
            themeIcon.classList.toggle('fa-moon', !isLightMode);
            themeIcon.classList.toggle('fa-sun', isLightMode);
        }
        themeBtn?.setAttribute('aria-pressed', !isLightMode); // Atualiza estado para leitores de tela
        
        UI.announceToScreenReader(`Tema alterado para modo ${isLightMode ? 'claro' : 'escuro'}.`);
        if (document.getElementById('briefing-modal').classList.contains('visible')) {
            generateWordFrequencyChart();
        }
    },
    
    handleSearch() {
        const searchBar = document.getElementById('search-bar');
        const globalNoResults = document.getElementById('global-no-search-results');
        if (!searchBar || !globalNoResults) return;

        const searchTerm = searchBar.value.toLowerCase().trim();
        document.querySelectorAll('.no-results-per-widget').forEach(el => el.remove());

        let totalVisibleItems = 0;

        document.querySelectorAll('.news-list').forEach(list => {
            const widget = list.closest('.news-widget');
            // Só processa a busca para widgets visíveis
            if (widget && widget.style.display !== 'none') {
                let hasVisibleItemsInWidget = false;
                const listItems = list.querySelectorAll('li');

                listItems.forEach(li => {
                    // Ignora itens de esqueleto, erro ou info da lógica de visibilidade
                    if (li.querySelector('.skeleton') || li.querySelector('.retry-btn') || li.querySelector('.fa-exclamation-circle')) {
                        li.style.display = 'flex';
                        return;
                    }
                    const title = li.textContent.toLowerCase();
                    if (title.includes(searchTerm)) {
                        li.style.display = 'flex';
                        hasVisibleItemsInWidget = true;
                        totalVisibleItems++;
                    } else {
                        li.style.display = 'none';
                    }
                });

                if (!hasVisibleItemsInWidget && searchTerm !== '' && listItems.length > 0 && !list.querySelector('.retry-btn')) {
                    const noResultsLi = document.createElement('li');
                    noResultsLi.className = 'no-results-per-widget';
                    noResultsLi.textContent = "Nenhum resultado aqui.";
                    list.appendChild(noResultsLi);
                }
            }
        });
        
        // Exibe ou esconde a mensagem global
        if (searchTerm !== '' && totalVisibleItems === 0) {
            globalNoResults.style.display = 'block';
        } else {
            globalNoResults.style.display = 'none';
        }
    },

    announceToScreenReader(message) {
      const announcer = document.getElementById('aria-live-announcer');
      if (announcer) announcer.textContent = message;
    },

    showSkeleton(listElement) {
        if (!listElement) return;
        let skeletonHTML = '';
        for (let i = 0; i < 5; i++) {
            const widthClass = i % 2 === 0 ? 'w-75' : 'w-50';
            skeletonHTML += `<li><div class="skeleton ${widthClass}"></div></li>`;
        }
        listElement.innerHTML = skeletonHTML;
    }
  };

  function formatTimeSince(timestamp) {
    if (!timestamp) return 'desconhecido';
    const now = new Date();
    const secondsPast = (now.getTime() - new Date(timestamp).getTime()) / 1000;
    if (secondsPast < 5) return 'agora mesmo';
    if (secondsPast < 60) return `há ${Math.round(secondsPast)} seg`;
    if (secondsPast < 3600) { const m = Math.round(secondsPast / 60); return `há ${m} min${m > 1 ? 's' : ''}`; }
    if (secondsPast <= 43200) { const h = Math.round(secondsPast / 3600); return `há ${h} hora${h > 1 ? 's' : ''}`; }
    const date = new Date(timestamp);
    return `em ${date.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'})} às ${date.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})}`;
  }
  
function showDesktopNotification(title, options) {
    if (!('Notification' in window) || Notification.permission !== 'granted') return;

    const settings = loadNotificationSettings();
    if (!settings.notifyUrgent && title.toLowerCase().includes('urgente')) return;
	
	  if (!settings.notifyMarket && options.marketAlert) return;

    // Verifica horário de notificação
    const now = new Date();
    const [startHour, startMinute] = settings.notifyStart.split(':').map(Number);
    const [endHour, endMinute] = settings.notifyEnd.split(':').map(Number);
    
    const startTime = new Date();
    startTime.setHours(startHour, startMinute, 0, 0);
    
    const endTime = new Date();
    endTime.setHours(endHour, endMinute, 0, 0);
    
    if (now < startTime || now > endTime) return;

    // Envia notificação
    if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
        navigator.serviceWorker.controller.postMessage({
            type: 'SEND_NOTIFICATION',
            notification: { title, ...options }
        });
    } else {
        new Notification(title, { 
            body: options.body, 
            icon: options.icon || './favicon.ico',
            data: { url: options.data?.url || '/' }
        });
    }
}

  async function loadNews(feedKey, forceRefresh = false) {
    const feedConfig = rssFeeds[feedKey];
    if (!feedConfig) return;
    
    const list = document.getElementById(feedConfig.elementId);
    const timestampEl = document.getElementById(feedConfig.timestampId);
    const widgetElement = list?.closest('.news-widget');

    if (list && widgetElement && widgetElement.style.display !== 'none') {
        UI.showSkeleton(list);
    }

    const cacheKey = `${CACHE_KEY_PREFIX}${feedConfig.elementId}`;
    const cachedEntry = localStorage.getItem(cacheKey);

    if (!forceRefresh && cachedEntry) {
      try {
        const { items, timestamp } = JSON.parse(cachedEntry);
        if ((Date.now() - timestamp) < CACHE_TTL) {
          if (list && timestampEl && widgetElement && widgetElement.style.display !== 'none') {
               UI.renderNews(list, feedConfig.timestampId, items, feedConfig.displayName, timestamp);
          }
          return;
        }
      } catch (e) { localStorage.removeItem(cacheKey); }
    }
    
    let latestOldTitle = null;
    if (cachedEntry) {
        try { latestOldTitle = JSON.parse(cachedEntry).items[0]?.title; } catch (e) {}
    }
    
    if (forceRefresh) localStorage.removeItem(cacheKey);

    const preferredProxyName = AppState.getProxyForFeed(feedKey);
    const sortedProxies = [...PROXY_SERVICES];
    if (preferredProxyName) {
        const preferredIndex = sortedProxies.findIndex(p => p.name === preferredProxyName);
        if (preferredIndex > 0) {
            const [preferredProxy] = sortedProxies.splice(preferredIndex, 1);
            sortedProxies.unshift(preferredProxy);
        }
    }

    let success = false;
    for (const proxyToTry of sortedProxies) {
        try {
            const proxyUrl = proxyToTry.url(feedConfig.url);
            const response = await fetch(proxyUrl, { signal: AbortSignal.timeout(FETCH_TIMEOUT) });
            if (!response.ok) throw new Error(`Proxy ${proxyToTry.name} retornou status ${response.status}`);
            
            const xmlText = await response.text();
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, "text/xml");
            if (xmlDoc.getElementsByTagName("parsererror").length > 0) throw new Error(`Erro de parsing XML`);
            
            const itemsXml = xmlDoc.getElementsByTagName("item");
            const fetchedItems = Array.from(itemsXml).map(itemNode => {
                let title = itemNode.querySelector("title")?.textContent || "Sem título";
                title = title.replace(/^<!\[CDATA\[(.*)\]\]>$/, '$1').trim();
                let description = itemNode.querySelector("description")?.textContent || "";
                description = description.replace(/<[^>]*>?/gm, '').trim().substring(0, 150) + '...';
                return { title, link: itemNode.querySelector("link")?.textContent.trim() || "#", description, pubDate: itemNode.querySelector("pubDate")?.textContent || null };
            });

            if (fetchedItems.length === 0 && !xmlText.toLowerCase().includes("<item>")) {
                 throw new Error(`Resposta vazia ou inválida do proxy ${proxyToTry.name}`);
            }
            const updateTime = Date.now();
            localStorage.setItem(cacheKey, JSON.stringify({ items: fetchedItems, timestamp: updateTime }));

            if (list && timestampEl && widgetElement && widgetElement.style.display !== 'none') {
                UI.renderNews(list, feedConfig.timestampId, fetchedItems, feedConfig.displayName, updateTime);
            }
            
            if (fetchedItems.length > 0 && fetchedItems[0].title !== latestOldTitle) {
                const titleLower = fetchedItems[0].title.toLowerCase();
                if (titleLower.includes('urgente') || titleLower.includes('alerta')) {
                    showDesktopNotification(`Alerta de ${feedConfig.displayName}!`, {
                        body: fetchedItems[0].title, icon: './favicon.ico', data: { url: fetchedItems[0].link }
                    });
                }
            }

            success = true;
            AppState.setProxyForFeed(feedKey, proxyToTry.name);
            break; 
        } catch (error) {
            console.warn(`Falha com proxy ${proxyToTry.name} para ${feedConfig.displayName}:`, error.message);
        }
    }

    if (!success) {
        console.error(`Todas as tentativas de proxy falharam para ${feedConfig.displayName}`);
        let showedSomething = false;
        if (cachedEntry) {
            try {
                const { items, timestamp } = JSON.parse(cachedEntry);
                if (list && timestampEl && widgetElement && widgetElement.style.display !== 'none') {
                    UI.renderNews(list, feedConfig.timestampId, items, feedConfig.displayName, timestamp);
                    const warningMsg = document.createElement('li');
                    warningMsg.style.cssText = 'font-size:0.8em; opacity:0.8; margin-top:5px;';
                    warningMsg.innerHTML = `<i class="fas fa-info-circle"></i> Dados do cache (falha ao atualizar).`;
                    list.appendChild(warningMsg);
                    showedSomething = true;
                }
            } catch (e) { localStorage.removeItem(cacheKey); }
        }

        if (!showedSomething && list && widgetElement && widgetElement.style.display !== 'none') {
            const errorLi = document.createElement('li');
            errorLi.innerHTML = `<span><i class="fas fa-exclamation-triangle"></i> Falha ao carregar.</span><button class="retry-btn" data-feedkey="${feedKey}">Tentar Novamente</button>`;
            list.innerHTML = '';
            list.appendChild(errorLi);
            list.querySelector('.retry-btn').addEventListener('click', function() { loadNews(this.dataset.feedkey, true); });
            if (timestampEl) timestampEl.textContent = "Falha na atualização";
        }
    }
  }

  function updateWidgetVisibility() {
    Object.keys(rssFeeds).forEach(feedKey => {
        const feedConfig = rssFeeds[feedKey];
        const widgetElement = document.getElementById(`widget-${feedKey}`);
        if (widgetElement) {
            if (AppState.enabledFeeds.includes(feedKey) && feedConfig.scope === AppState.newsScope) {
                widgetElement.style.display = '';
                const listElement = document.getElementById(feedConfig.elementId);
                if (listElement && listElement.children.length === 0) {
                    loadNews(feedKey, false);
                }
            } else {
                widgetElement.style.display = 'none';
            }
        }
    });
    UI.handleSearch();
  }

  function handleScopeChange() {
    const toggle = document.getElementById('news-scope-toggle');
    AppState.newsScope = toggle.checked ? 'international' : 'local';
    document.getElementById('scope-label-local').classList.toggle('active-scope', AppState.newsScope === 'local');
    document.getElementById('scope-label-international').classList.toggle('active-scope', AppState.newsScope === 'international');
    
    const wrapper = document.querySelector('.news-grid-wrapper');
    wrapper.innerHTML = '';
    UI.renderWidgets();
  }

  function initializeScopeToggle() {
    const toggle = document.getElementById('news-scope-toggle');
    const localLabel = document.getElementById('scope-label-local');
    const internationalLabel = document.getElementById('scope-label-international');
    
    toggle.checked = (AppState.newsScope === 'international');
    localLabel.classList.toggle('active-scope', AppState.newsScope === 'local');
    internationalLabel.classList.toggle('active-scope', AppState.newsScope === 'international');

    toggle.addEventListener('change', handleScopeChange);
    localLabel.addEventListener('click', () => { if (AppState.newsScope !== 'local') { toggle.checked = false; handleScopeChange(); } });
    internationalLabel.addEventListener('click', () => { if (AppState.newsScope !== 'international') { toggle.checked = true; handleScopeChange(); } });
  }

  function refreshAllFeeds(force = true) {
    const refreshBtnGlobal = document.getElementById('refresh-btn');
    if(refreshBtnGlobal && force) {
      refreshBtnGlobal.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
      refreshBtnGlobal.disabled = true;
      UI.announceToScreenReader("Atualizando notícias...");
    }
    
    const feedsToLoad = AppState.enabledFeeds.filter(feedKey => rssFeeds[feedKey].scope === AppState.newsScope);

    if (force) {
        feedsToLoad.forEach(feedKey => {
            localStorage.removeItem(`${CACHE_KEY_PREFIX}${rssFeeds[feedKey].elementId}`);
        });
    }

    feedsToLoad.forEach(feedKey => {
        const list = document.getElementById(rssFeeds[feedKey].elementId);
        const widgetElement = list?.closest('.news-widget');
        if (list && widgetElement && widgetElement.style.display !== 'none') UI.showSkeleton(list);
    });

    const promises = feedsToLoad.map(feedKey => loadNews(feedKey, force));

    Promise.allSettled(promises).finally(() => {
      if(refreshBtnGlobal && force) {
        setTimeout(() => { refreshBtnGlobal.innerHTML = '<i class="fas fa-sync-alt"></i>'; refreshBtnGlobal.disabled = false; UI.announceToScreenReader("Notícias atualizadas."); }, 1000);
      }
    });
  }
  
  function getStopWords() {
    return new Set(['de', 'a', 'o', 'que', 'e', 'do', 'da', 'em', 'um', 'para', 'é', 'com', 'não', 'uma', 'os', 'no', 'na', 'por', 'mais', 'as', 'dos', 'como', 'mas', 'foi', 'ao', 'ele', 'das', 'tem', 'à', 'seu', 'sua', 'ou', 'ser', 'quando', 'muito', 'há', 'nos', 'já', 'está', 'eu', 'também', 'só', 'pelo', 'pela', 'até', 'isso', 'ela', 'entre', 'depois', 'sem', 'mesmo', 'aos', 'ter', 'seus', 'quem', 'nas', 'me', 'esse', 'eles', 'estão', 'você', 'tinha', 'foram', 'essa', 'num', 'nem', 'suas', 'meu', 'às', 'minha', 'numa', 'pelos', 'elas', 'havia', 'seja', 'qual', 'será', 'nós', 'tenho', 'lhe', 'deles', 'essas', 'esses', 'pelas', 'este', 'fosse', 'dele', 'tu', 'te', 'vocês', 'vos', 'lhes', 'meus', 'minhas', 'teu', 'tua', 'teus', 'tuas', 'nosso', 'nossa', 'nossos', 'nossas', 'dela', 'delas', 'esta', 'estes', 'aquele', 'aquela', 'aqueles', 'aquelas', 'isto', 'aquilo', 'estou', 'está', 'estamos', 'estão', 'estive', 'esteve', 'estivemos', 'estiveram', 'estava', 'estávamos', 'estavam', 'estivera', 'estivéramos', 'esteja', 'estejamos', 'estejam', 'estivesse', 'estivéssemos', 'estivessem', 'estiver', 'estivermos', 'estiverem', 'the', 'a', 'an', 'to', 'in', 'for', 'of', 'on', 'with', 'at', 'by', 'is', 'and', 'it', 'that', 'as', 'from', 'be']);
  }
  
  function generateWordFrequencyChart() {
    const allTitles = [];
    AppState.enabledFeeds.forEach(feedKey => {
        if (rssFeeds[feedKey].scope === AppState.newsScope) {
            const cacheKey = `${CACHE_KEY_PREFIX}${rssFeeds[feedKey].elementId}`;
            const cachedEntry = localStorage.getItem(cacheKey);
            if (cachedEntry) {
                try {
                    const { items } = JSON.parse(cachedEntry);
                    if (items && items.length > 0) items.forEach(item => allTitles.push(item.title));
                } catch(e) {}
            }
        }
    });

    const chartContainer = document.getElementById('chart-container');
    if (allTitles.length === 0) {
        chartContainer.style.display = 'none';
        return;
    }

    const stopWords = getStopWords();
    const wordCounts = {};
    
    allTitles.forEach(title => {
        const words = title.toLowerCase().replace(/[^a-z0-9áéíóúâêîôûãõçü\s-]/g, '').split(/\s+/);
        words.forEach(word => {
            if (word.length > 3 && !stopWords.has(word) && isNaN(word)) {
                wordCounts[word] = (wordCounts[word] || 0) + 1;
            }
        });
    });

    const sortedWords = Object.entries(wordCounts).sort(([,a],[,b]) => b - a).slice(0, 10);

    if (sortedWords.length < 3) {
        chartContainer.style.display = 'none';
        return;
    } else {
        chartContainer.style.display = 'block';
    }

    const ctx = document.getElementById('word-frequency-chart').getContext('2d');
    if (wordFrequencyChart) wordFrequencyChart.destroy();
    
    const isLight = document.body.classList.contains('light-mode');
    const gridColor = isLight ? 'rgba(0, 0, 0, 0.1)' : 'rgba(255, 255, 255, 0.1)';
    const textColor = isLight ? '#333' : '#c9d1d9';

    wordFrequencyChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: sortedWords.map(item => item[0]),
            datasets: [{
                label: 'Ocorrências', data: sortedWords.map(item => item[1]),
                backgroundColor: 'rgba(0, 209, 128, 0.7)', borderColor: 'rgba(0, 209, 128, 1)', borderWidth: 1
            }]
        },
        options: {
            responsive: true, indexAxis: 'y',
            plugins: { legend: { display: false }, tooltip: { backgroundColor: 'rgba(13, 17, 23, 0.8)' } },
            scales: {
                x: { beginAtZero: true, ticks: { color: textColor, stepSize: 1 }, grid: { color: gridColor } },
                y: { ticks: { color: textColor }, grid: { color: 'transparent' } }
            }
        }
    });
  }

  function generateAndShowBriefing() {
    const briefingList = document.getElementById('briefing-list');
    const briefingTitle = document.getElementById('briefing-title');
    if (!briefingList || !briefingTitle) return;
    
    briefingList.innerHTML = '';
    const scopeTitle = AppState.newsScope === 'local' ? 'Local' : 'Internacional';
    briefingTitle.textContent = `Briefing de Notícias: ${scopeTitle}`;
    let hasContent = false;

    AppState.enabledFeeds.forEach(feedKey => {
        const feedConfig = rssFeeds[feedKey];
        if (feedConfig.scope === AppState.newsScope) {
            const cachedEntry = localStorage.getItem(`${CACHE_KEY_PREFIX}${feedConfig.elementId}`);
            if (cachedEntry) {
                try {
                    const { items } = JSON.parse(cachedEntry);
                    if (items && items.length > 0) {
                        hasContent = true;
                        const sourceTitle = document.createElement('h3');
                        sourceTitle.className = 'briefing-source-title';
                        sourceTitle.textContent = feedConfig.displayName;
                        briefingList.appendChild(sourceTitle);

                        items.slice(0, 6).forEach(item => {
                            const li = document.createElement('li');
                            li.innerHTML = `<a href="${item.link}" target="_blank" rel="noopener noreferrer">${item.title}</a>
                                          <p class="briefing-item-description">${item.description}</p>
                                          ${item.pubDate ? `<span class="briefing-item-date">${new Date(item.pubDate).toLocaleString('pt-BR', {day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'})}</span>` : ''}`;
                            briefingList.appendChild(li);
                        });
                    }
                } catch(e) { console.warn(`Cache error for ${feedConfig.displayName}`, e); }
            }
        }
    });

    if (!hasContent) {
        briefingList.innerHTML = '<li>Nenhuma notícia carregada para gerar o briefing.</li>';
    }
    
    generateWordFrequencyChart();
    UI.toggleModal('briefing-modal', true);
  }
  
function setupNotifications() {
    const notificationsBtn = document.getElementById('notifications-btn');
    if (!notificationsBtn || !('Notification' in window)) {
        if (notificationsBtn) notificationsBtn.style.display = 'none';
        return;
    }

    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').then(registration => {
            console.log('ServiceWorker registration successful');
        }).catch(err => {
            console.log('ServiceWorker registration failed: ', err);
        });
    }

    const defaultNotificationSettings = {
        notifyUrgent: true,
        notifyUpdates: false,
        notifyMarket: false,
        notifyStart: '08:00',
        notifyEnd: '22:00'
    };

    const loadNotificationSettings = () => {
        const savedSettings = localStorage.getItem('notificationSettings');
        return savedSettings ? JSON.parse(savedSettings) : defaultNotificationSettings;
    };

    const saveNotificationSettings = (settings) => {
        localStorage.setItem('notificationSettings', JSON.stringify(settings));
    };

    const updateButtonState = () => {
        const settings = loadNotificationSettings();
        const permission = Notification.permission;
        
        let icon, label, title, activeClass = '';
        
        if (permission === 'granted') {
            icon = 'fa-bell';
            label = 'Notificações ativadas';
            title = 'Clique para configurar notificações';
            activeClass = 'active';
        } else if (permission === 'denied') {
            icon = 'fa-bell-slash';
            label = 'Notificações bloqueadas';
            title = 'Notificações bloqueadas - Altere nas configurações do navegador';
            activeClass = 'disabled';
        } else {
            icon = 'fa-bell';
            label = 'Ativar notificações';
            title = 'Clique para ativar notificações';
        }
        
        notificationsBtn.innerHTML = `<i class="fas ${icon}"></i>`;
        notificationsBtn.setAttribute('aria-label', label);
        notificationsBtn.title = title;
        notificationsBtn.className = `floating-btn ${activeClass}`;
    };

    const showNotificationSettings = () => {
        const settings = loadNotificationSettings();
        
        document.getElementById('notify-urgent').checked = settings.notifyUrgent;
        document.getElementById('notify-updates').checked = settings.notifyUpdates;
        document.getElementById('notify-market').checked = settings.notifyMarket;
        document.getElementById('notify-start').value = settings.notifyStart;
        document.getElementById('notify-end').value = settings.notifyEnd;
        
        UI.toggleModal('notifications-modal', true);
    };

    document.getElementById('notifications-save-btn')?.addEventListener('click', () => {
        const settings = {
            notifyUrgent: document.getElementById('notify-urgent').checked,
            notifyUpdates: document.getElementById('notify-updates').checked,
            notifyMarket: document.getElementById('notify-market').checked,
            notifyStart: document.getElementById('notify-start').value,
            notifyEnd: document.getElementById('notify-end').value
        };
        
        saveNotificationSettings(settings);
        UI.toggleModal('notifications-modal', false);
        UI.announceToScreenReader('Configurações de notificações salvas.');
    });

    UI.setupModal('notifications-modal', 'notifications-modal-close-btn');

    const addTooltip = (elementId, text) => {
        const element = document.getElementById(elementId);
        if (element) {
            const tooltip = document.createElement('span');
            tooltip.className = 'tooltip';
            tooltip.innerHTML = `<i class="fas fa-info-circle" style="color: var(--text-secondary);"></i>
                                <span class="tooltiptext">${text}</span>`;
            element.parentNode.insertBefore(tooltip, element.nextSibling);
        }
    };

    addTooltip('notify-urgent', 'Notificações serão enviadas para notícias marcadas como urgentes ou com alertas');
    addTooltip('notify-updates', 'Receba notificações para as principais atualizações de notícias');
    addTooltip('notify-market', 'Alertas sobre movimentos significativos em mercados financeiros');
    addTooltip('notify-start', 'Período do dia em que deseja receber notificações');

    notificationsBtn.addEventListener('click', async () => {
        const permission = Notification.permission;
        
        if (permission === 'denied') {
            UI.announceToScreenReader('Notificações bloqueadas. Você precisa alterar esta configuração manualmente nas configurações do navegador.');
            return;
        }
        
        if (permission === 'granted') {
            showNotificationSettings();
            return;
        }
        
        const confirmEnable = confirm('Deseja ativar notificações? Você receberá alertas para notícias importantes e atualizações do mercado. Pode configurar os tipos de notificações depois.');
        
        if (confirmEnable) {
            try {
                const permissionResult = await Notification.requestPermission();
                
                if (permissionResult === 'granted') {
                    new Notification('Terminal de Notícias', { 
                        body: 'Notificações ativadas com sucesso! Você receberá alertas importantes.',
                        icon: './favicon.ico'
                    });
                    
                    setTimeout(() => showNotificationSettings(), 1000);
                }
                
                updateButtonState();
            } catch (error) {
                console.error('Erro ao solicitar permissão:', error);
                UI.announceToScreenReader('Erro ao ativar notificações.');
            }
        }
    });

    updateButtonState();
}

  document.addEventListener('DOMContentLoaded', () => {
    AppState.init();
    
    const savedTheme = localStorage.getItem('themePreference');
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    if ((savedTheme === 'dark') || (!savedTheme && prefersDark)) {
        document.body.classList.remove('light-mode');
    } else {
        document.body.classList.add('light-mode');
    }
    
    UI.init();

    const themeIcon = document.querySelector('#theme-toggle i');
    const isLightMode = document.body.classList.contains('light-mode');
    if(themeIcon){ 
        themeIcon.classList.toggle('fa-moon', !isLightMode); 
        themeIcon.classList.toggle('fa-sun', isLightMode); 
    }
    
    UI.renderWidgets();
    initializeScopeToggle();
    setupNotifications(); 
    document.getElementById('refresh-btn')?.addEventListener('click', () => refreshAllFeeds(true));

    setInterval(() => refreshAllFeeds(false), 5 * 60 * 1000);
  });
</script>

</body>
</html>
