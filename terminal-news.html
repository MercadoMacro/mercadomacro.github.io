<!DOCTYPE html>
<html lang="pt-br">
<head>
     <script async src="https://www.googletagmanager.com/gtag/js?id=G-5JZRK5NNKG"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-5JZRK5NNKG');
</script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Terminal de Notícias - Mercado Macro</title>
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Courier+New&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
        --primary-color: #00d180;
        --primary-light: #5bffb0;
        --primary-dark: #009e53;
        --dark-bg: #0d1117;
        --darker-bg: #010409;
        --text-color: #c9d1d9;
        --text-secondary: rgba(139, 148, 158, 0.7);
        --card-bg-val: 22, 27, 34; /* Usado para rgba */
        --card-bg: rgba(var(--card-bg-val), 0.85);
        --border-color: rgba(48, 54, 61, 0.8);
        --error-color: #ff7b72;
        --transition-speed: 0.3s;
        --shadow-color-soft: rgba(0, 0, 0, 0.2);
        --shadow-color-medium: rgba(0, 0, 0, 0.3);
        --link-color: #58a6ff;
        --link-hover-color: #2f81f7;
        --crypto-accent-border: var(--primary-light);
        --finance-accent-border: var(--primary-color);
        /* Variáveis para Scrollbar */
        --scrollbar-size: 6px;
        --scrollbar-thumb-color: rgba(139, 148, 158, 0.3);
        --scrollbar-thumb-hover-color: rgba(139, 148, 158, 0.5);
        --scrollbar-track-color: transparent;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
        margin: 0; padding: 0;
        font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        background: linear-gradient(135deg, var(--darker-bg) 0%, var(--dark-bg) 100%);
        color: var(--text-color);
        min-height: 100vh; width: 100%;
        overflow-x: hidden;
        line-height: 1.7;
        transition: background var(--transition-speed) ease, color var(--transition-speed) ease;
        display: flex; flex-direction: column;
        position: relative;
        scrollbar-width: thin;
        scrollbar-color: var(--scrollbar-thumb-color) var(--scrollbar-track-color);
    }
    body:hover {
        scrollbar-color: var(--scrollbar-thumb-hover-color) var(--scrollbar-track-color);
    }

    ::-webkit-scrollbar {
        width: var(--scrollbar-size);
        height: var(--scrollbar-size);
    }
    ::-webkit-scrollbar-track {
        background: var(--scrollbar-track-color);
        border-radius: calc(var(--scrollbar-size) / 2);
    }
    ::-webkit-scrollbar-thumb {
        background-color: var(--scrollbar-thumb-color);
        border-radius: calc(var(--scrollbar-size) / 2);
        border: 1px solid var(--scrollbar-track-color);
    }
    ::-webkit-scrollbar-thumb:hover {
        background-color: var(--scrollbar-thumb-hover-color);
    }

    :focus { outline: 2px solid var(--primary-color); outline-offset: 2px; }
    :focus-visible { outline: 2px solid var(--primary-color); outline-offset: 2px; }

    .container {
        flex: 1; max-width: 1200px; width: 100%;
        margin: 0 auto; padding: 30px 20px;
        box-sizing: border-box; text-align: center;
        display: flex; flex-direction: column;
    }

    .logo { text-align: center; margin-bottom: 30px; }
    .page-title-header {
        font-size: 44px; font-weight: 800; line-height: 1.2; letter-spacing: -1px;
        color: var(--text-color);
        background: linear-gradient(120deg, var(--primary-light), var(--primary-color));
        -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        margin-bottom: 8px; padding: 0 10px;
    }
    .logo-divider {
        width: 80px; height: 4px;
        background: linear-gradient(to right, var(--primary-color), var(--primary-light));
        margin: 0 auto; border-radius: 3px;
    }
    .subheader {
        font-size: 16px; margin-bottom: 15px;
        color: var(--text-secondary); font-weight: 600;
        text-align: center;
    }

    .scope-toggle-container {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 25px;
        font-family: 'Montserrat', sans-serif;
        font-weight: 600;
        font-size: 0.9rem;
        user-select: none;
    }

    .scope-toggle-container span {
        padding: 0 10px;
        color: var(--text-secondary);
        cursor: pointer;
        transition: color 0.3s ease;
    }

    .scope-toggle-container span.active-scope {
        color: var(--primary-color);
        font-weight: 700;
    }

    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 26px;
        margin: 0 5px;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(var(--card-bg-val), 0.4);
        border: 1px solid var(--border-color);
        transition: .4s;
        border-radius: 26px;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: var(--text-secondary);
        transition: .4s;
        border-radius: 50%;
    }

    input:checked + .slider {
        background-color: var(--primary-color);
        border-color: var(--primary-dark);
    }

    input:checked + .slider:before {
        transform: translateX(24px);
        background-color: white;
    }
    
    input:focus + .slider {
        box-shadow: 0 0 0 2px var(--dark-bg), 0 0 0 4px var(--primary-color);
    }

    .news-grid-wrapper {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        grid-auto-rows: auto;
        gap: 20px;
        width: 100%;
    }

    .news-widget {
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 1rem;
      color: var(--text-color);
      position: relative;
      box-shadow: var(--shadow-color-soft);
      font-family: 'Courier New', Courier, monospace;
      display: flex;
      flex-direction: column;
      transition: opacity 0.3s ease, transform 0.3s ease;
    }
    .news-widget[style*="display: none"] {
        opacity: 0;
        transform: scale(0.95);
        pointer-events: none;
    }

    .crypto-widget { border-top: 3px solid var(--crypto-accent-border); }
    .finance-widget { border-top: 3px solid var(--finance-accent-border); }

    .refresh-widget {
      position: absolute; top: 10px; right: 10px;
      background: transparent; color: var(--text-secondary);
      border: none; cursor: pointer; font-size: 0.9rem;
      display: flex; align-items: center; gap: 4px;
      padding: 5px; border-radius: 4px;
      transition: color 0.2s ease, background-color 0.2s ease;
    }
    .refresh-widget:hover { color: var(--primary-color); background-color: rgba(var(--card-bg-val), 0.5); }
    
    .news-widget h3 {
      font-size: 1.1rem; color: var(--primary-color);
      margin-top: 0; margin-bottom: 0.75rem;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 0.75rem; display: flex; align-items: center;
      padding-right: 30px; font-family: 'Montserrat', sans-serif; font-weight: 600;
      flex-shrink: 0;
    }
    .news-widget h3 i { margin-right: 8px; }

    .news-list {
      list-style: none; padding: 0; margin: 0;
      flex-grow: 1;
      overflow-y: auto;
      max-height: 300px;
      scrollbar-width: thin;
      scrollbar-color: var(--scrollbar-thumb-color) var(--scrollbar-track-color);
    }
    .news-list:hover {
        scrollbar-color: var(--scrollbar-thumb-hover-color) var(--scrollbar-track-color);
    }

    .news-list li {
      margin: 0.6rem 0; border-left: 3px solid var(--primary-light);
      padding-left: 0.75rem; font-size: 0.9rem;
      display: flex; justify-content: space-between; align-items: center;
    }
    .news-list li i.fa-spinner { margin-right: 5px; color: var(--primary-color); animation: spin 1.5s linear infinite; }
     @keyframes spin { to { transform: rotate(360deg); } }
    .news-list li i.fa-exclamation-triangle, .news-list li i.fa-exclamation-circle, .news-list li i.fa-info-circle { margin-right: 5px; }
    .news-list li i.fa-exclamation-triangle, .news-list li i.fa-exclamation-circle { color: var(--error-color); }
    .news-list li i.fa-info-circle { color: var(--text-secondary); }

    .news-list a {
      text-decoration: none;
      color: var(--link-color);
      display: inline-block;
      transition: color 0.2s;
      overflow-wrap: break-word;
      word-break: break-word;
      margin-right: 10px; /* Espaço para o botão de partilha */
    }
    .news-list a:hover { color: var(--link-hover-color); }

    .timestamp {
      font-size: 0.75rem; color: var(--text-secondary);
      margin-top: 10px; text-align: right; font-style: italic;
      flex-shrink: 0;
    }

    /* MUDANÇA (CSS): Botões flutuantes agora são gerenciados por um contêiner flex. */
    .floating-btn-container {
        position: fixed;
        bottom: 20px;
        z-index: 1000;
        display: flex;
        gap: 10px;
    }

    .floating-btn-container.left {
        left: 20px;
    }

    .floating-btn-container.right {
        right: 20px;
    }
    
    .floating-btn {
        width: 50px; height: 50px; border-radius: 12px;
        background-color: var(--card-bg); color: var(--text-color); border: 1px solid var(--border-color);
        cursor: pointer; 
        display: flex; align-items: center; justify-content: center;
        transition: all 0.2s ease; backdrop-filter: blur(8px); box-shadow: 0 5px 15px var(--shadow-color-soft);
        -webkit-tap-highlight-color: transparent; will-change: transform, background-color;
    }
    .floating-btn:hover { background-color: var(--primary-color); transform: translateY(-4px) scale(1.05); color: var(--dark-bg); box-shadow: 0 8px 20px var(--shadow-color-medium); }
    .floating-btn:active { transform: translateY(0) scale(1); }
    .floating-btn i { font-size: 20px; }

    /* MUDANÇA (CSS): Regras individuais de posicionamento removidas. Apenas a lógica de visibilidade do #top-btn permanece. */
    #top-btn { opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
    #top-btn.visible { opacity: 1; visibility: visible; }
    
    footer { /* MUDANÇA (CSS): Seletor de .footer para footer */
        font-size: 13px; margin-top: 40px; text-align: center;
        color: var(--text-secondary); padding: 20px 0;
        border-top: 1px solid var(--border-color);
    }
    
    /* === INÍCIO: CSS DO BRIEFING === */
    .briefing-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 2000;
        display: flex;
        justify-content: center;
        align-items: center;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
        backdrop-filter: blur(5px);
    }
    .briefing-modal-overlay.visible {
        opacity: 1;
        visibility: visible;
    }
    .briefing-modal-content {
        background-color: var(--card-bg);
        color: var(--text-color);
        padding: 25px;
        border-radius: 10px;
        border: 1px solid var(--border-color);
        width: 90%;
        max-width: 700px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 10px 30px var(--shadow-color-medium);
        position: relative;
        font-family: 'Courier New', Courier, monospace;
    }
    .briefing-modal-content h2 {
        font-family: 'Montserrat', sans-serif;
        color: var(--primary-color);
        margin-top: 0;
        margin-bottom: 20px;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 15px;
    }
    .briefing-modal-content ul {
        list-style: none;
        padding: 0;
        text-align: left;
    }
    .briefing-modal-close {
        position: absolute;
        top: 15px;
        right: 20px;
        background: none;
        border: none;
        color: var(--text-secondary);
        font-size: 24px;
        cursor: pointer;
        transition: color 0.2s ease;
    }
    .briefing-modal-close:hover {
        color: var(--primary-color);
    }
    .briefing-modal-content li {
        margin-bottom: 20px;
        padding-left: 0;
        list-style-type: none;
    }
    .briefing-modal-content li::before {
        content: none;
    }
    .briefing-source-title {
        font-family: 'Montserrat', sans-serif;
        color: var(--primary-light);
        font-size: 1.2rem;
        margin-top: 25px;
        margin-bottom: 15px;
        padding-bottom: 5px;
        border-bottom: 2px solid var(--primary-dark);
    }
    .briefing-modal-content ul > h3:first-of-type {
        margin-top: 5px;
    }
    .briefing-modal-content li a {
        font-size: 1rem;
        font-weight: bold;
        color: var(--link-color);
        text-decoration: none;
    }
    .briefing-modal-content li a:hover {
        color: var(--link-hover-color);
        text-decoration: underline;
    }
    .briefing-item-description {
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-top: 5px;
        margin-bottom: 8px;
        line-height: 1.5;
    }
    .briefing-item-date {
        font-size: 0.75rem;
        color: var(--primary-color);
        font-style: italic;
        opacity: 0.8;
    }
    
    /* NOVO: Estilo para o container do gráfico */
    #chart-container {
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid var(--border-color);
    }
     #chart-container h3 {
        font-family: 'Montserrat', sans-serif;
        color: var(--primary-light);
        font-size: 1.2rem;
        margin-bottom: 15px;
    }

    /* === FIM: CSS DO BRIEFING === */

    body.light-mode {
        --primary-color: #007aff; --primary-light: #53a6ff; --primary-dark: #0056b3;
        --dark-bg: #ffffff; --darker-bg: #f0f2f5;
        --text-color: #1c1e21; --text-secondary: rgba(51, 51, 51, 0.75);
        --card-bg: rgba(255, 255, 255, 0.98); --border-color: rgba(200, 205, 210, 0.7);
        --card-bg-val: 248, 249, 250;
        --error-color: #dc3545;
        --shadow-color-soft: rgba(0, 0, 0, 0.08); --shadow-color-medium: rgba(0, 0, 0, 0.12);
        --link-color: #0056b3; --link-hover-color: #004085;
        --crypto-accent-border: var(--primary-light);
        --finance-accent-border: var(--primary-color);
        --scrollbar-thumb-color: rgba(51, 51, 51, 0.4);
        --scrollbar-thumb-hover-color: rgba(51, 51, 51, 0.6);
        background: linear-gradient(135deg, var(--darker-bg) 0%, var(--dark-bg) 100%);
    }
    body.light-mode .page-title-header { background: linear-gradient(120deg, var(--primary-dark), var(--primary-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    body.light-mode .logo-divider { background: linear-gradient(to right, var(--primary-color), var(--primary-light));}
    body.light-mode .floating-btn { background-color: var(--card-bg); color: var(--text-color); border: 1px solid var(--border-color); }
    body.light-mode .floating-btn:hover { background-color: var(--primary-color); color: white; }
    body.light-mode .theme-toggle i { color: var(--text-color); }
    body.light-mode .theme-toggle:hover i { color: white; }
    body.light-mode .news-widget { background-color: #fff; border: 1px solid var(--border-color); box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); }
    body.light-mode .news-widget h3 { color: var(--primary-color); border-bottom-color: var(--border-color); }
    body.light-mode .refresh-widget { color: var(--text-secondary); }
    body.light-mode .refresh-widget:hover { color: var(--primary-color); background-color: rgba(var(--card-bg-val), 0.8); }
    body.light-mode .news-list li { border-left-color: var(--primary-light); }
    body.light-mode .news-list a { color: var(--link-color); }
    body.light-mode .news-list a:hover { color: var(--link-hover-color); }
    body.light-mode .timestamp { color: var(--text-secondary); }
    body.light-mode .news-list li i.fa-spinner { color: var(--primary-color); }
    body.light-mode .news-list li i.fa-exclamation-triangle, body.light-mode .news-list li i.fa-info-circle { color: var(--text-secondary); }
    body.light-mode .news-list li i.fa-exclamation-triangle { color: var(--error-color); }
    
    /* === INÍCIO: CÓDIGO ADICIONADO PARA MELHORIAS === */
    .search-container {
        margin-bottom: 25px;
        padding: 0 10px;
    }
    .search-bar {
        width: 100%;
        max-width: 500px;
        padding: 10px 15px;
        border-radius: 6px;
        border: 1px solid var(--border-color);
        background-color: var(--card-bg);
        color: var(--text-color);
        font-size: 1rem;
        font-family: 'Montserrat', sans-serif;
        transition: border-color 0.3s, box-shadow 0.3s;
    }
    .search-bar:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(var(--primary-color), 0.3);
        outline: none;
    }

    .share-btn {
        background: none; border: none;
        color: var(--text-secondary); cursor: pointer;
        font-size: 1rem; padding: 5px;
        transition: color 0.2s ease;
        flex-shrink: 0;
    }
    .share-btn:hover { color: var(--primary-color); }

    .retry-btn {
        background: var(--primary-dark);
        color: #fff;
        border: none;
        padding: 5px 10px;
        font-size: 0.8rem;
        border-radius: 4px;
        cursor: pointer;
        margin-left: auto;
        transition: background-color 0.2s;
    }
    .retry-btn:hover { background-color: var(--primary-color); }

    /* MUDANÇA (CSS): Estilo para a mensagem de "nenhum resultado" da busca */
    .no-search-results {
        color: var(--text-secondary);
        font-style: italic;
        padding: 10px;
        text-align: center;
        width: 100%;
        display: block;
        border-left: none;
    }

    .skeleton {
        height: 1em;
        border-radius: 4px;
        background: linear-gradient(90deg, rgba(139, 148, 158, 0.1), rgba(139, 148, 158, 0.2), rgba(139, 148, 158, 0.1));
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite linear;
    }
    .skeleton.w-75 { width: 75%; }
    .skeleton.w-50 { width: 50%; }
    @keyframes shimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }

    .visually-hidden {
      position: absolute;
      width: 1px; height: 1px;
      padding: 0; margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      border: 0;
    }
    /* === FIM: CÓDIGO ADICIONADO PARA MELHORIAS === */

    @media (max-width: 768px) {
        .container { padding: 20px 15px; }
        .page-title-header { font-size: 36px; }
        .news-grid-wrapper { grid-template-columns: 1fr; padding-bottom: 80px; }
        /* MUDANÇA (CSS): Media query simplificada para os botões */
        .floating-btn-container {
            gap: 8px;
        }
        .floating-btn-container.left { left: 15px; }
        .floating-btn-container.right { right: 15px; }
        .floating-btn { width: 45px; height: 45px; border-radius: 10px; }
    }
    @media (max-width: 480px) {
        .page-title-header { font-size: 30px; }
        /* MUDANÇA (CSS): Media query simplificada para os botões */
        .floating-btn-container.left { left: 10px; }
        .floating-btn-container.right { right: 10px; }
        .floating-btn { width: 40px; height: 40px; }
    }
  </style>
</head>
<body>

<div id="aria-live-announcer" class="visually-hidden" role="status" aria-live="polite"></div>

<div class="container">
    <header>
        <div class="logo">
            <h1 class="page-title-header">Terminal de Notícias</h1>
            <div class="logo-divider"></div>
        </div>
        <p class="subheader">Fontes de Notícias sobre Criptomoedas e Finanças Globais</p>
    </header>

    <div class="scope-toggle-container">
        <span id="scope-label-international">Internacional</span>
        <label class="toggle-switch">
            <input type="checkbox" id="news-scope-toggle">
            <span class="slider"></span>
        </label>
        <span id="scope-label-local">Local</span>
    </div>
    
    <div class="search-container">
        <input type="search" id="search-bar" class="search-bar" placeholder="Buscar em todas as notícias...">
    </div>

    <div class="news-grid-wrapper">
        <article class="news-widget crypto-widget">
          <button class="refresh-widget" data-feedkey="guiadobitcoin" aria-label="Atualizar Zero Hedge">
            <i class="fas fa-sync-alt"></i>
          </button>
          <h3><i class="fas fa-newspaper"></i> Zero Hedge</h3>
          <ul class="news-list" id="zerohedge-news"></ul>
          <div class="timestamp" id="zerohedge-timestamp"></div>
        </article>
        <article class="news-widget crypto-widget">
          <button class="refresh-widget" data-feedkey="noticiabrasil" aria-label="Atualizar Notícia Brasil">
            <i class="fas fa-sync-alt"></i>
          </button>
          <h3><i class="fas fa-globe-americas"></i> Notícia Brasil</h3>
          <ul class="news-list" id="noticiabrasil-news"></ul>
          <div class="timestamp" id="noticiabrasil-timestamp"></div>
        </article>
        <article class="news-widget crypto-widget">
          <button class="refresh-widget" data-feedkey="cointelegraph" aria-label="Atualizar Cointelegraph">
            <i class="fas fa-sync-alt"></i>
          </button>
          <h3><i class="fab fa-bitcoin"></i> Cointelegraph BR</h3>
          <ul class="news-list" id="cointelegraph-news"></ul>
          <div class="timestamp" id="cointelegraph-timestamp"></div>
        </article>
        <article class="news-widget finance-widget">
          <button class="refresh-widget" data-feedkey="advfn" aria-label="Atualizar ADVFN">
            <i class="fas fa-sync-alt"></i>
          </button>
          <h3><i class="fas fa-newspaper"></i> ADVFN BR</h3>
          <ul class="news-list" id="advfn-news"></ul>
          <div class="timestamp" id="advfn-timestamp"></div>
        </article>
        <article class="news-widget finance-widget">
          <button class="refresh-widget" data-feedkey="investing" aria-label="Atualizar Investing">
            <i class="fas fa-sync-alt"></i>
          </button>
          <h3><i class="fas fa-chart-line"></i> Investing.com BR</h3>
          <ul class="news-list" id="investing-news"></ul>
          <div class="timestamp" id="investing-timestamp"></div>
        </article>
        <article class="news-widget finance-widget">
          <button class="refresh-widget" data-feedkey="infomoney" aria-label="Atualizar InfoMoney">
            <i class="fas fa-sync-alt"></i>
          </button>
          <h3><i class="fas fa-money-bill-wave"></i> InfoMoney</h3>
          <ul class="news-list" id="infomoney-news"></ul>
          <div class="timestamp" id="infomoney-timestamp"></div>
        </article>
        <article class="news-widget finance-widget">
          <button class="refresh-widget" data-feedkey="valor" aria-label="Atualizar Valor Econômico">
            <i class="fas fa-sync-alt"></i>
          </button>
          <h3><i class="fas fa-landmark"></i> Valor Econômico</h3>
          <ul class="news-list" id="valor-news"></ul>
          <div class="timestamp" id="valor-timestamp"></div>
        </article>
        <article class="news-widget finance-widget">
          <button class="refresh-widget" data-feedkey="dukascopy" aria-label="Atualizar Dukascopy">
            <i class="fas fa-sync-alt"></i>
          </button>
          <h3><i class="fas fa-globe-europe"></i> Dukascopy</h3>
          <ul class="news-list" id="dukascopy-news"></ul>
          <div class="timestamp" id="dukascopy-timestamp"></div>
        </article>
        <article class="news-widget finance-widget">
          <button class="refresh-widget" data-feedkey="forexlive" aria-label="Atualizar ForexLive">
            <i class="fas fa-sync-alt"></i>
          </button>
          <h3><i class="fas fa-dollar-sign"></i> ForexLive</h3>
          <ul class="news-list" id="forexlive-news"></ul>
          <div class="timestamp" id="forexlive-timestamp"></div>
        </article>
        <article class="news-widget finance-widget">
          <button class="refresh-widget" data-feedkey="fxmarkets" aria-label="Atualizar FX Markets">
            <i class="fas fa-sync-alt"></i>
          </button>
          <h3><i class="fas fa-exchange-alt"></i> FX Markets</h3>
          <ul class="news-list" id="fxmarkets-news"></ul>
          <div class="timestamp" id="fxmarkets-timestamp"></div>
        </article>
        <article class="news-widget finance-widget">
          <button class="refresh-widget" data-feedkey="fxstreet" aria-label="Atualizar FXStreet">
            <i class="fas fa-sync-alt"></i>
          </button>
          <h3><i class="fas fa-road"></i> FXStreet</h3>
          <ul class="news-list" id="fxstreet-news"></ul>
          <div class="timestamp" id="fxstreet-timestamp"></div>
        </article>
        <article class="news-widget finance-widget">
          <button class="refresh-widget" data-feedkey="ing" aria-label="Atualizar ING Think">
            <i class="fas fa-sync-alt"></i>
          </button>
          <h3><i class="fas fa-lightbulb"></i> ING Think</h3>
          <ul class="news-list" id="ing-news"></ul>
          <div class="timestamp" id="ing-timestamp"></div>
        </article>
    </div>
    <footer>© <span id="current-year"></span> Mercado Macro</footer>
</div>

<div class="floating-btn-container left">
    <button class="theme-toggle floating-btn" id="theme-toggle" aria-label="Alternar tema claro/escuro">
        <i class="fas fa-moon"></i>
    </button>
    <button class="floating-btn" id="notifications-btn" aria-label="Ativar notificações">
        <i class="fas fa-bell"></i>
    </button>
</div>

<div class="floating-btn-container right">
    <button id="briefing-btn" class="floating-btn" aria-label="Gerar Briefing das Notícias">
        <i class="fas fa-clipboard-list"></i>
    </button>
    <button id="top-btn" class="floating-btn" aria-label="Voltar ao topo">
        <i class="fas fa-arrow-up"></i>
    </button>
    <button id="home-btn" class="floating-btn" aria-label="Página inicial">
        <i class="fas fa-home"></i>
    </button>
    <button id="refresh-btn" class="floating-btn" aria-label="Atualizar tudo">
        <i class="fas fa-sync-alt"></i>
    </button>
</div>

<div id="briefing-modal" class="briefing-modal-overlay" role="dialog" aria-modal="true" aria-labelledby="briefing-title">
    <div class="briefing-modal-content">
        <button id="briefing-modal-close-btn" class="briefing-modal-close" aria-label="Fechar">&times;</button>
        <h2 id="briefing-title">Briefing de Notícias</h2>
        <ul id="briefing-list">
        </ul>
        <div id="chart-container" style="display: none;">
            <h3>Termos Frequentes nas Manchetes</h3>
            <canvas id="word-frequency-chart"></canvas>
        </div>
    </div>
</div>

<script>
  // Variáveis Globais
  const CACHE_KEY_PREFIX = 'terminalNewsCacheV5_';
  const CACHE_TTL = 15 * 60 * 1000;
  const FETCH_TIMEOUT = 15000;

  const PROXY_SERVICES = [
    { name: 'allorigins', url: (targetUrl) => `https://api.allorigins.win/raw?url=${encodeURIComponent(targetUrl)}` },
    { name: 'codetabs', url: (targetUrl) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(targetUrl)}` }
  ];
  let globalLastUsedProxySuccessIndex = 0;

  const NEWS_SCOPE_KEY = 'terminalNewsScope_v1';
  let currentNewsScope = 'local';

  // NOVO: Variável para controlar o gráfico
  let wordFrequencyChart = null;

  const rssFeeds = {
    guiadobitcoin: { url: 'https://cms.zerohedge.com/fullrss2.xml', elementId: 'zerohedge-news', timestampId: 'zerohedge-timestamp', category: 'crypto', displayName: 'Zero Hedge', scope: 'international'},
    noticiabrasil: { url: 'https://noticiabrasil.net.br/export/rss2/archive/index.xml', elementId: 'noticiabrasil-news', timestampId: 'noticiabrasil-timestamp', category: 'crypto', displayName: 'Notícia Brasil', scope: 'local'},
    cointelegraph: { url: 'https://br.cointelegraph.com/rss/tag/bitcoin', elementId: 'cointelegraph-news', timestampId: 'cointelegraph-timestamp', category: 'crypto', displayName: 'Cointelegraph BR', scope: 'local'},
    advfn: { url: 'https://br.advfn.com/common/news/feeds/paperbr/rss', elementId: 'advfn-news', timestampId: 'advfn-timestamp', category: 'finance', displayName: 'ADVFN BR', scope: 'local'},
    investing: { url: 'https://br.investing.com/rss/news.rss', elementId: 'investing-news', timestampId: 'investing-timestamp', category: 'finance', displayName: 'Investing.com BR', scope: 'local'},
    infomoney: { url: 'https://www.infomoney.com.br/feed/', elementId: 'infomoney-news', timestampId: 'infomoney-timestamp', category: 'finance', displayName: 'InfoMoney', scope: 'local'},
    valor: { url: 'https://www.valor.com.br/rss', elementId: 'valor-news', timestampId: 'valor-timestamp', category: 'finance', displayName: 'Valor Econômico', scope: 'local'},
    dukascopy: { url: 'https://www.dukascopy.com/fxspider/pt/rss/news_sector/finance/', elementId: 'dukascopy-news', timestampId: 'dukascopy-timestamp', category: 'finance', displayName: 'Dukascopy', scope: 'international'},
    forexlive: { url: 'https://www.forexlive.com/feed', elementId: 'forexlive-news', timestampId: 'forexlive-timestamp', category: 'finance', displayName: 'ForexLive', scope: 'international'},
    fxmarkets: { url: 'https://www.fx-markets.com/feeds/rss', elementId: 'fxmarkets-news', timestampId: 'fxmarkets-timestamp', category: 'finance', displayName: 'FX Markets', scope: 'international'},
    fxstreet: { url: 'https://www.fxstreet.com/rss/news', elementId: 'fxstreet-news', timestampId: 'fxstreet-timestamp', category: 'finance', displayName: 'FXStreet', scope: 'international'},
    ing: { url: 'https://rss.app/feeds/9lbwhwyNi8qv0X5h.xml', elementId: 'ing-news', timestampId: 'ing-timestamp', category: 'finance', displayName: 'ING Think', scope: 'international'}
  };
  
  function announceToScreenReader(message) {
    const announcer = document.getElementById('aria-live-announcer');
    if (announcer) {
        announcer.textContent = message;
    }
  }

  function formatTimeSince(timestamp) {
    if (!timestamp) return 'desconhecido';
    const now = new Date();
    const secondsPast = (now.getTime() - new Date(timestamp).getTime()) / 1000;
    if (secondsPast < 5) return 'agora mesmo';
    if (secondsPast < 60) return `há ${Math.round(secondsPast)} seg`;
    if (secondsPast < 3600) { const m = Math.round(secondsPast / 60); return `há ${m} min${m > 1 ? 's' : ''}`; }
    if (secondsPast <= 43200) { const h = Math.round(secondsPast / 3600); return `há ${h} hora${h > 1 ? 's' : ''}`; }
    const date = new Date(timestamp);
    return `em ${date.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'})} às ${date.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})}`;
  }

  function showSkeleton(listElement) {
      if (!listElement) return;
      let skeletonHTML = '';
      for (let i = 0; i < 5; i++) {
          const widthClass = i % 2 === 0 ? 'w-75' : 'w-50';
          skeletonHTML += `<li><div class="skeleton ${widthClass}"></div></li>`;
      }
      listElement.innerHTML = skeletonHTML;
  }
  
  function renderNews(listElement, timestampId, items, feedName, updateTime) {
    listElement.innerHTML = '';
    const itemsToShow = items.slice(0, 6);
    const supportsShare = 'share' in navigator;
    const fragment = document.createDocumentFragment();

    if (itemsToShow.length === 0) {
      const li = document.createElement('li');
      li.innerHTML = `<i class="fas fa-exclamation-circle"></i> Nenhuma notícia encontrada em ${feedName || 'esta fonte'}.`;
      fragment.appendChild(li);
    } else {
      itemsToShow.forEach(item => {
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = item.link || '#';
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.setAttribute('title', item.title);
        a.textContent = item.title;
        
        const wrapper = document.createElement('div');
        wrapper.style.display = 'flex';
        wrapper.style.alignItems = 'center';
        wrapper.style.width = '100%';
        wrapper.appendChild(a);

        if (supportsShare) {
            const shareBtn = document.createElement('button');
            shareBtn.className = 'share-btn';
            shareBtn.setAttribute('aria-label', `Partilhar notícia: ${item.title}`);
            shareBtn.innerHTML = '<i class="fas fa-share-alt"></i>';
            shareBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                try {
                    await navigator.share({
                        title: item.title,
                        text: `Notícia de ${feedName}: ${item.title}`,
                        url: item.link
                    });
                } catch (err) {
                    console.error('Erro ao partilhar:', err);
                }
            });
            wrapper.appendChild(shareBtn);
        }

        li.appendChild(wrapper);
        fragment.appendChild(li);
      });
    }

    listElement.appendChild(fragment); 
    const timestampEl = document.getElementById(timestampId);
    if (timestampEl) timestampEl.textContent = `Atualizado ${formatTimeSince(updateTime)}`;
    
    handleSearch();
  }
  
  // NOVO: Função para exibir notificação no desktop
  function showDesktopNotification(title, options) {
    if ('Notification' in window && Notification.permission === 'granted') {
        // Para garantir que a notificação possa ser clicada, mesmo em service workers no futuro
        const notification = new Notification(title, options);
        notification.onclick = () => {
             window.open(options.data.url, '_blank');
        };
    }
  }

  async function loadNews(feedKey, forceRefresh = false) {
    const feedConfig = rssFeeds[feedKey];
    if (!feedConfig) {
      console.error(`Config do feed '${feedKey}' não encontrada.`);
      return;
    }
    const list = document.getElementById(feedConfig.elementId);
    const timestampEl = document.getElementById(feedConfig.timestampId);
    const widgetElement = list?.closest('.news-widget');

    if (list && widgetElement && widgetElement.style.display !== 'none') {
        showSkeleton(list);
    }

    const cacheKey = `${CACHE_KEY_PREFIX}${feedConfig.elementId}`;
    const cachedEntry = localStorage.getItem(cacheKey);

    if (!forceRefresh && cachedEntry) {
      try {
        const { items, timestamp } = JSON.parse(cachedEntry);
        if ((Date.now() - timestamp) < CACHE_TTL) {
          if (list && timestampEl && widgetElement && widgetElement.style.display !== 'none') {
               renderNews(list, feedConfig.timestampId, items, feedConfig.displayName, timestamp);
          }
          return;
        }
      } catch (e) {
        console.warn("Cache inválido para " + feedKey, e);
        localStorage.removeItem(cacheKey);
      }
    }
    
    // MUDANÇA (JS): Guarda o título da notícia mais recente do cache antigo
    let latestOldTitle = null;
    if (cachedEntry) {
        try {
            latestOldTitle = JSON.parse(cachedEntry).items[0]?.title;
        } catch (e) { /* ignora erro de cache antigo */ }
    }
    
    if (forceRefresh) {
      localStorage.removeItem(cacheKey);
    }

    let success = false;
    let currentAttemptProxyIndex = globalLastUsedProxySuccessIndex;

    for (let i = 0; i < PROXY_SERVICES.length; i++) {
        const proxyToTry = PROXY_SERVICES[currentAttemptProxyIndex];
        try {
            const proxyUrl = proxyToTry.url(feedConfig.url);
            const response = await fetch(proxyUrl, { signal: AbortSignal.timeout(FETCH_TIMEOUT) });
            if (!response.ok) throw new Error(`Proxy ${proxyToTry.name} retornou status ${response.status}`);
            
            const xmlText = await response.text();
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, "text/xml");
            if (xmlDoc.getElementsByTagName("parsererror").length > 0) throw new Error(`Erro de parsing XML`);
            
            const itemsXml = xmlDoc.getElementsByTagName("item");
            const fetchedItems = Array.from(itemsXml).map(itemNode => {
                let title = itemNode.querySelector("title")?.textContent || "Sem título";
                title = title.replace(/^<!\[CDATA\[(.*)\]\]>$/, '$1').trim();
                let description = itemNode.querySelector("description")?.textContent || "";
                description = description.replace(/<[^>]*>?/gm, '').trim().substring(0, 150) + '...';
                return { title, link: itemNode.querySelector("link")?.textContent.trim() || "#", description, pubDate: itemNode.querySelector("pubDate")?.textContent || null };
            });

            if (fetchedItems.length === 0 && !xmlText.toLowerCase().includes("<item>")) {
                 throw new Error(`Resposta vazia ou inválida do proxy ${proxyToTry.name}`);
            }
            const updateTime = Date.now();
            localStorage.setItem(cacheKey, JSON.stringify({ items: fetchedItems, timestamp: updateTime }));

            if (list && timestampEl && widgetElement && widgetElement.style.display !== 'none') {
                renderNews(list, feedConfig.timestampId, fetchedItems, feedConfig.displayName, updateTime);
            }

            // MUDANÇA (JS): Lógica para disparar a notificação
            if (fetchedItems.length > 0 && fetchedItems[0].title !== latestOldTitle) {
                // Exemplo simples: notifica se o título contém "urgente" ou "alerta"
                const titleLower = fetchedItems[0].title.toLowerCase();
                if (titleLower.includes('urgente') || titleLower.includes('alerta')) {
                    showDesktopNotification(`Alerta de ${feedConfig.displayName}!`, {
                        body: fetchedItems[0].title,
                        icon: './favicon.ico', // Opcional: adicione um ícone
                        data: { url: fetchedItems[0].link }
                    });
                }
            }

            success = true;
            globalLastUsedProxySuccessIndex = currentAttemptProxyIndex;
            break;
        } catch (error) {
            console.warn(`Falha com proxy ${proxyToTry.name} para ${feedConfig.displayName}:`, error.message);
            currentAttemptProxyIndex = (currentAttemptProxyIndex + 1) % PROXY_SERVICES.length;
        }
    }

    if (!success) {
        console.error(`Todas as tentativas de proxy falharam para ${feedConfig.displayName}`);
        let showedSomething = false;
        if (cachedEntry) {
            try {
                const { items, timestamp } = JSON.parse(cachedEntry);
                if (list && timestampEl && widgetElement && widgetElement.style.display !== 'none') {
                    renderNews(list, feedConfig.timestampId, items, feedConfig.displayName, timestamp);
                    const warningMsg = document.createElement('li');
                    warningMsg.style.cssText = 'font-size:0.8em; opacity:0.8; margin-top:5px;';
                    warningMsg.innerHTML = `<i class="fas fa-info-circle"></i> Dados do cache (falha ao atualizar).`;
                    list.appendChild(warningMsg);
                    showedSomething = true;
                }
            } catch (e) { localStorage.removeItem(cacheKey); }
        }

        if (!showedSomething && list && widgetElement && widgetElement.style.display !== 'none') {
            const errorLi = document.createElement('li');
            errorLi.innerHTML = `<span><i class="fas fa-exclamation-triangle"></i> Falha ao carregar.</span><button class="retry-btn" data-feedkey="${feedKey}">Tentar Novamente</button>`;
            list.innerHTML = '';
            list.appendChild(errorLi);
            list.querySelector('.retry-btn').addEventListener('click', function() { loadNews(this.dataset.feedkey, true); });
            if (timestampEl) timestampEl.textContent = "Falha na atualização";
        }
    }
  }

  function updateWidgetVisibility() {
    Object.keys(rssFeeds).forEach(feedKey => {
        const feedConfig = rssFeeds[feedKey];
        const widgetElement = document.getElementById(feedConfig.elementId)?.closest('.news-widget');
        if (widgetElement) {
            if (feedConfig.scope === currentNewsScope) {
                widgetElement.style.display = '';
                const listElement = document.getElementById(feedConfig.elementId);
                if (listElement && listElement.children.length === 0) {
                    loadNews(feedKey, false);
                }
            } else {
                widgetElement.style.display = 'none';
            }
        }
    });
  }

  function handleScopeChange() {
    const toggle = document.getElementById('news-scope-toggle');
    currentNewsScope = toggle.checked ? 'international' : 'local';
    localStorage.setItem(NEWS_SCOPE_KEY, currentNewsScope);
    document.getElementById('scope-label-local').classList.toggle('active-scope', currentNewsScope === 'local');
    document.getElementById('scope-label-international').classList.toggle('active-scope', currentNewsScope === 'international');
    updateWidgetVisibility();
  }

  function initializeScopeToggle() {
    const savedScope = localStorage.getItem(NEWS_SCOPE_KEY);
    const toggle = document.getElementById('news-scope-toggle');
    const localLabel = document.getElementById('scope-label-local');
    const internationalLabel = document.getElementById('scope-label-international');
    currentNewsScope = (savedScope === 'international') ? 'international' : 'local';
    localStorage.setItem(NEWS_SCOPE_KEY, currentNewsScope);

    toggle.checked = (currentNewsScope === 'international');
    localLabel.classList.toggle('active-scope', currentNewsScope === 'local');
    internationalLabel.classList.toggle('active-scope', currentNewsScope === 'international');
    updateWidgetVisibility();

    toggle.addEventListener('change', handleScopeChange);
    localLabel.addEventListener('click', () => { if (currentNewsScope !== 'local') { toggle.checked = false; handleScopeChange(); } });
    internationalLabel.addEventListener('click', () => { if (currentNewsScope !== 'international') { toggle.checked = true; handleScopeChange(); } });
  }

  function refreshAllFeeds(force = true) {
    const refreshBtnGlobal = document.getElementById('refresh-btn');
    if(refreshBtnGlobal && force) {
      refreshBtnGlobal.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
      refreshBtnGlobal.disabled = true;
      announceToScreenReader("Atualizando notícias...");
    }
    if (force) {
        Object.keys(rssFeeds).forEach(feedKey => {
            if (rssFeeds[feedKey].scope === currentNewsScope) {
                localStorage.removeItem(`${CACHE_KEY_PREFIX}${rssFeeds[feedKey].elementId}`);
            }
        });
    }
    const feedsToLoad = Object.keys(rssFeeds).filter(feedKey => rssFeeds[feedKey].scope === currentNewsScope);
    feedsToLoad.forEach(feedKey => {
        const list = document.getElementById(rssFeeds[feedKey].elementId);
        const widgetElement = list?.closest('.news-widget');
        if (list && widgetElement && widgetElement.style.display !== 'none') showSkeleton(list);
    });
    const promises = feedsToLoad.map(feedKey => loadNews(feedKey, force));
    Promise.allSettled(promises).finally(() => {
      if(refreshBtnGlobal && force) {
        setTimeout(() => { refreshBtnGlobal.innerHTML = '<i class="fas fa-sync-alt"></i>'; refreshBtnGlobal.disabled = false; announceToScreenReader("Notícias atualizadas."); }, 1000);
      }
    });
  }

  function toggleTheme() {
    document.body.classList.toggle('light-mode');
    const isLightMode = document.body.classList.contains('light-mode');
    localStorage.setItem('themePreference', isLightMode ? 'light' : 'dark');
    const themeIcon = document.querySelector('#theme-toggle i');
    if(themeIcon){
        themeIcon.classList.toggle('fa-moon', !isLightMode);
        themeIcon.classList.toggle('fa-sun', isLightMode);
    }
    announceToScreenReader(`Tema alterado para modo ${isLightMode ? 'claro' : 'escuro'}.`);
    // MUDANÇA: recria o gráfico se estiver visível, para se adaptar ao novo tema
    if (document.getElementById('briefing-modal').classList.contains('visible')) {
        generateWordFrequencyChart();
    }
  }

  function setupBackToTop() {
    const backToTopButton = document.getElementById('top-btn');
    if (!backToTopButton) return;
    window.addEventListener('scroll', () => backToTopButton.classList.toggle('visible', window.pageYOffset > 300));
    backToTopButton.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
  }

  function updateFooterYear() {
      const yearSpan = document.getElementById('current-year');
      if (yearSpan) yearSpan.textContent = new Date().getFullYear();
  }

  let focusTrapHandler = null;
  let elementThatOpenedModal = null;

  function setupFocusTrap(modalElement) {
      const focusableElements = modalElement.querySelectorAll('a[href], button:not([disabled]), textarea, input, select');
      const firstElement = focusableElements[0];
      const lastElement = focusableElements[focusableElements.length - 1];
      focusTrapHandler = function(e) {
          if (e.key !== 'Tab') return;
          if (e.shiftKey) { if (document.activeElement === firstElement) { lastElement.focus(); e.preventDefault(); } } 
          else { if (document.activeElement === lastElement) { firstElement.focus(); e.preventDefault(); } }
      };
      modalElement.addEventListener('keydown', focusTrapHandler);
      if(firstElement) firstElement.focus();
  }
  
  function removeFocusTrap(modalElement) {
      modalElement.removeEventListener('keydown', focusTrapHandler);
      if(elementThatOpenedModal) elementThatOpenedModal.focus();
  }
  
  // NOVO: Função que retorna palavras comuns a serem ignoradas no gráfico.
  function getStopWords() {
      // Lista de palavras comuns em português e inglês para serem ignoradas.
      return new Set(['de', 'a', 'o', 'que', 'e', 'do', 'da', 'em', 'um', 'para', 'é', 'com', 'não', 'uma', 'os', 'no', 'na', 'por', 'mais', 'as', 'dos', 'como', 'mas', 'foi', 'ao', 'ele', 'das', 'tem', 'à', 'seu', 'sua', 'ou', 'ser', 'quando', 'muito', 'há', 'nos', 'já', 'está', 'eu', 'também', 'só', 'pelo', 'pela', 'até', 'isso', 'ela', 'entre', 'depois', 'sem', 'mesmo', 'aos', 'ter', 'seus', 'quem', 'nas', 'me', 'esse', 'eles', 'estão', 'você', 'tinha', 'foram', 'essa', 'num', 'nem', 'suas', 'meu', 'às', 'minha', 'numa', 'pelos', 'elas', 'havia', 'seja', 'qual', 'será', 'nós', 'tenho', 'lhe', 'deles', 'essas', 'esses', 'pelas', 'este', 'fosse', 'dele', 'tu', 'te', 'vocês', 'vos', 'lhes', 'meus', 'minhas', 'teu', 'tua', 'teus', 'tuas', 'nosso', 'nossa', 'nossos', 'nossas', 'dela', 'delas', 'esta', 'estes', 'aquele', 'aquela', 'aqueles', 'aquelas', 'isto', 'aquilo', 'estou', 'está', 'estamos', 'estão', 'estive', 'esteve', 'estivemos', 'estiveram', 'estava', 'estávamos', 'estavam', 'estivera', 'estivéramos', 'esteja', 'estejamos', 'estejam', 'estivesse', 'estivéssemos', 'estivessem', 'estiver', 'estivermos', 'estiverem', 'the', 'a', 'an', 'to', 'in', 'for', 'of', 'on', 'with', 'at', 'by', 'is', 'and', 'it', 'that', 'as', 'from', 'be']);
  }

  // NOVO: Função para gerar o gráfico de frequência de palavras.
  function generateWordFrequencyChart() {
    const allTitles = [];
    Object.keys(rssFeeds).forEach(feedKey => {
        if (rssFeeds[feedKey].scope === currentNewsScope) {
            const cacheKey = `${CACHE_KEY_PREFIX}${rssFeeds[feedKey].elementId}`;
            const cachedEntry = localStorage.getItem(cacheKey);
            if (cachedEntry) {
                try {
                    const { items } = JSON.parse(cachedEntry);
                    if (items && items.length > 0) {
                        items.forEach(item => allTitles.push(item.title));
                    }
                } catch(e) { /* ignora */ }
            }
        }
    });

    const chartContainer = document.getElementById('chart-container');
    if (allTitles.length === 0) {
        chartContainer.style.display = 'none';
        return;
    }

    const stopWords = getStopWords();
    const wordCounts = {};
    
    allTitles.forEach(title => {
        // Limpa e divide o título em palavras
        const words = title.toLowerCase().replace(/[^a-z0-9áéíóúâêîôûãõçü\s-]/g, '').split(/\s+/);
        words.forEach(word => {
            if (word.length > 3 && !stopWords.has(word) && isNaN(word)) { // Ignora números e palavras curtas
                wordCounts[word] = (wordCounts[word] || 0) + 1;
            }
        });
    });

    const sortedWords = Object.entries(wordCounts).sort(([,a],[,b]) => b - a).slice(0, 10);

    if (sortedWords.length < 3) { // Não mostra o gráfico se houver poucos dados
        chartContainer.style.display = 'none';
        return;
    } else {
        chartContainer.style.display = 'block';
    }

    const ctx = document.getElementById('word-frequency-chart').getContext('2d');
    
    if (wordFrequencyChart) {
        wordFrequencyChart.destroy(); // Destrói o gráfico anterior para evitar conflitos
    }
    
    const isLight = document.body.classList.contains('light-mode');
    const gridColor = isLight ? 'rgba(0, 0, 0, 0.1)' : 'rgba(255, 255, 255, 0.1)';
    const textColor = isLight ? '#333' : '#c9d1d9';

    wordFrequencyChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: sortedWords.map(item => item[0]),
            datasets: [{
                label: 'Ocorrências',
                data: sortedWords.map(item => item[1]),
                backgroundColor: 'rgba(0, 209, 128, 0.7)',
                borderColor: 'rgba(0, 209, 128, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            indexAxis: 'y', // Gráfico de barras horizontais
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(13, 17, 23, 0.8)'
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: { color: textColor, stepSize: 1 },
                    grid: { color: gridColor }
                },
                y: {
                    ticks: { color: textColor },
                    grid: { color: 'transparent' }
                }
            }
        }
    });
  }


  function generateAndShowBriefing() {
    const briefingList = document.getElementById('briefing-list');
    const briefingTitle = document.getElementById('briefing-title');
    const modal = document.getElementById('briefing-modal');

    if (!briefingList || !briefingTitle || !modal) return;
    
    elementThatOpenedModal = document.activeElement;

    briefingList.innerHTML = '';
    const scopeTitle = currentNewsScope === 'local' ? 'Local' : 'Internacional';
    briefingTitle.textContent = `Briefing de Notícias: ${scopeTitle}`;
    let hasContent = false;

    Object.keys(rssFeeds).forEach(feedKey => {
        const feedConfig = rssFeeds[feedKey];
        if (feedConfig.scope === currentNewsScope) {
            const cachedEntry = localStorage.getItem(`${CACHE_KEY_PREFIX}${feedConfig.elementId}`);
            if (cachedEntry) {
                try {
                    const { items } = JSON.parse(cachedEntry);
                    if (items && items.length > 0) {
                        hasContent = true;
                        const sourceTitle = document.createElement('h3');
                        sourceTitle.className = 'briefing-source-title';
                        sourceTitle.textContent = feedConfig.displayName;
                        briefingList.appendChild(sourceTitle);

                        items.slice(0, 6).forEach(item => {
                            const li = document.createElement('li');
                            li.innerHTML = `<a href="${item.link}" target="_blank" rel="noopener noreferrer">${item.title}</a>
                                          <p class="briefing-item-description">${item.description}</p>
                                          ${item.pubDate ? `<span class="briefing-item-date">${new Date(item.pubDate).toLocaleString('pt-BR', {day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'})}</span>` : ''}`;
                            briefingList.appendChild(li);
                        });
                    }
                } catch(e) { console.warn(`Cache error for ${feedConfig.displayName}`, e); }
            }
        }
    });

    if (!hasContent) {
        briefingList.innerHTML = '<li>Nenhuma notícia carregada para gerar o briefing.</li>';
    }
    
    // MUDANÇA: Gera o gráfico de frequência ao abrir o briefing
    generateWordFrequencyChart();
    
    modal.classList.add('visible');
    announceToScreenReader("Briefing de notícias aberto.");
    setupFocusTrap(modal);
  }

  function closeBriefingModal() {
    const modal = document.getElementById('briefing-modal');
    if (modal) {
        modal.classList.remove('visible');
        removeFocusTrap(modal);
    }
  }
  
  function handleSearch() {
    const searchBar = document.getElementById('search-bar');
    if (!searchBar) return;
    const searchTerm = searchBar.value.toLowerCase().trim();
    document.querySelectorAll('.no-search-results').forEach(el => el.remove());

    document.querySelectorAll('.news-list').forEach(list => {
        let hasVisibleItems = false;
        const listItems = list.querySelectorAll('li');
        listItems.forEach(li => {
            if (li.querySelector('.skeleton') || li.querySelector('.retry-btn') || li.querySelector('.fa-exclamation-circle')) {
                li.style.display = 'flex';
                return;
            }
            const title = li.textContent.toLowerCase();
            if (title.includes(searchTerm)) {
                li.style.display = 'flex';
                hasVisibleItems = true;
            } else {
                li.style.display = 'none';
            }
        });
        if (!hasVisibleItems && searchTerm !== '' && listItems.length > 0 && !list.querySelector('.retry-btn')) {
            const noResultsLi = document.createElement('li');
            noResultsLi.className = 'no-search-results';
            noResultsLi.textContent = "Nenhum resultado encontrado.";
            list.appendChild(noResultsLi);
        }
    });
  }

  // NOVO: Função para configurar as notificações
  function setupNotifications() {
      const notificationsBtn = document.getElementById('notifications-btn');
      if (!notificationsBtn) return;
      
      if (!('Notification' in window)) {
          notificationsBtn.style.display = 'none'; // Esconde o botão se a API não for suportada
          return;
      }
      
      const updateButtonState = () => {
          if (Notification.permission === 'granted') {
              notificationsBtn.style.color = 'var(--primary-color)';
              notificationsBtn.title = 'Notificações ativadas';
          } else if (Notification.permission === 'denied') {
              notificationsBtn.style.opacity = '0.5';
              notificationsBtn.style.cursor = 'not-allowed';
              notificationsBtn.title = 'Notificações bloqueadas';
          } else {
              notificationsBtn.style.color = '';
              notificationsBtn.title = 'Ativar notificações';
          }
      };

      notificationsBtn.addEventListener('click', () => {
          if (Notification.permission === 'granted' || Notification.permission === 'denied') {
              announceToScreenReader('O estado das notificações só pode ser alterado nas configurações do navegador.');
              return;
          }
          Notification.requestPermission().then(permission => {
              if (permission === 'granted') {
                  announceToScreenReader('Notificações ativadas.');
                  showDesktopNotification('Terminal de Notícias', { body: 'Você receberá alertas de notícias importantes!' });
              } else {
                  announceToScreenReader('Permissão para notificações não concedida.');
              }
              updateButtonState();
          });
      });
      
      updateButtonState();
  }

  document.addEventListener('DOMContentLoaded', () => {
    const savedTheme = localStorage.getItem('themePreference');
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    let isLightMode = (savedTheme === 'light') || (!savedTheme && !prefersDark);
    if (isLightMode) document.body.classList.add('light-mode');
    else document.body.classList.remove('light-mode');
    const themeIcon = document.querySelector('#theme-toggle i');
    if(themeIcon){ themeIcon.classList.toggle('fa-moon', !isLightMode); themeIcon.classList.toggle('fa-sun', isLightMode); }

    initializeScopeToggle();
    
    // MUDANÇA (JS): Inicializa a funcionalidade de notificação
    setupNotifications(); 

    document.getElementById('refresh-btn')?.addEventListener('click', () => refreshAllFeeds(true));
    document.getElementById('home-btn')?.addEventListener('click', () => window.location.href = 'index.html');
    document.getElementById('theme-toggle')?.addEventListener('click', toggleTheme);
    document.getElementById('briefing-btn')?.addEventListener('click', generateAndShowBriefing);
    document.getElementById('briefing-modal-close-btn')?.addEventListener('click', closeBriefingModal);
    document.getElementById('briefing-modal')?.addEventListener('click', function(event) { if (event.target === this) closeBriefingModal(); });
    document.getElementById('search-bar')?.addEventListener('input', handleSearch);

    setupBackToTop();
    updateFooterYear();

    document.querySelectorAll('.refresh-widget').forEach(button => {
        button.addEventListener('click', function() { loadNews(this.dataset.feedkey, true); });
    });

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && document.getElementById('briefing-modal').classList.contains('visible')) {
            closeBriefingModal();
        }
    });
  });

  setInterval(() => {
      console.log("Atualização periódica de feeds para o escopo: " + currentNewsScope);
      refreshAllFeeds(false)
    }, 5 * 60 * 1000);
</script>

</body>
</html>
